// # Recline Backbone Models
this.recline=this.recline||{},this.recline.Model=this.recline.Model||{},this.recline.Model.FilteredDataset=this.recline.Model.FilteredDataset||{},function(e,t){t.FilteredDataset=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var e=this;this.records=new t.RecordList,this.fields=this.attributes.dataset.fields,this.attributes.deriver=this.attributes.dataset.deriver,this.recordCount=null,this.queryState=new t.Query,this.get("initialState")&&this.get("initialState").setState(this),this.attributes.dataset.fields.bind("reset",function(){e.fieldsReset()}),this.attributes.dataset.bind("query:done",function(){e.query()}),this.queryState.bind("change",function(){e.query()})},fieldsReset:function(){this.fields=this.attributes.dataset.fields},query:function(e){var n=this;this.trigger("query:start"),e&&this.queryState.set(e,{silent:!0});var e=this.queryState.toJSON();_.each(n.attributes.customFilterLogic,function(t){t(e)});var r=n.attributes.dataset,i=e.size||r.recordCount,s=e.from||0,o=recline.Data.Filters.applyFiltersOnData(e.filters,r.toFullJSON(),r.fields.toJSON());_.each(e.sort,function(e){var t=e.field;o=_.sortBy(o,function(e){var n=e[t];return n}),e.order=="desc"&&o.reverse()}),o=o.slice(s,s+i),n.recordCount=o.length;var u=_.map(o,function(e){var i=new t.Record(e);return i.fields=r.fields,i.bind("change",function(e){n._changes.updates.push(e.toJSON())}),i.bind("destroy",function(e){n._changes.deletes.push(e.toJSON())}),i});n.records.reset(u),n.trigger("query:done")},getRecords:function(){return this.records.models},getFields:function(e){return this.attributes.dataset.fields},toTemplateJSON:function(){var e=this.records.toJSON();return e.recordCount=this.recordCount,e.fields=this.fields.toJSON(),e},getFieldsSummary:function(){return this.attributes.dataset.getFieldsSummary()},addCustomFilterLogic:function(e){this.attributes.customFilterLogic?this.attributes.customFilterLogic.push(e):this.attributes.customFilterLogic=[e]},setColorSchema:function(){var e=this;_.each(e.attributes.colorSchema,function(t){var n=_.find(e.fields.models,function(e){return t.field===e.id});n!=null&&(n.attributes.colorSchema=t.schema)})},toFullJSON:function(e){var t=this;return _.map(t.records.models,function(e){var n={};return _.each(t.fields.models,function(t){n[t.id]=e.getFieldValueUnrendered(t)}),n})}})}(jQuery,this.recline.Model),this.recline=this.recline||{},this.recline.Model=this.recline.Model||{},this.recline.Model.JoinedDataset=this.recline.Model.JoinedDataset||{},function(e,t){t.JoinedDataset=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var e=this;_.bindAll(this,"generatefields"),e.ds_fetched=[],e.field_fetched=[],e.joinedModel=new t.Dataset({backend:"Memory",records:[],fields:[],renderer:e.attributes.renderer}),e.fields=e.joinedModel.fields,e.records=e.joinedModel.records,e.facets=e.joinedModel.facets,e.recordCount=e.joinedModel.recordCount,e.queryState=e.joinedModel.queryState,this.get("initialState")&&this.get("initialState").setState(this),this.attributes.model.fields.bind("reset",function(){e.field_fetched.push("model"),e.allDsFetched(e.field_fetched)&&e.generatefields()}),_.each(this.attributes.join,function(t){t.model.fields.bind("reset",function(){if(!t.id)throw"joinedmodel: a model without id has been used in join. Unable to apply joined model";e.field_fetched.push(t.model.id),e.allDsFetched(e.field_fetched)&&e.generatefields()})}),this.attributes.model.bind("query:done",function(){e.ds_fetched.push("model"),e.allDsFetched(e.ds_fetched)&&e.query()}),_.each(this.attributes.join,function(t){t.model.bind("query:done",function(){if(!t.id)throw"joinedmodel: a model without id has been used in join. Unable to apply joined model";e.ds_fetched.push(t.id),e.allDsFetched(e.ds_fetched)&&e.query()}),t.model.queryState.bind("change",function(){e.allDsFetched(e.ds_fetched)&&e.query()})})},allDsFetched:function(e){var t=this,n=!0;return _.contains(e,"model")?(_.each(t.attributes.join,function(t){_.contains(e,t.id)||(n=!1)}),n):!1},generatefields:function(){var e=this,t=[];_.each(this.attributes.model.fields.models,function(e){var n=e.toJSON();n.id=n.id,t.push(n)}),_.each(this.attributes.join,function(e){_.each(e.model.fields.models,function(n){var r=n.toJSON();r.id=e.id+"_"+r.id,t.push(r)})}),this.joinedModel.resetFields(t)},query:function(e){var t=this;t.trigger("query:start"),e&&this.queryState.set(e,{silent:!0});var n=t.join();t.joinedModel.resetRecords(n),t.fields.models.length==0&&t.generatefields(),t.joinedModel.fetch(),t.recordCount=t.joinedModel.recordCount,t.trigger("query:done")},join:function(){var e=this.attributes.joinType,t=this.attributes.model,n=this.attributes.join,r=[];return _.each(t.getRecords(),function(t){var i=[],s=!0,o={};_.each(t.fields.models,function(e){o[e.id]=t.getFieldValueUnrendered(e)}),_.each(n,function(e){_.each(e.joinon,function(n){var r=e.model.fields.get(n);if(!r)throw"joinedmodel.js: unable to find field ["+n+"] on secondary model";i.push({field:r.id,type:"term",term:t.getFieldValueUnrendered(r),fieldType:r.attributes.type})});var n=recline.Data.Filters.applyFiltersOnData(i,e.model.toFullJSON(),e.model.fields.toJSON());n.length==0&&(s=!1),_.each(n,function(t){_.each(t,function(t,n){o[e.id+"_"+n]=t})})}),(e=="left"||s)&&r.push(o)}),r},addCustomFilterLogic:function(e){return this.joinedModel.addCustomFilterLogic(e)},getRecords:function(e){return this.joinedModel.getRecords(e)},getFields:function(e){return this.joinedModel.getFields(e)},toTemplateJSON:function(){return this.joinedModel.toTemplateJSON()},getFacetByFieldId:function(e){return this.joinedModel.getFacetByFieldId(e)},isFieldPartitioned:function(e){return!1},toFullJSON:function(e){return this.joinedModel.toFullJSON(e)},setColorSchema:function(){return this.attributes.colorSchema&&(this.joinedModel.attributes.colorSchema=this.attributes.colorSchema),this.joinedModel.setColorSchema()},addStaticColorSchema:function(e,t){var n=this;n.attributes.colorSchema||(n.attributes.colorSchema=[]),n.attributes.colorSchema.push({schema:e,field:t}),this.joinedModel.attributes.colorSchema=this.attributes.colorSchema,n.setColorSchema(),n.fields.bind("reset",function(){n.setColorSchema()}),n.fields.bind("add",function(){n.setColorSchema()})}})}(jQuery,this.recline.Model),recline.Model.Query.prototype=$.extend(recline.Model.Query.prototype,{defaults:function(){return{size:5e5,from:0,q:"",facets:{},filters:[]}}}),function(e){recline.Model.Dataset.prototype=e.extend(recline.Model.Dataset.prototype,{setColorSchema:function(){var e=this;_.each(e.attributes.colorSchema,function(t){var n=_.find(e.fields.models,function(e){return t.field===e.id});n!=null&&(n.attributes.colorSchema=t.schema)})},addStaticColorSchema:function(e,t){var n=this;n.attributes.colorSchema||(n.attributes.colorSchema=[]),n.attributes.colorSchema.push({schema:e,field:t}),n.fields.length>0&&n.setColorSchema(),n.fields.bind("reset",function(){n.setColorSchema()}),n.fields.bind("add",function(){n.setColorSchema()}),n.fields.bind("change",function(){n.setColorSchema()})},_handleQueryResult:function(){var e=recline.Model.Dataset.prototype._handleQueryResult;return function(t){var n=this;e.call(this,t),t.facets&&_.each(t.facets,function(e,t){recline.Data.ColorSchema.addColorsToTerms(e.id,e.terms,n.attributes.colorSchema)})}}()}),recline.Model.Record.prototype=e.extend(recline.Model.Record.prototype,{getFieldColor:function(e){return e.attributes.colorSchema?e.attributes.is_partitioned?e.attributes.colorSchema.getTwoDimensionalColor(e.attributes.partitionValue,this.getFieldValueUnrendered(e)):e.attributes.colorSchema.getColorFor(this.getFieldValueUnrendered(e)):null}}),recline.Model.Field.prototype=e.extend(recline.Model.Field.prototype,{getColorForPartition:function(){return this.attributes.colorSchema?this.attributes.is_partitioned?this.attributes.colorSchema.getColorFor(this.attributes.partitionValue):this.attributes.colorSchema.getColorFor(this.attributes.id):null}})}(jQuery),function(e){recline.Model.Dataset.prototype=e.extend(recline.Model.Dataset.prototype,{addCustomFilterLogic:function(e){this.attributes.customFilterLogic?this.attributes.customFilterLogic.push(e):this.attributes.customFilterLogic=[e]}})}(jQuery),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{initialize:function(){var e=recline.Model.Dataset.prototype.initialize;return function(){e.call(this),_.bindAll(this,"applyRendererToFields"),this.fields.bind("reset",this.applyRendererToFields)}}(),applyRendererToFields:function(){var e=this;e.attributes.renderer&&_.each(e.fields.models,function(t){t.renderer=e.attributes.renderer})}}),function(e){recline.Model.Dataset.prototype=e.extend(recline.Model.Dataset.prototype,{getFacetByFieldId:function(e){return _.find(this.facets.models,function(t){return t.id==e})}})}(jQuery),recline.Model.Query.prototype=$.extend(recline.Model.Query.prototype,{addFacetNoEvent:function(e){var t=this.get("facets");if(_.contains(_.keys(t),e))return;t[e]={terms:{field:e}},this.set({facets:t},{silent:!0})}}),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{toFullJSON:function(e){var t=this;return _.map(t.getRecords(e),function(n){var r={};return _.each(t.getFields(e).models,function(e){r[e.id]=n.getFieldValueUnrendered(e)}),r})},resetRecords:function(e){this.set({records:e},{silent:!0})},resetFields:function(e){this.set({fields:e},{silent:!0})},getRecords:function(e){var t=this;if(e==="filtered"||e==null)return t.records.models;if(t._store.data==null)throw"Model: unable to retrieve not filtered data, store can't provide data. Use a backend that use a memory store";t.queryState.get("sort")&&t.queryState.get("sort").length>0&&_.each(t.queryState.get("sort"),function(e){var n=e.field;t._store.data=_.sortBy(t._store.data,function(e){var t=e[n];return t}),e.order=="desc"&&typeof e.alreadySorted=="undefined"&&(t._store.data.reverse(),e.alreadySorted=!0)});var n=_.map(t._store.data,function(e){var n=new recline.Model.Record(e);return n.fields=t.fields,n});return t.queryState.getSelections().length>0&&recline.Data.Filters.applySelectionsOnRecord(t.queryState.get("selections"),n,t.fields),n},getFields:function(e){var t=this;return t.fields},_normalizeRecordsAndFields:function(){var e=recline.Model.Dataset.prototype._normalizeRecordsAndFields;return function(t,n){var r=this,i=e.call(this,t,n);return r.backend.__type__=="csv"&&recline.Backend.CSV.setFieldsAttributesCSV(i.fields,r,i.records),recline.Data.FieldsUtility.setFieldsAttributes(i.fields,r),i}}(),_handleQueryResult:function(e){var t=recline.Model.Dataset.prototype._handleQueryResult;return function(e){var n=this;if(e.fields&&n.fields.length==0){recline.Data.FieldsUtility.setFieldsAttributes(e.fields,n);var r;n.attributes.renderer&&(r={renderer:n.attributes.renderer}),n.fields.reset(e.fields,r)}return t.call(this,e)}}()}),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{query:function(e){var t=recline.Model.Dataset.prototype.query;return function(e){var n=this;e&&this.queryState.set(e,{silent:!0});var r=this.queryState.toJSON(),i=!1;return _.each(n.attributes.customFilterLogic,function(e){e(r),i=!0}),e||i?t.call(this,r):t.call(this,e)}}()}),recline.Model.Query.prototype=$.extend(recline.Model.Query.prototype,{removeFilterByFieldNoEvent:function(e){var t=this.get("filters");for(var n in t)t[n].field===e&&(t.splice(n,1),this.set({filters:t},{silent:!0}))},getFilterByFieldName:function(e){var t=_.find(this.get("filters"),function(t){return t.field==e});return t==-1?null:t},setFilter:function(e){if(e.remove)this.removeFilterByFieldNoEvent(e.field),delete e.remove;else{var t=this.get("filters"),n=!1;for(var r=0;r<t.length;r++)t[r].field==e.field&&(t[r]=e,n=!0);n||t.push(e)}},removeFilterByField:function(e){var t=this.get("filters");for(var n in t)t[n].field==e&&this.removeFilter(n)},clearFilter:function(e){var t=this.get("filters");for(var n in t)if(t[n].field==e){t[n].term=null,t[n].start=null,t[n].stop=null;break}},addSortCondition:function(e,t){var n=this.get("sort");n?n.push({field:e,order:t}):n=[{field:e,order:t}],this.attributes.sort=n,this.trigger("change:filters:sort")},setSortCondition:function(e){var t=this.get("sort");t?t.push(e):t=[e],this.attributes.sort=t},clearSortCondition:function(){this.attributes.sort=null}}),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{selection:function(e){var t=this;this.trigger("selection:start"),e&&t.queryState.set(e,{silent:!0});var n=t.queryState;recline.Data.Filters.applySelectionsOnRecord(t.queryState.getSelections(),t.records.models,t.fields),t.queryState.trigger("selection:done")},initialize:function(){var e=recline.Model.Dataset.prototype.initialize;return function(){e.call(this),_.bindAll(this,"selection"),_.bindAll(this,"applySelectionOnRecords"),this.queryState.bind("selection:change",this.selection),this.records.bind("reset",this.applySelectionOnRecords)}}(),applySelectionOnRecords:function(){var e=this;this.queryState&&this.queryState.getSelections().lenght>0&&recline.Data.Filters.applySelectionsOnRecord(e.queryState.getSelections(),e.records.models,e.fields)}}),recline.Model.Record.prototype=$.extend(recline.Model.Record.prototype,{isRecordSelected:function(){var e=this;return e.is_selected},setRecordSelection:function(e){var t=this;t.is_selected=e}}),recline.Model.Query.prototype=$.extend(recline.Model.Query.prototype,{getSelections:function(){var e=this.get("selections");return e?e:(this.set({selections:[]},{silent:!0}),this.get("selections"))},getSelectionByFieldName:function(e){var t=_.find(this.get("selections"),function(t){return t.field==e});return t==-1?null:t},addSelection:function(e){var t=JSON.parse(JSON.stringify(e));_.keys(e).length<=3&&(t=_.extend(this._selectionTemplates[e.type],t));var n=this.getSelections();n.push(t),this.trigger("selection:change")},removeSelection:function(e){var t=this.getSelections();t.splice(e,1),this.set({selections:t},{silent:!0}),this.trigger("selection:change")},removeSelectionByField:function(e){var t=this.getSelections();for(var n in t)t[n].field==e&&this.removeSelection(n)},setSelection:function(e){if(e.remove)this.removeSelectionByField(e.field),delete e.remove;else{var t=this.getSelections(),n=!1;for(var r=0;r<t.length;r++)t[r].field==e.field&&(t[r]=e,n=!0);n||t.push(e)}this.trigger("selection:change")},isSelected:function(){return this.getSelections().length>0}}),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{setShapeSchema:function(){var e=this;_.each(e.attributes.shapeSchema,function(t){var n=_.find(e.fields.models,function(e){return t.field===e.id});n!=null&&(n.attributes.shapeSchema=t.schema)})},_handleQueryResult:function(){var e=recline.Model.Dataset.prototype._handleQueryResult;return function(t){var n=this;if(t.facets)return _.each(t.facets,function(e,t){recline.Data.ShapeSchema.addShapesToTerms(e.id,e.terms,n.attributes.shapeSchema)}),e.call(this,t)}}()}),recline.Model.Record.prototype=$.extend(recline.Model.Record.prototype,{getFieldShapeName:function(e){return e.attributes.shapeSchema?e.attributes.is_partitioned?e.attributes.shapeSchema.getShapeNameFor(e.attributes.partitionValue):e.attributes.shapeSchema.getShapeNameFor(this.getFieldValueUnrendered(e)):null},getFieldShape:function(e,t,n){if(!e.attributes.shapeSchema)return recline.Template.Shapes.empty(null,n,t);var r,i=this.getFieldColor(e);return e.attributes.is_partitioned?r=e.attributes.partitionValue:r=this.getFieldValueUnrendered(e),e.attributes.shapeSchema.getShapeFor(r,i,t,n)}}),recline.Model.Dataset.prototype=$.extend(recline.Model.Dataset.prototype,{initialize:function(){var e=recline.Model.Dataset.prototype.initialize;return function(){e.call(this),this.get("initialState")&&this.get("initialState").setState(this)}}()}),this.recline=this.recline||{},this.recline.Model=this.recline.Model||{},this.recline.Model.SocketDataset=this.recline.Model.SocketDataset||{},function(e,t){t.SocketDataset=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var e=this;this.records=new t.RecordList,this.fields=new t.FieldList,e.fields.reset(this.get("fields")),this.recordCount=0,this.queryState=new t.Query},attach:function(){var e=this;this.trigger("attach:start");var t=e.queryState.toJSON();e.socket=io.connect(e.attributes.url,{"force new connection":!0,port:e.attributes.port,resource:e.attributes.resource});var n=e.socket;n.on("connect",function(t){n.emit("subscribe",e.attributes.subscribeData)}),n.on(e.attributes.queue,function(t){e.records.add(t,{at:0}),e.recordCount=e.records.length;while(e.recordCount>e.attributes.queueSize){var n=e.records.at(e.recordCount-1);e.records.remove(n),n.destroy(),e.recordCount=e.records.length}}),e.trigger("attach:done")},deattach:function(){this.socket.disconnect()},getRecords:function(){return this.records.models},getFields:function(e){return this.fields},toTemplateJSON:function(){var e=this.records.toJSON();return e.recordCount=this.recordCount,e.fields=this.fields.toJSON(),e},getFieldsSummary:function(){return this.attributes.dataset.getFieldsSummary()},addCustomFilterLogic:function(e){this.attributes.customFilterLogic?this.attributes.customFilterLogic.push(e):this.attributes.customFilterLogic=[e]},setColorSchema:function(){var e=this;_.each(e.attributes.colorSchema,function(t){var n=_.find(e.fields.models,function(e){return t.field===e.id});n!=null&&(n.attributes.colorSchema=t.schema)})},toFullJSON:function(e){var t=this;return _.map(t.records.models,function(e){var n={};return _.each(t.fields.models,function(t){n[t.id]=e.getFieldValueUnrendered(t)}),n})}})}(jQuery,this.recline.Model),this.recline=this.recline||{},this.recline.Model=this.recline.Model||{},this.recline.Model.UnionDataset=this.recline.Model.UnionDataset||{},function(e,t){t.UnionDataset=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var e=this;_.bindAll(this,"generateFields"),e.ds_fetched=[],e.unionModel=new t.Dataset({backend:"Memory",records:[],fields:[],renderer:e.attributes.renderer}),e.fields=e.unionModel.fields,e.records=e.unionModel.records,e.facets=e.unionModel.facets,e.recordCount=e.unionModel.recordCount,e.queryState=e.unionModel.queryState,this.get("initialState")&&this.get("initialState").setState(this),this.attributes.model.fields.bind("reset",this.generateFields),this.attributes.model.fields.bind("add",this.generateFields),_.each(this.attributes.union,function(t){t.model.fields.bind("reset",e.generateFields),t.model.fields.bind("add",e.generateFields)}),e.attributes.model.recordCount>0&&e.ds_fetched.push("model"),this.attributes.model.bind("query:done",function(){e.ds_fetched.push("model"),e.allDsFetched()&&e.query()}),_.each(this.attributes.union,function(t){t.model.bind("query:done",function(){e.ds_fetched.push(t.id),e.allDsFetched()&&e.query()}),t.model.recordCount>0&&e.ds_fetched.push(t.id),t.model.queryState.bind("change",function(){e.allDsFetched()&&e.query()})}),e.allDsFetched()&&(e.generateFields(),e.query())},allDsFetched:function(){var e=this,t=!0;return _.contains(e.ds_fetched,"model")?(_.each(e.attributes.union,function(n){_.contains(e.ds_fetched,n.id)||(t=!1)}),t):!1},generateFields:function(){var e=this,t=[],n=[];_.each(this.attributes.model.fields.models,function(e){t.push(e.toJSON())}),_.each(this.attributes.union,function(e){_.each(e.model.fields.models,function(e){_.find(t,function(t){return t.id==e.id})||t.push(e.toJSON())})}),this.unionModel.resetFields(t)},query:function(e){var t=this;t.trigger("query:start"),e&&this.queryState.set(e,{silent:!0});var n=t.union();t.unionModel.resetRecords(n),t.unionModel.fetch(),t.recordCount=t.unionModel.recordCount,t.trigger("query:done")},union:function(){var e=this.attributes.model,t=this.attributes.union,n=[];return _.each(e.records.toJSON(),function(e){n.push(e)}),_.each(t,function(e){_.each(e.model.records.toJSON(),function(e){n.push(e)})}),n},addCustomFilterLogic:function(e){return this.unionModel.addCustomFilterLogic(e)},getRecords:function(e){return this.unionModel.getRecords(e)},getFields:function(e){return this.unionModel.getFields(e)},toTemplateJSON:function(){return this.unionModel.toTemplateJSON()},getFacetByFieldId:function(e){return this.unionModel.getFacetByFieldId(e)},isFieldPartitioned:function(e){return!1},toFullJSON:function(e){return this.unionModel.toFullJSON(e)},setColorSchema:function(){return this.attributes.colorSchema&&(this.unionModel.attributes.colorSchema=this.attributes.colorSchema),this.unionModel.setColorSchema()}})}(jQuery,this.recline.Model),this.recline=this.recline||{},this.recline.Model=this.recline.Model||{},this.recline.Model.VirtualDataset=this.recline.Model.VirtualDataset||{},function(e,t){t.VirtualDataset=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){_.bindAll(this,"query","toFullJSON");var e=this;e.vModel=new t.Dataset({backend:"Memory",records:[],fields:[],renderer:e.attributes.renderer}),e.fields=e.vModel.fields,e.records=e.vModel.records,e.facets=e.vModel.facets,e.recordCount=e.vModel.recordCount,e.queryState=e.vModel.queryState,this.get("initialState")&&this.get("initialState").setState(this),this.attributes.dataset.bind("query:done",function(){e.initializeCrossfilter()}),this.queryState.bind("change",function(){e.query()}),this.queryState.bind("selection:change",function(){e.selection()}),this.attributes.dataset.records.models.length>0&&e.initializeCrossfilter()},getRecords:function(e){var t=this;return e==="totals"?(t.needsTableCalculation&&t.totals==null&&t.rebuildTotals(),t.totals.records.models):e==="totals_unfiltered"?(t.totals_unfiltered==null&&t.rebuildUnfilteredTotals(),t.totals_unfiltered.records.models):(t.needsTableCalculation&&t.totals==null&&t.rebuildTotals(),t.vModel.getRecords(e))},getField_byAggregationFunction:function(e,t,n){var r=this.getFields(e);return r.get(t+"_"+n)},getFields:function(e){var t=this;return e==="totals"?(t.totals==null&&t.rebuildTotals(),t.totals.fields):e==="totals_unfiltered"?(t.totals==null&&t.rebuildUnfilteredTotals(),t.totals_unfiltered.fields):t.vModel.getFields(e)},fetch:function(){this.initializeCrossfilter()},initializeCrossfilter:function(){var e=this.attributes.aggregation.measures,t=this.attributes.aggregation.aggregationFunctions,n=this.attributes.dataset.fields,r=this.attributes.aggregation.dimensions,i=this.attributes.aggregation.partitions,s=crossfilter(this.attributes.dataset.toFullJSON()),o=this.createDimensions(s,r),u=this.reduce(o,r,e,t,i);this.updateStore(u,n,r,t,e,i),this.trigger("query:done")},setDimensions:function(e){this.attributes.aggregation.dimensions=e,this.trigger("dimensions:change")},setMeasures:function(e){this.attributes.aggregation.measures=e,this.trigger("measures:change")},setTotalsMeasures:function(e){this.attributes.totals.measures=e,this.trigger("totals:change")},getDimensions:function(){return this.attributes.aggregation.dimensions},createDimensions:function(e,t){var n;if(t==null)n=e.groupAll();else{var r=e.dimension(function(e){var n="";for(i=0;i<t.length;i++)i>0&&(n+="#"),e[t[i]]?n+=e[t[i]].valueOf():n+="NULL";return n});n=r.group()}return n},reduce:function(e,t,n,r,s){function a(e,t){e.count=e.count+1;for(i=0;i<n.length;i++){for(j=0;j<r.length;j++){var a=this.recline.Data.Aggregations.aggregationFunctions[r[j]];e[r[j]][n[i]]=a(e[r[j]][n[i]],t[n[i]])}if(o)for(x=0;x<s.length;x++){var f=s[x],l=t[s[x]],c=n[i],h=c+"_by_"+f+"_"+l;for(j=0;j<r.length;j++){u[r[j]]==null&&(u[r[j]]={});var a=this.recline.Data.Aggregations.aggregationFunctions[r[j]];e.partitions[r[j]][h]==null&&(e.partitions[r[j]][h]={value:null,partition:l,originalField:c,aggregationFunction:a},u[r[j]][h]={field:f,value:l,originalField:c,aggregationFunction:a,aggregationFunctionName:r[j],id:h+"_"+r[j]}),e.partitions[r[j]][h].value=a(e.partitions[r[j]][h].value,t[n[i]])}e.partitions.count[h]==null?e.partitions.count[h]={value:1,partition:l,originalField:c,aggregationFunction:"count"}:e.partitions.count[h].value+=1}}return e}function f(e,t){throw"crossfilter reduce remove function not implemented"}function l(){var e={count:0};for(j=0;j<r.length;j++)e[r[j]]={},this.recline.Data.Aggregations.initFunctions[r[j]](e,n,s);if(o){e.partitions={},e.partitions.count={};for(j=0;j<r.length;j++)e.partitions[r[j]]={}}return e}var o=!1,u={};if(s!=null)var o=!0;var c=e.reduce(a,f,l),h;return t==null?h=[c.value()]:h=c.all(),{reducedResult:h,partitionFields:u}},updateStore:function(e,t,n,r,i,s){var o=this,u=e.reducedResult,a=e.partitionFields;this.partitionFields=a;var f=o.buildFields(u,t,a,n,r),l=o.buildResult(u,t,a,n,r,i,s);o.vModel.resetFields(f),o.vModel.resetRecords(l),recline.Data.FieldsUtility.setFieldsAttributes(f,o),this.clearUnfilteredTotals(),o.vModel.fetch(),o.recordCount=o.vModel.recordCount},rebuildTotals:function(){this._rebuildTotals(this.records,this.fields,!0)},rebuildUnfilteredTotals:function(){this._rebuildTotals(this._store.data,this.fields,!1)},clearUnfilteredTotals:function(){this.totals_unfiltered=null,this.clearFilteredTotals()},clearFilteredTotals:function(){this.totals=null},_rebuildTotals:function(e,n,r){var i=this;if(!i.attributes.totals)return;var s=i.attributes.totals.measures,o=i.attributes.totals.aggregationFunctions,u;e.constructor==Array?u=e:u=_.map(e.models,function(e){return e.attributes});var a=crossfilter(u),f=this.createDimensions(a,null),l=this.reduce(f,null,s,o,null),c=i.buildFields(l.reducedResult,n,{},null,o),h=i.buildResult(l.reducedResult,n,{},null,o,s,null),p=recline.Data.Aggregations.checkTableCalculation(i.attributes.aggregation.aggregationFunctions,i.attributes.totals);_.each(p,function(e){var t;_.each(u,function(n){t=recline.Data.Aggregations.tableCalculations[e](i.attributes.aggregation.measures,t,n,h[0])})}),recline.Data.FieldsUtility.setFieldsAttributes(c,i);var d;i.attributes.renderer&&(d={renderer:i.attributes.renderer}),r?(this.totals==null&&(this.totals={records:new t.RecordList,fields:new t.FieldList}),this.totals.fields.reset(c,d),this.totals.records.reset(h)):(this.totals_unfiltered==null&&(this.totals_unfiltered={records:new t.RecordList,fields:new t.FieldList}),this.totals_unfiltered.fields.reset(c,d),this.totals_unfiltered.records.reset(h))},needsTableCalculation:function(){return recline.Data.Aggregations.checkTableCalculation(self.attributes.aggregation.aggregationFunctions,self.attributes.totals).length>0?!0:!1},buildResult:function(e,t,n,r,i,s,o){var u=!1;if(o!=null)var u=!0;var a;r==null?a=e:e.length>0?a=e[0].value:a={count:0};var f=[];for(var l=0;l<e.length;l++){var c,h=e[l],p;if(r!=null){var d=e[l].key.split("#");p={dimension:h.key,count:h.value.count};for(var v=0;v<d.length;v++){var m=r[v],g=t.get(m).attributes,y=g.type,b=recline.Data.FormattersMoviri[y],w=b(d[v]);p[r[v]]=w}c=h.value}else c=h,p={count:h.count};for(var v=0;v<i.length;v++){var E=[];n[i[v]]!=null&&(E=n[i[v]]),recline.Data.Aggregations.finalizeFunctions[i[v]](c,s,_.keys(E));var S;typeof c[i[v]]=="function"?S=c[i[v]]():S=c[i[v]];for(var x in S){var T;typeof S[x]=="function"?T=S[x]():T=S[x],p[x+"_"+i[v]]=T}if(u){var S;typeof c.partitions[i[v]]=="function"?S=c.partitions[i[v]]():S=c.partitions[i[v]];for(var x in S){var T;typeof c.partitions[i[v]]=="function"?T=c.partitions[i[v]]():T=c.partitions[i[v]];var N=x+"_"+i[v];p[N]=T[x].value}}}if(u)for(var x in a.partitions.count)h.value.partitions["count"][x]==null?p[x+"_count"]=0:p[x+"_count"]=h.value.partitions.count[x].value;f.push(p)}return f},buildFields:function(e,t,n,r,i){var s=this,o=[],u;r==null?e.constructor!=Array?u=e:e.length>0?u=e[0]:u={count:0}:e.length>0?u=e[0].value:u={count:0},o.push({id:"count",type:"integer"});for(var a=0;a<i.length;a++){var f;typeof u[i[a]]=="function"?f=u[i[a]]():f=u[i[a]];for(var l in f){var c=t.get(l);if(!c)throw"Virtualmodel: unable to find field ["+l+"] in model";var h=c.attributes,p=recline.Data.Aggregations.resultingDataType[i[a]](h.type),d=l+"_"+i[a];s.attributes.fieldLabelForFields&&(d=s.attributes.fieldLabelForFields.replace("{originalFieldLabel}",h.label).replace("{aggregatedFunction}",i[a])),o.push({id:l+"_"+i[a],type:p,is_partitioned:!1,colorSchema:h.colorSchema,shapeSchema:h.shapeSchema,originalField:l,aggregationFunction:i[a],label:d})}_.each(n,function(e){_.each(e,function(e){var n=t.get(e.field).attributes,r=recline.Data.Aggregations.resultingDataType[i[a]](n.type),u=e.id,f=u;s.attributes.fieldLabelForPartitions&&(f=s.attributes.fieldLabelForPartitions.replace("{originalField}",e.originalField).replace("{partitionFieldName}",e.field).replace("{partitionFieldValue}",e.value).replace("{aggregatedFunction}",i[a])),o.push({id:u,type:r,is_partitioned:!0,partitionField:e.field,partitionValue:e.value,colorSchema:n.colorSchema,shapeSchema:n.shapeSchema,originalField:e.originalField,aggregationFunction:i[a],label:f})})})}if(r!=null){o.push({id:"dimension"});for(var v=0;v<r.length;v++){var m=t.get(r[v]);if(!m)throw"VirtualModel.js: unable to find field ["+r[v]+"] in model";var h=m.attributes;o.push({id:r[v],type:h.type,label:h.label,format:h.format,colorSchema:h.colorSchema,shapeSchema:h.shapeSchema})}}return o},query:function(e){var t=this;t.trigger("query:start"),e&&this.queryState.set(e,{silent:!0}),t.clearFilteredTotals(),t.vModel.query(e),t.recordCount=t.vModel.recordCount,t.trigger("query:done")},selection:function(e){return this.vModel.selection(e)},setColorSchema:function(e){return this.attributes.colorSchema&&(this.vModel.attributes.colorSchema=this.attributes.colorSchema),this.vModel.setColorSchema(e)},setShapeSchema:function(e){return this.vModel.setShapeSchema(e)},getFacetByFieldId:function(e){return this.vModel.getFacetByFieldId(e)},toTemplateJSON:function(){return this.vModel.toTemplateJSON()},toFullJSON:function(e){var t=this;return _.map(t.getRecords(e),function(n){var r={};return _.each(t.getFields(e).models,function(e){r[e.id]=n.getFieldValueUnrendered(e)}),r})},getFieldsSummary:function(){return this.vModel.getFieldsSummary()},addStaticColorSchema:function(e,t){return this.vModel.addStaticColorSchema(e,t)},getPartitionedFields:function(e,t){var n=_.filter(this.fields.models,function(n){return n.attributes.partitionField==e&&n.attributes.originalField==t});return n==null&&(field=[]),n},isFieldPartitioned:function(e,t){var n=this.getFields(t).get(e);if(!n)throw"Virtualmodel.js: isFieldPartitioned: unable to find field ["+e+"] in virtualmodel ["+this.id+"]";return n.attributes.aggregationFunction&&this.attributes.aggregation.partitions},getPartitionedFieldsForAggregationFunction:function(e,t){var n=this,r=[];return _.each(n.partitionFields[e],function(e){e.originalField==t&&r.push(n.fields.get(e.id))}),r},addCustomFilterLogic:function(e){return this.vModel.addCustomFilterLogic(e)}})}(jQuery,this.recline.Model),this.recline=this.recline||{},function(e,t){t.ActionUtility={},t.ActionUtility.doAction=function(e,t,n){var r=_.filter(e,function(e){var n=_.find(e.event,function(e){return e==t});return n!=-1?!0:!1});_.each(r,function(e){var t=e.mapping,r=[];_.each(t,function(t){if(n[t["srcField"]]==null&&e.action.attributes.filters[t.filter].type!="list")console.log("warn: sourceField: ["+t.srcField+"] not present in event data");else{var i={filter:t.filter,value:n[t.srcField]};r.push(i)}}),r.length>0&&e.action._internalDoAction(r)})},t.ActionUtility.getActiveFilters=function(e){var t=[];return _.each(e,function(e){_.each(e.mapping,function(n){var r=e.action.getActiveFilters(n.filter,n.srcField);r!=null&&r.length>0&&(t=_.union(t,r))})}),t},t.Action=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){},doAction:function(e,t){var n=[];t.forEach(function(t){var r=[];e.forEach(function(e){r.push(e.getFieldValueUnrendered({id:t.srcField}))}),n.push({filter:t.filter,value:r})}),this._internalDoAction(n)},doActionWithFacets:function(e,t,n,r){var i=[];n.forEach(function(n){var s=[];e.forEach(function(e){e.records.forEach(function(e){var i=e[r];t.forEach(function(t){if(t==i||t&&i&&t.valueOf()==i.valueOf())_.contains(s,e[n.srcField])||s.push(e[n.srcField])})})}),i.push({filter:n.filter,value:s,origValueList:t})}),this._internalDoAction(i)},doActionWithValues:function(e,t){var n=[];t.forEach(function(t){var r=[];_.each(e,function(r){r.field===t.srcField&&n.push({filter:t.filter,value:r.value,origValueList:e})})}),this._internalDoAction(n)},doActionWithValueArray:function(e,t,n){var r=[];t.forEach(function(t){t.srcField==n&&r.push({filter:t.filter,value:e})}),this._internalDoAction
(r)},_internalDoAction:function(e){var t=this,n=this.attributes.filters,r=this.attributes.models,i=this.attributes.type,s=[];_.each(e,function(e){var r=n[e.filter];if(r==null)throw"Filter "+e.filter+" defined in actions data not configured for action ";r.name=e.filter;if(t.filters[r.type]==null)throw"Filter not implemented for type "+r.type;r.type=="range"&&e.value.length<2&&e.origValueList?s.push(t.filters[r.type](r,e.origValueList)):s.push(t.filters[r.type](r,e.value))}),_.each(i,function(e){_.each(r,function(n){var r=[];_.each(s,function(e){r.push(_.clone(e))});var i=!1;_.each(r,function(r){_.find(n.filters,function(e){return e==r.name})!=null&&(t.modelsAddFilterActions[e](n.model,r),i=!0)}),i&&t.modelsTriggerActions[e](n.model)})}),_.each(e,function(e){var t=n[e.filter];delete t.remove})},getActiveFilters:function(e,t){var n=this,r=this.attributes.models,i=this.attributes.type,s=this.attributes.filters,o=[];return _.each(i,function(i){_.each(r,function(r){var u=_.filter(r.filters,function(t){return t==e});_.each(u,function(e){var u=s[e];if(u!=null){var a=n.modelsGetFilter[i](r.model,u.field);a!=null&&(a.field=t,o.push(a))}})})}),o},modelsGetFilter:{filter:function(e,t){return e.queryState.getFilterByFieldName(t)},selection:function(e,t){throw"Action.js selection not implemented selection for selection"},sort:function(e,t){throw"Action.js sort not implemented selection for sort"}},modelsAddFilterActions:{filter:function(e,t){e.queryState.setFilter(t)},selection:function(e,t){e.queryState.setSelection(t)},sort:function(e,t){e.queryState.clearSortCondition(),e.queryState.setSortCondition(t)}},modelsTriggerActions:{filter:function(e){e.queryState.trigger("change")},selection:function(e){e.queryState.trigger("selection:change")},sort:function(e){e.queryState.trigger("change")}},filters:{term:function(e,t){if(t.length===0)e.term=null,e.remove=!0;else{if(t.length!==1)throw"Data passed for filtertype term not valid. Data lenght should be 1 or empty but is "+t.length;t[0]==null?e.remove=!0:e.term=t[0]}return e},termAdvanced:function(e,t){if(!e.operator)throw"Data passed for filtertype termAdvanced not valid. Operator clause is missing";if(t.length===0)e.term=null,e.remove=!0;else{if(t.length!==1)throw"Data passed for filtertype termAdvanced not valid. Data lenght should be 1 or empty but is "+t.length;t[0]==null?e.remove=!0:e.term=t[0]}return e},range:function(e,t){if(t.length===0)e.start=null,e.stop=null;else if(t[0]===null||t[1]===null)e.remove=!0;else{if(t.length!==2)throw"Data passed for filtertype range not valid. Data lenght should be 2 but is "+t.length;e.start=t[0],e.stop=t[1]}return e},list:function(e,t){return t===null?e.list=null:t.length===0?(e.remove=!0,e.list=[]):e.list=t,e},sort:function(e,t){if(t.length===0)e=null;else{if(t.length!=2)throw"Actions.js: invalid data length ["+t+"]";e.field=t[0],e.order=t[1]}return e}}})}(jQuery,this.recline),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},function(e){e.Aggregations={},e.Aggregations.aggregationFunctions={sum:function(e,t){return e==null&&(e=0),e+t},avg:function(e,t){},max:function(e,t){return e==null?t:Math.max(e,t)},min:function(e,t){return e==null?t:Math.min(e,t)},maxScaled:function(e,t){},minScaled:function(e,t){},ratioToReport:function(e,t){},ratioToMax:function(e,t){},runningTotal:function(e,t){}},e.Aggregations.initFunctions={sum:function(){},avg:function(){},max:function(){},min:function(){},maxScaled:function(){},minScaled:function(){},ratioToReport:function(){},ratioToMax:function(){},runningTotal:function(){}},e.Aggregations.resultingDataType={sum:function(e){return e},avg:function(e){return"float"},max:function(e){return e},min:function(e){return e},maxScaled:function(e){return e},minScaled:function(e){return e},ratioToReport:function(e){return"float"},ratioToMax:function(e){return"float"},runningTotal:function(e){return e}},e.Aggregations.finalizeFunctions={sum:function(){},avg:function(e,t,n){e.avg=function(e,t){return function(){var t={};for(var n=0;n<e.length;n++)t[e[n]]=this.sum[e[n]]/this.count;return t}}(t,n),n!=null&&n.length>0&&(e.partitions.avg=function(t,n){return function(){var t={};for(var r=0;r<n.length;r++)e.partitions.sum[n[r]]&&(t[n[r]]={value:e.partitions.sum[n[r]].value/e.partitions.count[n[r]].value,partition:e.partitions.sum[n[r]].partition});return t}}(t,n))},max:function(){},min:function(){},maxScaled:function(e,t){e.maxScaled=function(e){return function(){var t={};for(var n=0;n<e.length;n++)t[e[n]]=this.max[e[n]]*this.count;return t}}(t)},minScaled:function(e,t){e.minScaled=function(e){return function(){var t={};for(var n=0;n<e.length;n++)t[e[n]]=this.min[e[n]]*this.count;return t}}(t)},ratioToReport:function(){},ratioToMax:function(){},runningTotal:function(){}},e.Aggregations.tableCalculations={ratioToReport:function(e,t,n,r){return _.each(e,function(e){r[e+"_sum_sum"]>0&&(n[e+"_ratioToReport"]=n[e+"_sum"]/r[e+"_sum_sum"])}),n},ratioToMax:function(e,t,n,r){return _.each(e,function(e){r[e+"_sum_max"]>0&&(n[e+"_ratioToMax"]=n[e+"_sum"]/r[e+"_sum_max"])}),n},runningTotal:function(e,t,n,r){return _.each(e,function(e){t?n[e+"_runningTotal"]=n[e+"_sum"]+t[e+"_runningTotal"]:n[e+"_runningTotal"]=n[e+"_sum"]}),n}};var t=function(e,t,n){var r=n.split("."),i,s;if(r.length>0){i=e,s=t;for(var o=0;o<r.length;o++)arr=r[o].match(/(.*)\[\'?(\d*\w*)\'?\]/i),arr&&arr.length==3?(i=i[arr[1]]?i[arr[1]][arr[2]]:i[r[o]],s=s[arr[1]]?s[arr[1]][arr[2]]:s[r[o]]):(i=i[r[o]],s=s[r[o]])}return _.isEqual(i,s)};e.Aggregations.intersectionObjects=e.Aggregations.intersectObjects=function(e,n){var r=Array.prototype.slice,i=r.call(arguments,1);return _.filter(_.uniq(n),function(n){return _.every(i,function(r){return _.any(r,function(r){var i=t(r,n,e);return i&&_.extend(n,r),i})})})},e.Aggregations.checkTableCalculation=function(t,n){var r=_.intersection(t,["runningTotal","ratioToReport","ratioToMax"]);return r.length>0&&_.each(r,function(t){if(!_.intersection(n.aggregationFunctions,e.Aggregations.tableCalculationDependencies[t]))throw"Data.Aggregation: unable to calculate "+t+", totals aggregation function ["+e.Aggregations.tableCalculationDependencies[t]+"] must be defined"}),r},e.Aggregations.tableCalculationDependencies={runningTotal:[],avg:["sum"],minScaled:["min"],maxScaled:["max"],ratioToReport:["sum"],ratioToMax:["max"]}}(this.recline.Data),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},this.recline.Data.ColorSchema=this.recline.Data.ColorSchema||{},function(e,t){t.ColorSchema=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var e=this;if(this.attributes.data){var t=this.attributes.data;e._generateLimits(t)}else if(this.attributes.dataset)this.bindToDataset();else if(this.attributes.fields){var t=this.attributes.fields;this.attributes.type="scaleWithDistinctData",e._generateLimits(t)}if(this.attributes.twoDimensionalVariation)if(this.attributes.twoDimensionalVariation.data){var t=this.attributes.twoDimensionalVariation.data;e._generateVariationLimits(t)}else this.attributes.twoDimensionalVariation.dataset&&this.bindToVariationDataset()},bindToDataset:function(){var e=this;e.attributes.dataset.dataset.records.bind("reset",function(){e._generateFromDataset()}),e.attributes.dataset.dataset.fields.bind("reset",function(){e.attributes.dataset.dataset.setColorSchema(e.attributes.dataset.type)}),e.attributes.dataset.dataset.fields.bind("add",function(){e.attributes.dataset.dataset.setColorSchema(e.attributes.dataset.type)}),e.attributes.dataset.dataset.records.models.length>0&&e._generateFromDataset()},bindToVariationDataset:function(){var e=this;e.attributes.twoDimensionalVariation.dataset.dataset.records.bind("reset",function(){e._generateFromVariationDataset()}),e.attributes.twoDimensionalVariation.dataset.dataset.records.models.length>0&&e._generateFromVariationDataset()},setDataset:function(e,t,n){var r=this;e.attributes.colorSchema||(e.attributes.colorSchema=[]),r.attributes.fields?_.each(r.attributes.fields,function(t){e.attributes.colorSchema.push({schema:r,field:t})}):(r.attributes.dataset={dataset:e,field:t,type:n},e.attributes.colorSchema.push({schema:r,field:t}),r.bindToDataset()),e.setColorSchema(n)},setVariationDataset:function(e,t){var n=this;n.attributes.twoDimensionalVariation={dataset:{dataset:e,field:t}},n.bindToVariationDataset()},generateFromExternalDataset:function(e){var t=this,n=this.getRecordsArray(e);t._generateLimits(n)},_generateFromDataset:function(){var e=this,t=this.getRecordsArray(e.attributes.dataset);e._generateLimits(t)},_generateFromVariationDataset:function(){var e=this,t=this.getRecordsArray(e.attributes.twoDimensionalVariation.dataset);e._generateVariationLimits(t)},_generateLimits:function(e){var t=this;switch(this.attributes.type){case"scaleWithDataMinMax":t.schema=new chroma.ColorScale({colors:this.attributes.colors,limits:this.limits.minMax(e)});break;case"scaleWithDistinctData":t.schema=new chroma.ColorScale({colors:this.attributes.colors,limits:[0,1]}),t.limitsMapping=this.limits.distinct(e,t.oldLimitData),t.oldLimitData=e;break;case"fixedLimits":t.schema=new chroma.ColorScale({colors:this.attributes.colors,limits:this.attributes.limits});break;default:throw"data.colors.js: unknown or not defined properties type ["+this.attributes.type+"] possible values are [scaleWithDataMinMax,scaleWithDistinctData,fixedLimits]"}},getScaleType:function(){return this.attributes.type},getScaleLimits:function(){return this.schema.limits},_generateVariationLimits:function(e){var t=this;t.variationLimits=this.limits.minMax(e)},getColorFor:function(e){var t=this;if(this.schema==null&&!t.attributes.defaultColor)throw"data.colors.js: colorschema not yet initialized, datasource not fetched?";return t.limitsMapping?t.limitsMapping[e]!=null?this.schema.getColor(t.limitsMapping[e]):chroma.hex(t.attributes.defaultColor):t.schema?this.schema.getColor(e):chroma.hex(t.attributes.defaultColor)},getTwoDimensionalColor:function(e,t){if(this.schema==null)throw"data.colors.js: colorschema not yet initialized, datasource not fetched?";if(this.attributes.twoDimensionalVariation==null)return this.getColorFor(e);var n="#000000";this.attributes.twoDimensionalVariation.type=="toLight"&&(n="#ffffff");var r=this,i=new chroma.ColorScale({colors:[r.getColorFor(e),n],limits:r.variationLimits,mode:"hsl"});return i.getColor(t)},getRecordsArray:function(e){if(!e.dataset.fields.get(e.field))return;var t=[];if(e.dataset.isFieldPartitioned&&e.dataset.isFieldPartitioned(e.field)){var n=e.dataset.getPartitionedFields(e.field);_.each(e.dataset.getRecords(e.type),function(e){_.each(n,function(n){t.push(e.getFieldValueUnrendered(n))})})}else{var n=[e.field];_.each(e.dataset.getRecords(e.type),function(e){_.each(n,function(n){var r=e.fields.get(n);t.push(e.getFieldValueUnrendered(r))})})}return t},limits:{minMax:function(e){var t=[null,null];return e&&e.length==1?t=[0,e[0]]:_.each(e,function(e){t[0]==null?t[0]=e:t[0]=Math.min(t[0],e),t[1]==null?t[1]=e:t[1]=Math.max(t[1],e)}),t},distinct:function(){var e=function(e){var t=0,n,r,i;if(e.length===0)return t;for(n=0;n<e.length;n++)for(r=0;r<e[n].length;r++)i=e[n].charCodeAt(r),t=(t<<5)-t+i,t&=t;return t},t=function(){var e={},t=function(e){return e+e-1};return function(n){if(e[n])return e[n];var r=2;while(r<n)r=t(r);return e[n]=r,r}}(),n=function(e,t,n){return e/(n-1)},r={},i={},s={};return function(o,u){var a={},f={},l=[],c;o?o.sort(function(e,t){return e>t?1:t>e?-1:0}):o=[],u?u.sort(function(e,t){return e>t?1:t>e?-1:0}):u=[];var h=_.uniq(o,!0);h[0]==null&&(h=[]);var p=_.uniq(u,!0);p[0]==null&&(p=[]);var d=s[e(p)]||t(p.length),v=Math.max(t(h.length),d),m=0;v>d&&(d*2<v?p=[]:m=1),l=p.length?i[e(p)]:[];if(m==1&&p.length!==0)for(c=1;c<v;c+=2)l.push(c);if(p.length===0){c=0,_.each(h,function(e){v===1?a[e]=0:a[e]=n(c,h.length,v),f[e]=c,c++});for(c=h.length;c<v;c++)l.push(c)}else{var g,y,b=0,w=0,E=r[e(p)];c=0,g=0;while(!b&&!w)h[c]===p[g]?(c++,g++):h[c]<p[g]?c++:(l.push(E[p[g]]),g++),b=g>=p.length,w=c>=h.length;while(!b)l.push(E[p[g]]),g++,b=g>=p.length;c=0,g=0,b=0,w=0;while(!b&&!w)h[c]===p[g]?(y=E[p[g]]*Math.pow(2,m),f[h[c]]=y,a[h[c]]=n(y,h.length,v),c++,g++):h[c]<p[g]?(y=l.pop(),f[h[c]]=y,a[h[c]]=n(y,h.length,v),c++):g++,b=g>=p.length,w=c>=h.length;if(!w)for(;c<h.length;c++)y=l.pop(),f[h[c]]=y,a[h[c]]=n(y,h.length,v)}return r[e(h)]=f,i[e(h)]=l,s[e(h)]=v,a}}()}}),t.ColorSchema.addColorsToTerms=function(e,t,n){_.each(t,function(t){n&&_.each(n,function(n){n.field===e&&(t.color=n.schema.getColorFor(t.term))})})}}(jQuery,this.recline.Data),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},this.recline.Data.FieldsUtility=this.recline.Data.FieldsUtility||{},function(e,t){t.setFieldsAttributes=function(e,t,n){if(t.attributes.fieldLabels)for(var r=0;r<e.length;r++){var i=_.find(t.attributes.fieldLabels,function(t){return t.id==e[r].id});fieldsutilities,i!=null&&(e[r].label=i.label)}if(t.attributes.fieldsFormat){if(!t.attributes.fieldsFormat.length)throw"Wrong fieldsFormat parameter. Must be an array, not a single object!";_.each(t.attributes.fieldsFormat,function(t){var n=_.find(e,function(e){return t.id===e.id});n!=null&&(n.format=t.format)})}t.attributes.colorSchema&&_.each(t.attributes.colorSchema,function(t){var n=_.find(e,function(e){return t.field===e.id});n!=null&&(n.colorSchema=t.schema)}),t.attributes.shapeSchema&&_.each(t.attributes.shapeSchema,function(t){var n=_.find(e,function(e){return t.field===e.id});n!=null&&(n.shapeSchema=t.schema)})}}(jQuery,this.recline.Data.FieldsUtility),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},function(e){e.Format={},e.Formatters={},e.FormattersMoviri={integer:function(e){return isFinite(e)?parseInt(e,10):0},string:function(e){return e?e.toString():null},date:function(e){return(new Date(parseInt(e))).valueOf()},"float":function(e){return isFinite(e)?parseFloat(e,10):0},number:function(e){return isFinite(e)?parseFloat(e,10):0}},e.Format.scale=function(e){var t=function(e,t){return[0,e*t]};return function(n,r,i){var s={},o;s.axisScale={};var u=t(i,r);if(e.type==="linear"){var a=d3.max(n,function(t){var n=0;return o=0,_.each(e.domain,function(e){n=t.getFieldValue({id:e})>n?t.getFieldValue({id:e}):n,o++}),n*o});_.each(e.domain,function(t,n){var r,i=[u[0],u[1]/o];n%2==1&&e.invertEven?r=[a/o,0]:r=[0,a/o],s.axisScale[t]=d3.scale.linear().domain(r).range(i)}),s.scale=d3.scale.linear().domain([0,a]).range(u)}return s}},e.Formatters.Renderers=function(t,n,r){var i=e.Formatters.RenderersImpl[n.attributes.type];if(i==null)throw"No custom renderers defined for field type "+n.attributes.type;return i(t,n,r)},e.Formatters.RenderersConvert_ALL_=function(t,n,r){var i=function(e,t,n){var r=t.get("format");if(r==="markdown"){if(typeof Showdown!="undefined"){var i=new Showdown.converter;return out=i.makeHtml(e),out}return e}return r=="plain"?e?e.replace(/\b_ALL_\b/g,"All"):e:(e&&typeof e=="string"&&(e=e.replace(/(https?:\/\/[^ ]+)/g,'<a href="$1">$1</a>').replace(/\b_ALL_\b/g,"All")),e)},s=e.Formatters.RenderersImpl[n.attributes.type];if(s==null)throw"No custom renderers defined for field type "+n.attributes.type;return n.attributes.type=="string"&&(s=i),s(t,n,r)},e.Formatters.RenderersImpl={object:function(e,t,n){return JSON.stringify(e)},integer:function(e,t,n){var r=t.get("format");return r==="currency_euro"?accounting.formatMoney(e,{symbol:"€",format:"%v %s",decimal:".",thousand:",",precision:0}):accounting.formatNumber(e,0,",")},date:function(e,t,n){var r=t.get("format");return r==null||r=="date"?e:r==="localeTimeString"?(new Date(e)).toLocaleString():r==="timeString"?(new Date(e)).toUTCString():(new Date(e)).toUTCString()},geo_point:function(e,t,n){return JSON.stringify(e)},number:function(e,t,n){var r=t.get("format");if(r==="percentage")try{return accounting.formatNumber(e,2,",",".")+'<small class="muted">%</small>'}catch(i){return"-"}else if(r==="percentage_0to1")try{return accounting.formatNumber(e*100,2,",",".")+'<small class="muted">%</small>'}catch(i){return"-"}else if(r==="currency_euro")try{return accounting.formatMoney(e,{symbol:"",format:"%v %s",decimal:".",thousand:",",precision:0})+'<small class="muted">€</small>'}catch(i){return"-"}else if(r==="currency_euro_decimal")try{return accounting.formatMoney(e,{symbol:"",format:"%v %s",decimal:".",thousand:",",precision:2})+'<small class="muted">€</small>'}catch(i){return"-"}else{if(r==="time"){var s=parseInt(e),o=Math.floor(s/3600),u=Math.floor((s-o*3600)/60),a=s-o*3600-u*60;o<10&&(o="0"+o),u<10&&(u="0"+u),a<10&&(a="0"+a);var f=o+":"+u+":"+a;return f}if(r==="integer")try{return accounting.formatNumber(e,0,",",".")}catch(i){return"-"}}try{return accounting.formatNumber(e,2,",",".")}catch(i){return"-"}},string:function(e,t,n){var r=t.get("format");if(r==="markdown"){if(typeof Showdown!="undefined"){var i=new Showdown.converter;return out=i.makeHtml(e),out}return e}if(r=="plain")return e;if(r==="time"){var s=parseInt(e),o=Math.floor(s/3600),u=Math.floor((s-o*3600)/60),a=s-o*3600-u*60;o<10&&(o="0"+o),u<10&&(u="0"+u),a<10&&(a="0"+a);var f=o+":"+u+":"+a;return f}return e&&typeof e=="string"&&(e=e.replace(/(https?:\/\/[^ ]+)/g,'<a href="$1">$1</a>')),e}},e.Formatters.getFieldLabel=function(e,t){var n=e.attributes.label;e.attributes.is_partitioned&&(n=e.attributes.partitionValue);if(t){var r=_.find(t,function(e){return e.id==n});typeof r!="undefined"&&r!=null&&(n=r.label)}return n}}(this.recline.Data),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},this.recline.Data.SeriesUtility=this.recline.Data.SeriesUtility||{},function(e,t){t.createSeries=function(e,t,n,r,i,s,o){var u=[],a=e.fillEmptyValuesWith,f=e.requiredXValues,l="#C0C0C0";t&&(l=t);var c=!1;n.queryState.isSelected()&&(c=!0);var h="filtered";r&&(h=r);var p=n.getRecords(h),d=n.fields.get(i);if(!d)throw"data.series.utility.CreateSeries: unable to find field ["+i+"] in model ["+n.id+"]";var v=[];f&&(v=f);var m;if(e.sizeField){m=n.fields.get(e.sizeField);if(!m)throw"data.series.utility.CreateSeries: unable to find field ["+e.sizeField+"] on model"}if(e.type=="byFieldValue"){var g={},y=n.fields.get(e.seriesField),b=n.fields.get(e.valuesField);if(!b)throw"data.series.utility.CreateSeries: unable to find field ["+e.valuesField+"] in model ["+n.id+"]";if(!y)throw"data.series.utility.CreateSeries: unable to find field ["+e.seriesField+"] in model ["+n.id+"]";_.each(p,function(e,t){var n=e.getFieldValueUnrendered(y),r=e.getFieldValue(y),i;if(g[n]!=null)i=g[n];else{i={key:n,label:r,values:[],field:b};var s=e.getFieldColor(y);s!=null&&(i.color=s)}var o=e.getFieldShapeName(y),u=e.getFieldValueUnrendered(d),f=e.getFieldValue(d),l=e.getFieldValueUnrendered(b),c=e.getFieldValue(b);if(l==null||typeof l=="undefined"&&a!=null)l=a,c=l;if(l!=null&&typeof l!="undefined"&&!isNaN(l)){var h={x:u,y:l,record:e,y_formatted:c,x_formatted:f,legendField:y.attributes.label||y.attributes.id,legendValue:r};m&&(h.size=e.getFieldValueUnrendered(m)),o!=null&&(h.shape=o),i.values.push(h),a!=null&&v.push(u),g[n]=i}});for(var w in g)u.push(g[w])}else{if(e.type!="byFieldName"&&e.type!="byPartitionedField")throw"data.series.utility.CreateSeries: unsupported or not defined type "+e.type;var E;e.type=="byFieldName"?E=e.valuesField:(E=[],_.each(e.aggregationFunctions,function(t){_.each(n.getPartitionedFieldsForAggregationFunction(t,e.aggregatedField),function(e){E.push(e.get("id"))})})),_.each(E,function(e){var t;t=n.fields.get(e);if(!t)throw"data.series.utility.CreateSeries: unable to find field ["+e+"] on model";var r;e.fieldColor&&(r=e.fieldColor);var i=[];_.each(p,function(e,n){var r=e.getFieldValueUnrendered(d),s=e.getFieldValue(d);try{var o=e.getFieldValueUnrendered(t),u=e.getFieldValue(t);if(o==null||typeof o=="undefined"&&a!=null)o=a;if(o!=null&&!isNaN(o)){var f,h=e.getFieldColor(t);c?e.isRecordSelected()?f=h:f=l:f=h;var p=e.getFieldShapeName(t),g={x:r,y:o,record:e,y_formatted:u,x_formatted:s};f!=null&&(g.color=f),p!=null&&(g.shape=p),m&&(g.size=e.getFieldValueUnrendered(m)),i.push(g),a!=null&&v.push(r)}}catch(y){}});if(i.length>0){var s;r?s=r:s=t.getColorForPartition();var o={values:i,key:recline.Data.Formatters.getFieldLabel(t,n.attributes.fieldLabels)};s&&(o.color=s),u.push(o)}})}a!=null&&(v=_.unique(v),_.each(u,function(e){var t=_.unique(_.map(e.values,function(e){return e.x}));_.each(_.difference(v,t),function(t){e.values.push({x:t,y:a})})}));if(u.length>1){var S=[];_.each(u[0].values,function(e,t){S[e.x]=t+1}),_.each(u,function(e,t){t>0&&(e.values=_.sortBy(e.values,function(e){return S[e.x]||1e9}))})}if(o){var x=o.mainSeriesCount,T=o.labelForSmallSeries||"Other",N=[];_.each(u,function(e){N.push({id:N.length,key:e.key,total:_.reduce(e.values,function(e,t){return e+t.y},0)})}),N=_.sortBy(N,function(e){return-e.total});var C=[],w=0;for(w=0;w<x&&w<N.length;w++)C.push(u[N[w].id]);if(w<u.length){var k={key:T,values:[]};_.each(u[N[w].id].values,function(e){k.values.push({x:e.x,y:e.y})});var L=u[0].values.length;for(var A=w+1;A<u.length;A++)for(var O=0;O<L;O++)k.values[O].y+=u[N[A].id].values[O].y;C.push(k)}u=C}if(s&&u.length){var M=u[0].values.length,D=[];for(var O=0;O<M;O++)D.push(_.reduce(u,function(e,t){return e+t.values[O].y},0));for(var O=0;O<M;O++)_.each(u,function(e){D[O]&&(e.values[O].y_orig=e.values[O].y,e.values[O].y=Math.round(e.values[O].y_orig/D[O]*1e4)/100)})}return u},t.createSerieAnnotations=function(e,t,n,r,i,s){var o=[];if(e&&t&&n&&e.records.length){var u=e.fields.get(t);if(typeof u=="undefined"||u==null)throw"data.series.utility.CreateSerieAnnotations: field "+t+" not found in model";var a=e.fields.get(n);if(typeof a=="undefined"||a==null)throw"data.series.utility.CreateSerieAnnotations: field "+n+" not found in model";_.each(e.getRecords(),function(t){var n=[],f=t.getFieldValueUnrendered(u).valueOf();_.each(r,function(e,t){var r=_.find(e.data,function(e){return e.x==f});if(r)n.push(r);else for(var i=1;i<e.data.length;i++)if(e.data[i-1].x<f&&e.data[i].x>f){var s=d3.scale.linear().domain([e.data[i-1].x,e.data[i].x]).range([e.data[i-1].y,e.data[i].y]);n.push({y:s(f),serie:t});break}});var l=_.max(n,function(e){return e.y});if(l){var c=_.find(o,function(e){return e.x==f});if(c)c.text+="<br>"+t.getFieldValue(a);else{var h=o.length,p=String.fromCharCode(h%27+65);h>26&&(p+=Math.floor(h/27));var d=-1;s||(d=l.serie||0);var v=l.y||0;if(i){var m=e.fields.get(i),g=t.getFieldValueUnrendered(m);for(var y=0;y<r.length;y++)if(r[y].name==g){d=y;break}}if(s&&d==-1&&r.length==1&&r[0].name=="_ALL_")d=0,o.push({x:f,text:t.getFieldValue(a),letter:p,y:v,serie:d});else if(d>=0){var b=!1;_.find(n,function(e){e.legendValue==r[d].label&&(v=e.y,b=!0)}),(s&&b||!s)&&o.push({x:f,text:t.getFieldValue(a),letter:p,y:v,serie:d})}}}}),_.each(r,function(e,t){e.annotations=_.filter(o,function(e){return e.serie==t})})}}}(jQuery,this.recline.Data.SeriesUtility),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},this.recline.Data.ShapeSchema=this.recline.Data.ShapeSchema||{},function(e,t){t.ShapeSchema=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var e=this;if(this.attributes.data){var t=this.attributes.data;e._generateLimits(t)}else this.attributes.dataset&&this.bindToDataset()},bindToDataset:function(){var e=this;e.attributes.dataset.dataset.records.bind("reset",function(){e._generateFromDataset()}),e.attributes.dataset.dataset.fields.bind("reset",function(){e.attributes.dataset.dataset.setShapeSchema(e.attributes.dataset.type)}),e.attributes.dataset.dataset.records.models.length>0&&e._generateFromDataset()},setDataset:function(e,t,n){var r=this;r.attributes.dataset={dataset:e,field:t,type:n},e.attributes.shapeSchema||(e.attributes.shapeSchema=[]),e.attributes.shapeSchema.push({schema:r,field:t}),e.setShapeSchema(n),r.bindToDataset()},_generateFromDataset:function(){var e=this,t=this.getRecordsArray(e.attributes.dataset);e._generateLimits(t)},_generateLimits:function(e){var t=this;t.schema={},_.each(t.attributes.limits,function(e,n){t.schema[e]=t.attributes.shapes[n]})},getShapeNameFor:function(e){var t=this;if(this.schema==null)throw"data.shape.js: shape schema not yet initialized, datasource not fetched?";return t._shapeName(e)},getShapeFor:function(e,t,n,r){var i=this;if(this.schema==null)throw"data.shape.js: shape schema not yet initialized, datasource not fetched?";if(!i.attributes.shapeType||i.attributes.shapeType=="svg"){var s=recline.Template.Shapes[this._shapeName(e)];if(s==null)throw"data.shape.js: shape ["+this._shapeName(e)+"] not defined in template.shapes";return s(t,r,n)}if(i.attributes.shapeType=="text")return this._shapeName(this._shapeName(e));if(i.attributes.shapeType=="image")return'<img src="'+this._shapeName(e)+'" class="shape_image">';throw"data.shape.js: unsupported shapeType ["+i.attributes.shapeType+"]"},_shapeName:function(e){var t=this;if(t.attributes.limitType&&this.attributes.limitType=="fixedLimits"){var n=t.attributes.shapes[0];for(var r=1;r<this.attributes.limits.length;r++)if(e>=this.attributes.limits[r-1]&&e<this.attributes.limits[r]){n=t.attributes.shapes[r];break}return n}return t.schema[e]},getRecordsArray:function(e){var t=this,n=[];if(e.recordCount)if(e.dataset.isFieldPartitioned&&e.dataset.isFieldPartitioned(e.field,e.type)){var r=e.dataset.getPartitionedFields(e.field);_.each(e.dataset.getRecords(e.type),function(e){_.each(r,function(t){n.push(e.attributes[t.id])})})}else{var r=[e.field];_.each(e.dataset.getRecords(e.type),function(e){_.each(r,function(t){n.push(e.attributes[t])})})}return n},limits:{distinct:function(e){var t={};return _.each(_.uniq(e),function(e,n){t[e]=recline.Data.Transform.getFieldHash(e)}),e}}}),t.ShapeSchema.addShapesToTerms=function(e,t,n){_.each(t,function(t){n&&_.each(n,function(n){n.field===e&&(t.shape=n.schema.getShapeFor(t.term,t.color,!1,!1))})})}}(jQuery,this.recline.Data),this.recline=this.recline||{},this.recline.Data=this.recline.Data||{},function(e,t){t.StateManagement={},t.StateManagement.State=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var e=this;_.each(e.attributes.models,function(t){t.ds.queryState.bind("change",function(){e.setState(e.attributes.stateName,t.ds.queryState,t.field,e)}),t.ds.queryState.bind("selection:change",function(){e.setState(e.attributes.stateName,t.ds.queryState,t.field,e)})}),this.attributes.defaultValue&&(this.defaultValue=this.attributes.defaultValue);var n=t.StateManagement.getState(e.attributes.stateName);n&&_.each(e.attributes.models,function(t){_.each(n.filters,function(n){t.ds.queryState.setFilter(e.mappingField(n,e.attributes.mappingField,t.field))}),_.each(n.selections,function(n){t.ds.queryState.setSelection(e.mappingField(n,e.attributes.mappingField,t.field))})})},mappingField:function(e,t,n){var r=this;if(e.field!=t)return e;var i=_.clone(e);return i.field=n,i},applySelectionToFilters:function(e){var n=this,r=t.StateManagement.getState(n.attributes.stateName);r&&_.each(e,function(e){_.each(r.selections,function(t){e.ds.queryState.setFilter(n.mappingField(t,n.attributes.mappingField,e.field))})})},setState:function(t,n,r,i){var s=_.filter(n.attributes.filters,function(e){return e.field==r}),o=_.filter(n.attributes.selections,function(e){return e.field==r});s=_.map(s,function(e){return i.mappingField(e,r,i.attributes.mappingField)}),o=_.map(o,function(e){return i.mappingField(e,r,i.attributes.mappingField)}),e.cookie("recline.extensions.statemanagement."+t,JSON.stringify({filters:s,selections:o}),{path:"/"})}}),t.StateManagement.getState=function(t){var n=e.cookie("recline.extensions.statemanagement."+t);return n?JSON.parse(n):this.State.arguments&&this.State.arguments.length&&this.State.arguments[0].defaultValue?this.State.arguments[0].defaultValue:null}}(jQuery,this.recline.Data),this.recline=this.recline||{},this.recline.Template=this.recline.Template||{},this.recline.Template.Shapes=this.recline.Template.Shapes||{},function(e,t){t.Shapes={circle:function(e,n,r){var i='<circle cx="100" cy="50" r="40" stroke="black" stroke-width="2" fill="{{color}}"/>',s={color:e};return t._internalDataConversion(n,r,i,s)},empty:function(e,n,r){t._internalDataConversion(n,r,"")}},t._internalDataConversion=function(e,t,n,r){t&&(n="<svg>"+n+"</svg>");var i=Mustache.render(n,r);return e?jQuery(i):i}}(jQuery,this.recline.Template),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.CSV=this.recline.Backend.CSV||{},function(e,t){t.setFieldsAttributesCSV=function(e,t,n){if(t.attributes.fieldsType){if(!t.attributes.fieldsType.length)throw"Wrong fieldsType parameter. Must be an array, not a single object!";_.each(t.attributes.fieldsType,function(r){var i=_.find(e,function(e){return r.id===e.id});i!=null&&(typeof i.type=="undefined"||i.type==null)&&i.type!=r.type&&(i.type=r.type,t.backend.__type__=="csv"&&n&&i.type!="string"&&_.each(n,function(e){i.type=="date"?e[r.id]=new Date(e[r.id]):i.type=="integer"?e[r.id]=parseInt(e[r.id]):i.type=="number"&&(e[r.id]=parseFloat(e[r.id]))}))})}}}(jQuery,this.recline.Backend.CSV),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.Jsonp=this.recline.Backend.Jsonp||{},function(e,t){function n(t,n,i){var s=e.Deferred(),o=e.ajax({url:t.url,dataType:"jsonp",jsonpCallback:t.id,data:n,cache:!0});return a(o).done(function(e){e.results.length!=1||e.results[0].status.code!=0?(console.log("Error in fetching data: "+e.results[0].status.message+" Statuscode:["+e.results[0].status.code+"] AdditionalInfo:["+e.results[0].status.additionalInfo+"]"),s.reject(e.results[0].status)):s.resolve(r(e.results[0].result,i))}).fail(function(e){s.reject(e)}),s.promise()}function r(e,t){if(e.data==null)return{fields:f(e.description),useMemoryStore:!1};var n=f(e.description),r=[];if(t)var r=recline.Data.Faceting.computeFacets(e.data,t);return{hits:i(e.data,n),fields:n,facets:r,useMemoryStore:!1,total:e.data.length}}function i(e,t){return _.each(t,function(t){t!="string"&&_.each(e,function(e){e[t.id]=recline.Data.FormattersMoviri[t.type](e[t.id])})}),e}function s(e){var t=new Date,n=o(e.getFullYear())+"-"+o(1+e.getMonth())+"-"+o(e.getDate())+" "+o(e.getHours())+":"+o(e.getMinutes())+":"+o(e.getSeconds());return n}function o(e){return e<10?"0"+e:""+e}function u(e){var t=e.filters,n=[],r="|",i={term:function l(e){var t=o[e.fieldType],n=e.field,l=t(e.term);return n+" eq "+l},termAdvanced:function(t){var n=o[t.fieldType],r=t.field,i=n(t.term),s=t.operator;return r+" "+s+" "+i},range:function(t){var n=o[t.fieldType],i=t.field,s=n(t.start),u=n(t.stop);return i+" bw "+s+r+u},list:function c(e){var t=o[e.fieldType],n=e.field,c=e.list,i=n+" in ";for(var s in c)s>0&&(i+=r),i+=c[s];return i}},o={number:function(e){return parseFloat(e,10)},string:function(e){return e.toString()},date:function(e){var t=new Date(e);return s(t)},integer:function(e){return parseInt(e)}};for(var u=0;u<t.length;u++)n.push(i[t[u].type](t[u]));var a="";_.each(e.sort,function(e){a.length>0&&(a+=";");var t=e.field;a+=t,e.order&&(a+=":"+e.order)});var f={};return n.length>0&&(f.filtersep="!==!",f.filters=n.join("!==!")),a.length>0&&(f.orderby=a),f}function f(e){var t={STRING:"string",DATE:"date",INTEGER:"integer",DOUBLE:"number"},n=[];for(var r in e)n.push({id:r,type:t[e[r]]});return n}t.__type__="Jsonp",t.timeout=6e4,t.fetch=function(e){console.log("Fetching data structure "+e.url);var t={onlydesc:"true"};return n(e,t)},t.query=function(e,t){var r=u(e);return console.log("Querying jsonp backend ["+(t.id?t.id:t.url)+"] for "),console.log(r),n(t,r,e)};var a=function(n){var r=e.Deferred(),i=setTimeout(function(){r.reject({message:"Request Error: Backend did not respond after "+t.timeout/1e3+" seconds"})},t.timeout);return n.done(function(e){clearTimeout(i),r.resolve(e)}).fail(function(e){clearTimeout(i),r.reject(e)}),r.promise()}}(jQuery,this.recline.Backend.Jsonp),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.JsonpMemoryStore=this.recline.Backend.JsonpMemoryStore||{},function(e,t){function n(t,n,i,s){var o=e.Deferred(),u=e.ajax({url:t.url,dataType:"jsonp",jsonpCallback:t.id,data:i,cache:!0});return a(u).done(function(e){e.results.length!=1||e.results[0].status.code!=0?(console.log("Error in fetching data: "+e.results[0].status.message+" Statuscode:["+e.results[0].status.code+"] AdditionalInfo:["+e.results[0].status.additionalInfo+"]"),o.reject(e.results[0].status)):o.resolve(r(e.results[0].result,s,n))}).fail(function(e){o.reject(e)}),o.promise()}function r(e,t,n){if(e.data==null)return{fields:f(e.description),useMemoryStore:!0};var r=f(e.description),s=[];if(t)var s=recline.Data.Faceting.computeFacets(e.data,t)
;return n=="fetch"?{records:i(e.data,r),fields:r,facets:s,useMemoryStore:!0,total:e.data.length}:{hits:i(e.data,r),fields:r,facets:s,useMemoryStore:!0,total:e.data.length}}function i(e,t){return _.each(t,function(t){t!="string"&&_.each(e,function(e){e[t.id]=recline.Data.FormattersMoviri[t.type](e[t.id])})}),e}function s(e){var t=new Date,n=o(e.getFullYear())+"-"+o(1+e.getMonth())+"-"+o(e.getDate())+" "+o(e.getHours())+":"+o(e.getMinutes())+":"+o(e.getSeconds());return n}function o(e){return e<10?"0"+e:""+e}function u(e){var t=[],n="|",r={term:function f(e){var t=i[e.fieldType],n=e.field,f=t(e.term);return n+" eq "+f},termAdvanced:function(t){var n=i[t.fieldType],r=t.field,s=n(t.term),o=t.operator;return r+" "+o+" "+s},range:function(t){var n=i[t.fieldType],r=t.field,s=n(t.start),o=n(t.stop);return r+" lte "+o+","+r+" gte "+s},list:function l(e){var t=i[e.fieldType],r=e.field,l=e.list,s=r+" bw ";for(var o in e.list)o>0&&(s+=n),s+=l[o];return s}},i={number:function(e){return parseFloat(e,10)},string:function(e){return e.toString()},date:function(e){var t=new Date(e);return s(t)},integer:function(e){return parseInt(e)}};for(var o=0;o<e.length;o++)t.push(r[e[o].type](e[o]));var u="",a={};return t.length>0&&(a.filters=t.toString()),u.length>0&&(a.orderby=u),a}function f(e){var t={STRING:"string",DATE:"date",INTEGER:"integer",DOUBLE:"number"},n=[];for(var r in e)n.push({id:r,type:t[e[r]]});return n}t.__type__="JsonpMemoryStore",t.timeout=6e4,t.fetch=function(e){console.log("Fetching data structure "+e.url);if(e.fetchFilters){var t=u(e.fetchFilters);return n(e,"fetch",t)}return n(e,"fetch",{})},t.query=function(e,t){var r=u(e);return console.log("Querying JsonpMemoryStore backend for "),console.log(r),n(t,"query",r,e)};var a=function(n){var r=e.Deferred(),i=setTimeout(function(){r.reject({message:"Request Error: Backend did not respond after "+t.timeout/1e3+" seconds"})},t.timeout);return n.done(function(e){clearTimeout(i),r.resolve(e)}).fail(function(e){clearTimeout(i),r.reject(e)}),r.promise()}}(jQuery,this.recline.Backend.JsonpMemoryStore),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.SocketIO=this.recline.Backend.SocketIO||{},function(e,t){function n(t,n,i){var s=e.Deferred(),o=e.ajax({url:t.url,dataType:"jsonp",jsonpCallback:t.id,data:n,cache:!0});return a(o).done(function(e){e.results.length!=1||e.results[0].status.code!=0?(console.log("Error in fetching data: "+e.results[0].status.message+" Statuscode:["+e.results[0].status.code+"] AdditionalInfo:["+e.results[0].status.additionalInfo+"]"),s.reject(e.results[0].status)):s.resolve(r(e.results[0].result,i))}).fail(function(e){s.reject(e)}),s.promise()}function r(e,t){if(e.data==null)return{fields:f(e.description),useMemoryStore:!1};var n=f(e.description),r=[];if(t)var r=recline.Data.Faceting.computeFacets(e.data,t);return{hits:i(e.data,n),fields:n,facets:r,useMemoryStore:!1,total:e.data.length}}function i(e,t){return _.each(t,function(t){t!="string"&&_.each(e,function(e){e[t.id]=recline.Data.FormattersMoviri[t.type](e[t.id])})}),e}function s(e){var t=new Date,n=o(e.getFullYear())+"-"+o(1+e.getMonth())+"-"+o(e.getDate())+" "+o(e.getHours())+":"+o(e.getMinutes())+":"+o(e.getSeconds());return n}function o(e){return e<10?"0"+e:""+e}function u(e){var t=e.filters,n=[],r="|",i={term:function l(e){var t=o[e.fieldType],n=e.field,l=t(e.term);return n+" eq "+l},termAdvanced:function(t){var n=o[t.fieldType],r=t.field,i=n(t.term),s=t.operator;return r+" "+s+" "+i},range:function(t){var n=o[t.fieldType],i=t.field,s=n(t.start),u=n(t.stop);return i+" bw "+s+r+u},list:function c(e){var t=o[e.fieldType],n=e.field,c=e.list,i=n+" in ";for(var s in c)s>0&&(i+=r),i+=c[s];return i}},o={number:function(e){return parseFloat(e,10)},string:function(e){return e.toString()},date:function(e){var t=new Date(e);return s(t)},integer:function(e){return parseInt(e)}};for(var u=0;u<t.length;u++)n.push(i[t[u].type](t[u]));var a="";_.each(e.sort,function(e){a.length>0&&(a+=";");var t=e.field;a+=t,e.order&&(a+=":"+e.order)});var f={};return n.length>0&&(f.filtersep="!==!",f.filters=n.join("!==!")),a.length>0&&(f.orderby=a),f}function f(e){var t={STRING:"string",DATE:"date",INTEGER:"integer",DOUBLE:"number"},n=[];for(var r in e)n.push({id:r,type:t[e[r]]});return n}t.__type__="SocketIO",t.fetch=function(e){console.log("Fetching data structure "+e.url);var t={onlydesc:"true"};return n(e,t)},t.query=function(e,t){var r=u(e);return console.log("Querying jsonp backend ["+(t.id?t.id:t.url)+"] for "),console.log(r),n(t,r,e)};var a=function(n){var r=e.Deferred(),i=setTimeout(function(){r.reject({message:"Request Error: Backend did not respond after "+t.timeout/1e3+" seconds"})},t.timeout);return n.done(function(e){clearTimeout(i),r.resolve(e)}).fail(function(e){clearTimeout(i),r.reject(e)}),r.promise()}}(jQuery,this.recline.Backend.Jsonp),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.Splunk=this.recline.Backend.Splunk||{},function(e,t){function n(t,n,i){var o=e.Deferred(),u=new splunkjs.ProxyHttp(t.proxyUrl),a=new splunkjs.Service(u,{username:t.username,password:t.password,scheme:t.scheme,host:t.host,port:t.port,version:t.version}),f={};i?(i.size&&(f.count=i.size),f.search=s(i)):f.search="search *";var l={exec_mode:"normal",earliest_time:t.earliestTime};return a.search(f.search,l,function(e,t){console.log("Job SID: ",t.sid),t.track({period:200},{done:function(e){console.log("Done!"),console.log("Job statistics:"),console.log("  Event count:  "+e.properties().eventCount),console.log("  Result count: "+e.properties().resultCount),console.log("  Disk usage:   "+e.properties().diskUsage+" bytes"),console.log("  Priority:     "+e.properties().priority),e.results(f,function(e,t,n){o.resolve(r(t,i))})},failed:function(e){o.reject("Job failed")},error:function(e){o.reject(e)}})}),o.promise()}function r(e,t){var n=u(e.fields);if(t)var r=recline.Data.Faceting.computeFacets(e.records,t);return{fields:n,useMemoryStore:!1,facets:r,total:e.rows.length,hits:i(e.rows,n)}}function i(e,t){var n=[];return _.each(e,function(e){var r={};_.each(t,function(t){r[t.id]=recline.Data.FormattersMoviri[t.type](e[t.index])}),n.push(r)}),n}function s(e){var t=e.filters,n=[],r={term:function u(e){var t=i[e.fieldType],n=e.field,u=t(e.term);return n+"="+u},range:function(t){var n=i[t.fieldType],r=t.field,s=n(t.start),o=n(t.stop);return r+" bw "+s+multivsep+o},list:function a(e){var t=i[e.fieldType],n=e.field,a=e.list,r=n+" in ";for(var s in a)s>0&&(r+=multivsep),r+=a[s];return r}},i={number:function(e){return parseFloat(e,10)},string:function(e){return e.toString()},date:function(e){var t=new Date(e);return getDate(t)},integer:function(e){return parseInt(e)}};for(var s=0;s<t.length;s++)n.push(r[t[s].type](t[s]));var o="search ";return n.length>0?o+=n.toString():o+="*",o}function u(e,t){var n={STRING:"string",DATE:"date",INTEGER:"integer",DOUBLE:"number"},r=[];return _.each(e,function(e,t){r.push({id:e,type:n.STRING,index:t})}),r}t.__type__="Splunk",t.timeout=6e4,t.fetch=function(e){throw"recline-splunk: fetch not implemented"},t.query=function(e,t){var r=s(e);return console.log("Querying splunk backend ["+(t.id?t.id:t.url)+"] for "),console.log(r),n(t,r,e)};var o=function(n){var r=e.Deferred(),i=setTimeout(function(){r.reject({message:"Request Error: Backend did not respond after "+t.timeout/1e3+" seconds"})},t.timeout);return n.done(function(e){clearTimeout(i),r.resolve(e)}).fail(function(e){clearTimeout(i),r.reject(e)}),r.promise()}}(jQuery,this.recline.Backend.Splunk),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.ParallelUnionBackend=this.recline.Backend.ParallelUnionBackend||{},function(e,t){t.__type__="ParallelUnionBackend",t.deferreds=function(e){var n=[];return _.each(e.backendConfiguration.backends,function(e){e.instance=t._backendFromString(e.backend);var r=e.instance.fetch(e.props);r.done(function(e){_.extend(data,e)}),n.push(r)}),n},t.fetch=function(n){var r=new e.Deferred,i={fields:[],records:[],useMemoryStore:!1},s=[];return _.each(n.backendConfiguration.backends,function(e){e.instance=t._backendFromString(e.backend);var n=e.instance.fetch(e.props);n.done(function(e){i.useMemoryStore&&(i.useMemoryStore=!0),_.each(e.fields,function(e){_.find(i.fields,function(t){return e.id==t.id})||i.fields.push(e)})}),s.push(n)}),e.when.apply(window,s).done(function(){r.resolve(i).fail(t.errorOnFetching)}),r.promise()},t.query=function(n,r){var i=new e.Deferred,s={fields:[],hits:[],useMemoryStore:!1,facets:[],total:0},o=[];if(r.backendConfiguration.backendChoser){var u=r.backendConfiguration.backendChoser(n);_.each(u,function(r){var i=_.clone(n);i.filters=r.filters,r.instance=t._backendFromString(r.backend.backend);var u=r.instance.query(i,r.backend.props);u.done(function(t){s.useMemoryStore&&(s.useMemoryStore=!0),_.each(t.fields,function(e){_.find(s.fields,function(t){return e.id==t.id})||s.fields.push(e)}),s.hits=e.merge(s.hits,t.hits),s.facets=e.merge(s.facets,t.facets),s.total=s.total+s.hits.length}),o.push(u)})}else _.each(r.backendConfiguration.backends,function(r){r.instance=t._backendFromString(r.backend);var i=r.instance.query(n,r.props);i.done(function(t){s.useMemoryStore&&(s.useMemoryStore=!0),_.each(t.fields,function(e){_.find(s.fields,function(t){return e.id==t.id})||s.fields.push(e)}),s.hits=e.merge(s.hits,t.hits),s.facets=e.merge(s.facets,t.facets),s.total=s.total+s.hits.length}),o.push(i)});return e.when.apply(window,o).done(function(){i.resolve(t.prepareResults(s,r.backendConfiguration.result)).fail(t.errorOnFetching)}),i.promise()},t.prepareResults=function(e,t){if(t.type=="union")return e;if(t.type=="sum"){var n=t.groupBy,r;n.constructor==Array?r=_.groupBy(e.hits,function(e){var t="";return _.each(n,function(n){t=t+"#"+e[n]}),t}):r=_.groupBy(e.hits,n);var i=[];return _.each(r,function(e,r){var s={};_.each(n,function(t){s[t]=e[0][t]}),_.each(e,function(e){_.each(t.fields,function(t,n){s[t]?s[t]=s[t]+e[t]:s[t]=e[t]})}),i.push(s)}),e.hits=i,e.total=e.hits.length,e}},t.errorOnFetching=function(){return{message:"Request Error: error on fetching union parallel backends"}},t._backendFromString=function(e){var t=null;return recline&&recline.Backend&&_.each(_.keys(recline.Backend),function(n){n.toLowerCase()===e.toLowerCase()&&(t=recline.Backend[n])}),t}}(jQuery,this.recline.Backend.ParallelUnionBackend),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function($,my){my.GoogleMaps=Backbone.View.extend({iconaMarker:"http://chart.googleapis.com/chart?chst=d_simple_text_icon_above&chld={TEXT}|14|{TEXTCOLOR}|{MARKERICON}|{ICONSIZE}|{ICONCOLOR}|404040",initialize:function(e){_.bindAll(this,"render","redraw","clearAllMarkers","getMarkerColor","openInfoWindow"),this.model.bind("query:done",this.redraw),this.mapEl=document.getElementById(this.options.el),this.render()},clearAllMarkers:function(){_.each(this.markers,function(e){e.setMap(null)}),this.markers=[]},getMarkerColor:function(val,htmlType){var self=this,min,max;if(self.options.state.redThreshold.indexOf("min")>=0||self.options.state.redThreshold.indexOf("max")>=0||self.options.state.greenThreshold.indexOf("min")>=0||self.options.state.greenThreshold.indexOf("max")>=0){var fieldValues=_.map(this.model.getRecords(),function(e){return e.attributes[self.options.state.valueField]});min=_.min(fieldValues),max=_.max(fieldValues)}return val<=eval(self.options.state.redThreshold)?htmlType?"#FF0000":"red":val<=eval(self.options.state.greenThreshold)?htmlType?"#FFFF00":"yellow":htmlType?"#00FF00":"green"},render:function(){var e=this,t={};this.options.state.googleOptions&&(t=_.extend(t,this.options.state.googleOptions)),this.options.state.mapCenter&&(t.center=new google.maps.LatLng(this.options.state.mapCenter[0],this.options.state.mapCenter[1])),this.options.state.mapType&&(t.mapTypeId=google.maps.MapTypeId[this.options.state.mapType]),this.map=new google.maps.Map(this.mapEl,t),this.options.state.clustererOptions&&(mc=new MarkerClusterer(this.map,[],this.options.state.clustererOptions)),this.options.events&&this.options.events.mapClick&&google.maps.event.addListener(this.map,"click",this.options.events.mapClick),this.options.events&&this.options.events.mapDblClick&&google.maps.event.addListener(this.map,"dblclick",this.options.events.mapDblClick),this.options.events&&this.options.events.mapRightClick&&google.maps.event.addListener(this.map,"rightclick",this.options.events.mapRightClick),this.options.state.infoWindowTemplate&&(this.infowindow=new google.maps.InfoWindow({content:""}),this.infowindow.close()),this.redraw()},redraw:function(){var e=this;this.clearAllMarkers(),this.options.state.clustererOptions&&mc&&mc.clearMarkers();var t=e.options.state.latField,n=e.options.state.longField,r=e.options.state.valueField,i=e.options.state.markerIcon;_.each(this.model.getRecords("unfiltered"),function(i){var s=new google.maps.LatLng(i.attributes[t],i.attributes[n]),o=e.getMarkerColor(i.attributes[r],!0).replace("#",""),u=e.iconaMarker.replace("{TEXT}",e.options.state.showValue?i.attributes[r].toString():"");u=u.replace("{ICONCOLOR}",o),u=u.replace("{TEXTCOLOR}",o),u=u.replace("{MARKERICON}",e.options.state.markerIcon),u=u.replace("{ICONSIZE}",e.options.state.markerSize);var a=new google.maps.Marker({position:s,map:e.map,animation:null,icon:u,value:i.attributes[r],color:e.getMarkerColor(i.attributes[r]),record:i});e.options.state.infoWindowTemplate&&google.maps.event.addListener(a,"click",function(){e.openInfoWindow(a)});if(e.options.actions){var f=e.getActionsForEvent("selection"),l=e.options.state.mapping;google.maps.event.addListener(a,"click",function(){var e=this.record;f.forEach(function(t){t.action.doAction([e],t.mapping)})});var c=e.getActionsForEvent("hover"),l=e.options.state.mapping;google.maps.event.addListener(a,"mouseover",function(){var e=this.record;c.forEach(function(t){t.action.doAction([e],t.mapping)})})}e.options.events&&e.options.events.markerClick&&google.maps.event.addListener(a,"click",e.options.events.markerClick),e.options.events&&e.options.events.markerDblClick&&google.maps.event.addListener(a,"dblclick",e.options.events.markerDblClick),e.options.events&&e.options.events.markerRightClick&&google.maps.event.addListener(a,"rightclick",e.options.events.markerRightClick),e.markers.push(a)}),this.options.state.clustererOptions&&mc&&(mc.addMarkers(this.markers),mc.repaint())},getActionsForEvent:function(e){var t=this,n=[];return _.each(t.options.actions,function(t){_.contains(t.event,e)&&n.push(t)}),n},openInfoWindow:function(e){var t={value:e.value,color:e.color};t=_.extend(t,e.record.attributes);var n=Mustache.render(this.options.state.infoWindowTemplate,t);this.infowindow.setContent(n),this.infowindow.setPosition(e.position),this.infowindow.open(this.map)},closeInfoWindow:function(){this.infowindow.setContent(""),this.infowindow.close()}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.Composed=Backbone.View.extend({templates:{vertical:'<div id="{{uid}}"><div class="composedview_table" style="display:table"><div class="c_group c_header" style="display:table-header-group"><div class="c_row" style="display:table-row"><div class="cell cell_empty" style="display:table-cell"></div>{{#dimensions}}<div class="cell cell_name" style="display:table-cell"><div class="title" style="float:left">{{term_desc}}</div><div class="shape" style="float:left">{{{shape}}}</div></div>{{/dimensions}}{{#dimensions_totals}}<div class="cell cell_name" style="display:table-cell"><div class="title" style="float:left">{{term_desc}}</div><div class="shape" style="float:left">{{{shape}}}</div></div>{{/dimensions_totals}}</div></div><div class="c_group c_body" style="display:table-row-group">{{#noData}}}<div class="c_row"><div class="cell cell_empty"/>{{{noData}}}</div>{{/noData}}{{#measures}}<div class="c_row" style="display:table-row"><div class="cell cell_title" style="display:table-cell"><div style="white-space:nowrap;"><div class="rawhtml" style="vertical-align:middle;float:left">{{{rawhtml}}}</div><div style="vertical-align:middle;float:left"><div class="title">{{{title}}}</div><div class="subtitle">{{{subtitle}}}</div></div><div class="shape" style="vertical-align:middle;float:left">{{shape}}</div></div></div>{{#dimensions}}<div class="cell cell_graph" style="display:table-cell" id="{{#getDimensionIDbyMeasureID}}{{measure_id}}{{/getDimensionIDbyMeasureID}}" term="{{measure_id}}"></div>{{/dimensions}}{{#dimensions_totals}}<div class="cell cell_graph" style="display:table-cell" id="{{#getDimensionIDbyMeasureTotalsID}}{{measure_id}}{{/getDimensionIDbyMeasureTotalsID}}"></div>{{/dimensions_totals}}</div>{{/measures}}</div><div class="c_group c_footer"></div></div></div>',horizontal:'<div id="{{uid}}"><table><tr><td><div class="composedview_table" style="display:table"><div class="c_group c_header" style="display:table-header-group"><div class="c_row" style="display:table-row"><div class="cell cell_empty" style="display:table-cell"></div>{{#measures}}<div class="cell cell_title" style="display:table-cell"><div style="white-space:nowrap;"><div class="rawhtml" style="vertical-align:middle;float:left">{{{rawhtml}}}</div><div style="float:left;vertical-align:middle"><div class="title"><a class="link_tooltip" href="#" data-toggle="tooltip" title="{{{subtitle}}}">{{{title}}}</a></div></div><div class="shape" style="float:left;vertical-align:middle">{{shape}}</div></div></div>{{/measures}}</div></div><div class="c_group c_body" style="display:table-row-group">{{#dimensions}}<div class="c_row" style="display:table-row"><div class="cell cell_name" style="display:table-cell"><div class="title" style="float:left">{{term_desc}}</div><div class="shape" style="float:left">{{{shape}}}</div></div>{{#measures}}<div class="cell cell_graph" style="display:table-cell" id="{{viewid}}"></div>{{/measures}}</div>{{/dimensions}}<div class="c_row c_totals" style="display:table-row">{{#dimensions_totals}}<div class="cell cell_name" style="display:table-cell"><div class="title" style="float:left">{{term_desc}}</div><div class="shape" style="float:left">{{{shape}}}</div></div>{{#measures_totals}}<div class="cell cell_graph" style="display:table-cell" id="{{viewid}}"></div>{{/measures_totals}}{{/dimensions_totals}}</div></div></div></td></tr><tr><td>{{{noData}}}</td></tr></table></div>'},redrawSemaphore:function(e,t){t.semaphore||(t.semaphore=""),t.options.modelTotals?e=="model"?t.semaphore=="totals"?(t.semaphore="",t.redraw()):t.semaphore="model":t.semaphore=="model"?(t.semaphore="",t.redraw()):t.semaphore="totals":t.redraw()},initialize:function(t){var n=this;this.el=e(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",function(){n.redrawSemaphore("model",n)}),this.options.modelTotals&&(this.options.modelTotals.bind("change",this.render),this.options.modelTotals.fields.bind("reset",this.render),this.options.modelTotals.fields.bind("add",this.render),this.options.modelTotals.bind("query:done",function(){n.redrawSemaphore("totals",n)})),this.uid=t.id||"composed_"+(new Date).getTime()+Math.floor(Math.random()*1e4),_.each(this.options.measures,function(e,t){n.options.measures[t].measure_id=(new Date).getTime()+Math.floor(Math.random()*1e4)}),_.each(this.options.measuresTotals,function(e,t){n.options.measuresTotals[t].measure_id=(new Date).getTime()+Math.floor(Math.random()*1e4)}),this.views=[]},render:function(){var e=this,t="#"+this.uid;e.graph&&jQuery(t).empty()},getViewFunction:function(){return function(e){var t=_.find(this.measures,function(t){return t.measure_id==e});return t.viewid}},redraw:function(){var e=this;e.dimensions=[],e.noData="";if(e.options.groupBy){var t=this.model.getFacetByFieldId(e.options.groupBy),n=this.model.fields.get(e.options.groupBy);if(!n)throw"ComposedView: unable to find groupBy field ["+e.options.groupBy+"] in model ["+this.model.id+"]";if(!t)throw"ComposedView: no facet present for groupby field ["+e.options.groupBy+"]. Define a facet on the model before view render";t.attributes.terms.length==0&&!e.options.modelTotals?e.noData=(new recline.View.NoDataMsg).create2():_.each(t.attributes.terms,function(t){if(t.count>0){var r=(new Date).getTime()+Math.floor(Math.random()*1e4),i;if(t.term){var s=_.find(e.model.getRecords(),function(n){return n.attributes[e.options.groupBy]==t.term});s&&(i=s.getFieldValue(n))}var o;e.options.rowTitle?o=e.options.rowTitle(t):o=i||t.term;var u={term:t.term,term_desc:o,id_dimension:r,shape:t.shape};u.getDimensionIDbyMeasureID=function(){return function(e){var t=_.find(this.measures,function(t){return t.measure_id==e});return t.viewid}},e.dimensions.push(e.addFilteredMeasuresToDimension(u,n))}})}else{var r=(new Date).getTime()+Math.floor(Math.random()*1e4),i;e.options.type=="groupByRecord"?i=e.addMeasuresToDimension({id_dimension:r}):i=e.addMeasuresToDimensionAllModel({id_dimension:r},e.options.measures),_.each(i,function(t,n){t.getDimensionIDbyMeasureID=e.getViewFunction,i[n]=t}),e.dimensions=i}this.measures=this.options.measures;if(e.options.modelTotals){var s=[],r=(new Date).getTime()+Math.floor(Math.random()*1e4),i={id_dimension:r,measures:s};e.options.titleTotals&&(i.term_desc=e.options.titleTotals),_.each(e.options.measuresTotals,function(t){var n={view:t.view,viewid:(new Date).getTime()+Math.floor(Math.random()*1e4),measure_id:t.measure_id,props:t.props,dataset:e.options.modelTotals,title:t.title,subtitle:t.subtitle,rawhtml:t.rawhtml};s.push(n)}),i.getDimensionIDbyMeasureTotalsID=function(){return function(t){var n=-1,r=_.find(e.measures,function(e){return n++,e.measure_id==t});if(r&&n>=0&&n<e.measures_totals.length)return e.measures_totals[n].viewid}},e.dimensions_totals=[i],e.measures_totals=s}var o=this.templates.vertical;this.options.template&&(o=this.templates[this.options.template]),this.options.customTemplate&&(o=this.options.customTemplate);var u=Mustache.render(o,e);this.el.html(u),this.attachViews(),e.options.postRender&&e.options.postRender.call(),this.el.trigger("resize")},attachViews:function(){var t=this;t.views=[],_.each(t.dimensions,function(n){_.each(n.measures,function(n){var r=e("#"+n.viewid);n.props.el=r,n.props.model=n.dataset;var i=new recline.View[n.view](n.props);t.views.push(i),typeof i.render!="undefined"&&i.render(),typeof i.redraw!="undefined"&&i.redraw()})}),_.each(t.dimensions_totals,function(n){_.each(n.measures,function(n){var r=e("#"+n.viewid);n.props.el=r,n.props.model=n.dataset;var i=new recline.View[n.view](n.props);t.views.push(i),typeof i.render!="undefined"&&i.render(),typeof i.redraw!="undefined"&&i.redraw()})})},addFilteredMeasuresToDimension:function(e,t){var n=this,r=new recline.Model.FilteredDataset({dataset:n.model}),i={field:t.get("id"),type:"term",term:e.term,term_desc:e.term,fieldType:t.get("type")};r.queryState.addFilter(i),r.query();var s=[];return _.each(n.options.measures,function(e){var t={view:e.view,viewid:(new Date).getTime()+Math.floor(Math.random()*1e4),measure_id:e.measure_id,props:e.props,dataset:r,title:e.title,subtitle:e.subtitle,rawhtml:e.rawhtml};s.push(t)}),e.measures=s,e},addMeasuresToDimension:function(e){var t=this,n=[];return _.each(t.model.records.models,function(r){var i=[];_.each(t.options.measures,function(e){var n=new recline.Model.Dataset({records:[r.toJSON()],fields:r.fields.toJSON(),renderer:t.model.attributes.renderer});n.fields=r.fields;var s={view:e.view,viewid:(new Date).getTime()+Math.floor(Math.random()*1e4),measure_id:e.measure_id,props:e.props,dataset:n,title:e.title,subtitle:e.subtitle,rawhtml:e.rawhtml};i.push(s)});var s={measures:i,id_dimension:e.id_dimension};n.push(s)}),n},addMeasuresToDimensionAllModel:function(e,t,n){var r=this,i=[];return _.each(t,function(e){var t,s;n?(t=e.totals.view,e.totals.props?s=e.totals.props:s={}):(t=e.view,s=e.props);var o={view:t,viewid:(new Date).getTime()+Math.floor(Math.random()*1e4),measure_id:e.measure_id,props:s,dataset:r.model,title:e.title,subtitle:e.subtitle,rawhtml:e.rawhtml};i.push(o)}),e.measures=i,[e]}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.Indicator=Backbone.View.extend({defaults:{format:"d"},compareType:{self:this,percentage:function(e,t,n,r,i){var s=new recline.Model.Field({type:"number",format:"percentage"}),o=e/t*100,u=recline.Data.Formatters.Renderers(o,s),a=n.templatePercentage;return r==1&&(i==1?a=n.templateCondensedShapeAfter:a=n.templateCondensed),{data:u,template:a,unrenderedValue:o,percentageMsg:" % of total: "}},percentageVariation:function(e,t,n,r,i){var s=new recline.Model.Field({type:"number",format:"percentage"}),o=(e-t)/t*100,u=recline.Data.Formatters.Renderers(o,s),a=n.templatePercentage;return r==1&&(i==1?a=n.templateCondensedShapeAfter:a=n.templateCondensed),{data:u,template:a,unrenderedValue:o,percentageMsg:""}},nocompare:function(e,t,n,r,i){var s=n.templateBase;return r==1&&(i==1?s=n.templateCondensedShapeAfter:s=n.templateCondensed),{data:null,template:s,unrenderedValue:null}}},templates:{templateBase:'<div class="indicator">       <div class="panel indicator_{{viewId}}">         <div id="indicator_{{viewId}}"> 			<table class="indicator-table">                 <tr class="titlerow"><td></td><td style="text-align: center;" class="title">{{{label}}}</td></tr>                    <tr class="descriptionrow"><td></td><td style="text-align: center;" class="description"><small>{{description}}</small></td></tr>                    <tr class="shaperow"> 	   				<td><div class="shape">{{{shape}}}</div> 	   				<div class="compareshape">{{{compareShape}}}</div> 	   				</td><td class="value-cell"><div class="kpi_value">{{{value}}}</div></td>	   				<td class="aftershape">{{{afterShape}}}</td> 	   			</tr>              </table>  		</div>      </div>     </div> ',templateCondensed:'<div class="indicator round-border-dark" >     	    <div class="panel indicator_{{viewId}}" >         		<div id="indicator_{{viewId}}" class="indicator-container" >         			<div class="round-border" style="float:left;margin:2px 2px 0px 2px">     					{{#compareShape}}     					<div class="compareshape" style="float:left">{{{compareShape}}}</div>     					{{/compareShape}} 						{{#shape}}     	                <div class="shape" style="float:left">{{{shape}}}</div>     					{{/shape}}         				<div class="value-cell" style="float:left"><div class="kpi_value">{{{value}}}</div></div>     					<div class="aftershape" style="float:left">{{{afterShape}}}</div>     				</div>     				{{#label}}<div class="title">&nbsp;&nbsp;{{{label}}}</div>{{/label}}    			</div>     	    </div>         </div>',templateCondensedShapeAfter:'<div class="indicator round-border-dark" >     	    <div class="panel indicator_{{viewId}}" >     			<div class="title">{{{label}}}</div>        		<div id="indicator_{{viewId}}" class="indicator-container"> 			    	<div class="round-border" style="float:left;margin:2px 2px 0px 2px">     				<div class="value-cell" style="float:left">{{{value}}}</div> 					{{#compareShape}} 					<div class="compareshape" style="float:left">{{{compareShape}}}</div> 					{{/compareShape}} 					{{#shape}} 			        <div class="shape" style="float:left">{{{shape}}}</div> 					{{/shape}}     			</div>     			</div>     	    </div>         </div>',templatePercentage:'<div class="indicator"> 	      <div class="panel indicator_{{viewId}}"> 	        <div id="indicator_{{viewId}}"> 				 <div class="indicator-table"> 	                <div class="titlerow"><span class="title">{{{label}}}</span></div>    	                <div class="descriptionrow"><span class="description"><small>{{description}}</small></span></div>    	                <div class="shaperow"> 						<div class="shape">{{{shape}}}</div> 						<span class="value-cell"> 							<div style="white-space: nowrap;"> 								<div class="kpi_value">{{{value}}}</div> 								<div class="kpi_compare_shape_container"> 									<div class="kpi_compare_shape_shape" >{{{compareShape}}}</div> 									<div class="kpi_compare_shape_msg">{{{percentageMsg}}}{{{compareValue}}}</div>								</div> 							</div> </span> 					</div>  	             </div>  			</div>	      </div> 	    </div> '},initialize:function(t){var n=this;this.el=e(this.el),_.bindAll(this,"render"),this.uid=t.id||""+(new Date).getTime()+Math.floor(Math.random()*1e4),this.model.bind("query:done",this.render),this.options.modelCompare?(this.modelCompare=this.options.modelCompare,this.modelCompare.bind("query:done",this.render)):this.modelCompare=this.model},render:function(){var t=this,n={};n.viewId=this.uid,n.label=this.options.state&&this.options.state.label;var r=t.model.getRecords(t.options.state.kpi.type),i;t.options.state.kpi.aggr?i=t.model.getField_byAggregationFunction(t.options.state.kpi.type,t.options.state.kpi.field,t.options.state.kpi.aggr):i=t.model.getFields(t.options.state.kpi.type).get(t.options.state.kpi.field);if(!i)if(!t.model.attributes.dataset||!!t.model.attributes.dataset.recordCount)throw"View.Indicator: unable to find field ["+t.options.state.kpi.field+"] on model";var s=null;if(t.options.state.condensed==1&&t.options.state.kpi.textField){t.options.state.kpi.aggr?s=t.model.getField_byAggregationFunction(t.options.state.kpi.type,t.options.state.kpi.textField,t.options.state.kpi.aggr):s=t.model.getFields(t.options.state.kpi.type).get(t.options.state.kpi.textField);if(!s)throw"View.Indicator: unable to find field ["+t.options.state.kpi.textField+"] on model"}var o;if(r.length>0&&i){o=r[0].getFieldValueUnrendered(i),n.value=r[0].getFieldValue(i),n.shape=r[0].getFieldShape(i,!0,!1);if(t.options.state.condensed==1&&s)if(t.options.maxLabelLength){var u=r[0].getFieldValue(s);if(u&&u.length>t.options.maxLabelLength){var a=u.substring(0,t.options.maxLabelLength);n.label='<abbr title="'+u+'">'+a+"...</abbr>"}else n.label=r[0].getFieldValue(s)}else n.label=r[0].getFieldValue(s)}else n.value="N/A";var f=this.templates.templateBase;t.options.state.condensed==1&&(f=t.templates.templateCondensed);if(t.options.state.compareWith){var l=t.modelCompare.getRecords(t.options.state.compareWith.type);if(l.length>0){var c;t.options.state.kpi.aggr?c=t.modelCompare.getField_byAggregationFunction(t.options.state.compareWith.type,t.options.state.compareWith.field,t.options.state.compareWith.aggr):c=t.modelCompare.getFields(t.options.state.compareWith.type).get(t.options.state.compareWith.field);if(!c){if(t.modelCompare.attributes&&t.modelCompare.attributes.dataset&&t.modelCompare.attributes.dataset.recordCount)throw"View.Indicator: unable to find field ["+t.options.state.compareWith.field+"] on model";return}n.compareWithValue=l[0].getFieldValue(c);var h=l[0].getFieldValueUnrendered(c),p,p=t.compareType[t.options.state.compareWith.compareType](o,h,t.templates,t.options.state.condensed,t.options.state.shapeAfter);if(!p)throw"View.Indicator: unable to find compareType ["+t.options.state.compareWith.compareType+"]";n.compareValue=p.data,t.options.state.compareWith.shapes&&(p.unrenderedValue==0?n.compareShape=t.options.state.compareWith.shapes.constant:p.unrenderedValue>0?n.compareShape=t.options.state.compareWith.shapes.increase:p.unrenderedValue<0&&(n.compareShape=t.options.state.compareWith.shapes.decrease)),p.template&&(f=p.template)}}else t.options.state.fillCompareSpace&&(f=this.templates.templatePercentage);(n["shape"]==null||typeof n["shape"]=="undefined")&&(n["compareShape"]==null||typeof n["compareShape"]=="undefined")&&(n.compareShape=" "),this.options.showPercentageBar&&(n.afterShape="<div class='indicator-percent-complete-bar-background' style='float:left;'><span class='indicator-percent-complete-bar' style='width:"+n.value+"'></span></div>"),this.options.state.description&&(n.description=this.options.state.description),p&&p.percentageMsg&&(n.percentageMsg=p.percentageMsg);var d=Mustache.render(f,n);return e(this.el).html(d),this}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.KartoGraph=Backbone.View.extend({template:'<div id="cartograph_{{viewId}}"></div> ',rendered:!1,mapWidth:undefined,mapHeight:undefined,initialize:function(t){var n=this;this.el=e(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",n.render),this.model.fields.bind("reset",n.render),this.model.fields.bind("add",n.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=""+(new Date).getTime()+Math.floor(Math.random()*1e4),this.mapWidth=t.state.width,this.mapHeight=t.state.height,this.unselectedColor="#C0C0C0",this.options
.state.unselectedColor&&(this.unselectedColor=this.options.state.unselectedColor)},render:function(){var t=this,n={};n.viewId=this.uid;var r=Mustache.render(this.template,n);e(this.el).html(r);var i=this.options.state.svgURI,s=this.options.state.layers;return t.map=$K.map("#cartograph_"+this.uid,t.mapWidth,t.mapHeight),t.map.loadMap(i,function(e){_.each(s,function(n){e.addLayer(n,t.getEventsForLayer(n))}),t.rendered=!0,t.updateMap()}),this},redraw:function(){var e=this;e.updateMap()},updateMap:function(){var e=this;if(!e.rendered)return;var t=e.map,n=this.options.state.colors,r=this.options.state.mapping;_.each(r,function(n){var r=t.getLayer(n.destLayer),i=[];_.each(r.paths,function(e){i.push(e.data[n.destAttribute])});var s=e._getDataFor(i,n.srcShapeField,n.srcValueField);r.style("fill",function(t){var r=s[t[n.destAttribute]];return r!=null?r.color:e.unselectedColor})})},_getDataFor:function(e,t,n){var r=this,i="filtered";r.options.useFilteredData!==null&&r.options.useFilteredData===!1&&(i="original");var s=r.model.getRecords(i),o=r.model.fields.get(t),u=r.model.fields.get(n),a=!1;r.model.queryState.isSelected()&&(a=!0);var f={};return _.each(s,function(t){if(_.contains(e,t.getFieldValueUnrendered(o))){var n=r.unselectedColor;a?t.isRecordSelected()&&(n=t.getFieldColor(u)):n=t.getFieldColor(u),f[t.getFieldValueUnrendered(o)]={record:t,field:u,color:n,value:t.getFieldValueUnrendered(u)}}}),f},getEventsForLayer:function(e){var t=this,n={},r=_.filter(this.options.state.mapping,function(t){return t.destLayer==e});if(r.length==0)return{};if(r.length>1)throw"view.Kartograph.js: more than one field associated with layer, impossible to link with actions";var i=t.getActionsForEvent("selection"),s=_.filter(i,function(e){return e.mapping.srcField==r.srcShapeField});return s.length>0&&(n.click=function(e,t,n){console.log(e),_.each(s,function(t){var n=[];_.each(t.mapping,function(t){n.push({filter:t.filter,value:[e[r[0].destAttribute]]})}),t.action._internalDoAction(n,"add")})}),n},getMapping:function(e){var t=this,n=this.options.state.mapping;return _.filter(n,function(t){return t.srcShapeField==e})},doActions:function(e,t){_.each(e,function(e){e.action._internalDoAction([t])}),params.push({filter:mapp.filter,value:values})},getActionsForEvent:function(e){var t=this,n=[];return _.each(t.options.actions,function(t){_.contains(t.event,e)&&n.push(t)}),n}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.Loader=Backbone.View.extend({divOver:null,loaderCount:0,defaultDivStyle:"display:none;opacity:0.7;background:#f9f9f9;position:absolute;top:0;z-index:100;width:100%;height:100%;",htmlLoaderTemplate:'<div id="__loadingImage__" style="display:block;">     			<div style="position:absolute;top:45%;left:45%;width:150px;height:80px;z-index:100">     				<p style="margin-left:auto;margin-right: auto;text-align: center;">     					{{^iconName}}     						<img src="{{baseurl}}images/ajax-loader-blue.gif" >     					{{/iconName}} 						{{#iconName}}     						<img src="{{iconName}}" > 						{{/iconName}}     				</p>     			</div>     		</div>',initialize:function(t){_.bindAll(this,"render","incLoaderCount","decLoaderCount","bindDatasets","bindDataset","bindCharts","bindChart"),this.divOver=e('<div id="__grayedOutBackground__"/>'),this.divOver.attr("style",t.style||this.defaultDivStyle),this.datasets=t.datasets,this.charts=t.charts,this.baseurl="/",t.baseurl&&(this.baseurl=t.baseurl),t.container!=null?this.container=t.container:this.container=e(document.body),this.container.append(this.divOver)},render:function(){var e=Mustache.render(this.htmlLoaderTemplate,this.options);this.container.append(e),this.divOver.show(),this.bindDatasets(this.datasets),this.bindCharts(this.charts)},incLoaderCount:function(){var t=this;this.loaderCount++,setTimeout(function(){t.divOver.show(),e("#__loadingImage__").show()},0)},decLoaderCount:function(){var t=this;this.loaderCount--,this.loaderCount<=0&&(setTimeout(function(){e("#__loadingImage__").hide(),t.divOver.hide()},0),this.loaderCount=0)},bindDatasets:function(e){var t=this;_.each(e,function(e){e.bind("query:start",t.incLoaderCount),e.bind("query:done query:fail",t.decLoaderCount)})},bindDataset:function(e){e.bind("query:start",this.incLoaderCount),e.bind("query:done query:fail",this.decLoaderCount)},bindCharts:function(e){var t=this;_.each(e,function(e){e.bind("chart:startDrawing",t.incLoaderCount),e.bind("chart:endDrawing",t.decLoaderCount)})},bindChart:function(e){e.bind("chart:startDrawing",this.incLoaderCount),e.bind("chart:endDrawing",this.decLoaderCount)}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.NoDataMsg=Backbone.View.extend({templateP1:"<div class='noData' style='display:table;width:100%;height:100%;'><p style='display:table-cell;width:100%;height:100%;margin-left: auto;margin-right: auto;text-align: center;margin-bottom: auto;margin-top: auto;vertical-align: middle;'>",template2P1:"<div class='noData' style='width:100%;height:100%;'><p style='width:100%;height:100%;margin-left: auto;margin-right: auto;text-align: center;margin-bottom: 10px;margin-top:10px;'>",_internalMsg:"No Data Available!",templateP2:"</p></div>",initialize:function(){},create:function(e){return e?this.templateP1+e+this.templateP2:this.templateP1+this._internalMsg+this.templateP2},create2:function(e){return e?this.template2P1+e+this.templateP2:this.template2P1+this._internalMsg+this.templateP2}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.NVD3Graph=Backbone.View.extend({template:'<div class="recline-graph">       <div class="panel nvd3graph_{{viewId}}"style="display: block;">         <div id="nvd3chart_{{viewId}}"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" class="bstrap" width="{{width}}" height="{{height}}">         	  <defs> 		    	<marker id = "Circle" viewBox = "0 0 40 40" refX = "12" refY = "12" markerWidth = "6" markerHeight = "6" stroke = "white" stroke-width = "4" fill = "dodgerblue" orient = "auto"> 		    	<circle cx = "12" cy = "12" r = "12"/> 		    	</marker> 		      </defs>         	</svg></div>      </div>     </div> ',initialize:function(t){var n=this;this.uid=t.id||""+(new Date).getTime()+Math.floor(Math.random()*1e4),this.el=e(this.el),_.bindAll(this,"render","redraw","graphResize","changeDimensions","getFormatter"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.model.bind("dimensions:change",this.changeDimensions),this.options.state&&this.options.state.loader&&this.options.state.loader.bindChart(this)},changeDimensions:function(){var e=this;e.state.attributes.group=e.model.getDimensions()},render:function(){var t=this;t.trigger("chart:startDrawing");var n=_.extend({group:null,seriesNameField:[],seriesValues:[],colors:["#edc240","#afd8f8","#cb4b4b","#4da74d","#9440ed"],graphType:"lineChart",xLabel:"",id:0},this.options.state);this.state=new recline.Model.ObjectState(n);var r=this.model.toTemplateJSON();r.viewId=this.uid,this.state.attributes.width&&(r.width=this.state.attributes.width),this.state.attributes.height&&(r.height=this.state.attributes.height),delete this.chart;var i=Mustache.render(this.template,r);return e(this.el).html(i),this.$graph=this.el.find(".panel.nvd3graph_"+r.viewId),t.trigger("chart:endDrawing"),this},getActionsForEvent:function(e){var t=[];return _.each(this.options.actions,function(n){_.contains(n.event,e)&&t.push(n)}),t},redraw:function(){var t=this;t.trigger("chart:startDrawing");if(typeof t.model.records=="undefined"||t.model.records==null||t.model.records.length==0){var n=this.el.find("#nvd3chart_"+t.uid+" svg");n.css("display","block");var r=n.width(),i=n.height();n.css("display","none"),this.el.find("#nvd3chart_"+t.uid).width(r).height(i).html("").append((new recline.View.NoDataMsg).create()),t.trigger("chart:endDrawing");return}e("div.noData",this.el).length&&t.render();var n=this.el.find("#nvd3chart_"+t.uid+" svg");n.css("display","block");var r=n.width(),i=n.height(),s=this.state,o=recline.Data.SeriesUtility.createSeries(this.state.attributes.series,this.state.attributes.unselectedColor,this.model,this.options.resultType,this.state.attributes.group,this.options.state.scaleTo100Perc,this.options.state.groupAllSmallSeries),u=0;o&&_.each(o,function(e){e.values&&(u+=e.values.length)});if(!u)return n.css("display","none"),this.el.find("#nvd3chart_"+t.uid).width(r).height(i).html("").append((new recline.View.NoDataMsg).create()),t.trigger("chart:endDrawing"),null;t.series=o;var a=this.state.get("graphType"),f=this.uid,l=this.model,s=this.state,c=this.state.get("xLabel"),h=this.state.get("yLabel");nv.addGraph(function(){t.chart=t.getGraph[a](t);var e=t.el.find("#nvd3chart_"+t.uid+" svg"),n=t.getGraphModel(t,a);if(typeof n=="undefined")throw"NVD3 Graph type "+a+" not found!";if(t.options.state.options){if(t.options.state.options.noTicksX)t.chart.xAxis.tickFormat(function(e){return""});else{var r=t.model.fields.get(t.options.state.group);r.attributes.type=="date"&&(a.indexOf("Horizontal")<0&&t.options.state.tickFormatX?t.chart.xAxis.tickFormat(function(e){return t.options.state.tickFormatX(new Date(e))}):a.indexOf("Horizontal")>0&&t.options.state.tickFormatY?t.chart.yAxis.tickFormat(function(e){return t.options.state.tickFormatY(new Date(e))}):t.chart.xAxis.tickFormat(function(e){return d3.time.format("%d-%b")(new Date(e))}))}t.options.state.options.noTicksY&&t.chart.yAxis.tickFormat(function(e){return""});if(t.options.state.options.customTooltips){var i=10,s=0,u=t.model.fields.get(t.state.attributes.group),f=t.model.fields.get(t.state.attributes.series);n.dispatch.on("elementMouseover.tooltip",function(n){var r;n.e&&n.e.pageY&&n.e.pageX?r={top:n.e.pageY,left:n.e.pageX}:r={left:n.pos[0]+ +e.offset().left+50,top:n.pos[1]+e.offset().top};var o;a.indexOf("Horizontal")>=0?o={x:n.point.x,y:f?t.getFormatter(f.get("type"))(n.point.y):n.point.y,y_orig:n.point.y_orig||n.point.y,yLabel:n.series.key,xLabel:u?u.get("label"):""}:o={x:u?t.getFormatter(u.get("type"))(n.point.x):n.point.x,y:n.point.y,y_orig:n.point.y_orig||n.point.y,xLabel:n.series.key,yLabel:f?f.get("label"):""},o.record=n.point.record.attributes;var l=Mustache.render(t.options.state.options.customTooltips,o);nv.tooltip.show([r.left+i,r.top+s],l,r.left<t.el[0].offsetLeft+t.el.width()/2?"w":"e",null,t.el[0])}),n.dispatch.on("elementMouseout.tooltip",function(e){nv.tooltip.cleanup()})}}return t.state.attributes.options&&_.each(_.keys(t.state.attributes.options),function(e){try{t.addOption[e](t.chart,t.state.attributes.options[e])}catch(n){console.log("view.nvd3.graph.js: cannot add options "+e+" for graph type "+a)}}),d3.select("#nvd3chart_"+t.uid+"  svg").datum(o).transition().duration(t.options.state.timing||500).call(t.chart),nv.utils.windowResize(t.graphResize),t.trigger("chart:endDrawing"),t.chart})},graphResize:function(){var t=this,n=this.uid,r=t.el;while(!r.hasClass("container-fluid")&&!r.hasClass("container")&&r.length)r=r.parent();if(typeof r!="undefined"&&r!=null&&(r.hasClass("container")||r.hasClass("container-fluid"))&&r[0].style&&r[0].style.height&&r[0].style.height.indexOf("%")>0){e("body").height(e(window).innerHeight()-10);var i=t.el;while(!i.hasClass("row-fluid")&&!i.hasClass("row"))i=i.parent();if(typeof i!="undefined"&&i!=null&&(i.hasClass("row-fluid")||i.hasClass("row"))){var s=i.height();e("#nvd3chart_"+n).height(s),e("#nvd3chart_"+n+"  svg").height(s)}}t.chart&&t.chart.update&&t.chart.update()},setAxis:function(e,t){var n=this,r=n.state.get("xLabel");if(e=="all"||e=="x"){var i=function(e){return e};if(n.state.get("graphType").indexOf("Horizontal")<0){var s=n.model.fields.get(n.state.attributes.group);i=n.state.get("tickFormatX")||n.getFormatter(s.get("type"));if(r==null||r==""||typeof r=="undefined")r=s.get("label")}else r=n.state.get("yLabel"),n.state.get("tickFormatY")&&(i=n.state.get("tickFormatY"));t.xAxis.axisLabel(r).tickFormat(i)}if(e=="all"||e=="y"){var o=n.state.get("yLabel"),u=function(e){return e};if(n.state.get("graphType").indexOf("Horizontal")>=0){var a=n.model.fields.get(n.state.attributes.group);u=n.state.get("tickFormatX")||n.getFormatter(a.get("type")),o=n.state.get("xLabel")}else{n.state.get("tickFormatY")&&(u=n.state.get("tickFormatY"));if(o==null||o==""||typeof o=="undefined")o=n.state.attributes.seriesValues.join("/")}t.yAxis.axisLabel(o).tickFormat(u)}},getFormatter:function(e){var t=this;switch(e){case"string":return d3.format(",s");case"float":return d3.format(",r");case"integer":return d3.format(",r");case"date":return d3.time.format("%x")}},addOption:{staggerLabels:function(e,t){e.staggerLabels(t)},tooltips:function(e,t){e.tooltips(t)},showValues:function(e,t){e.showValues(t)},tooltip:function(e,t){var n=function(e,n,r,i,s){return t.replace("{x}",n).replace("{y}",r).replace("{key}",e)};e.tooltip(n)},minmax:function(e,t){},trendlines:function(e,t){},showLegend:function(e,t){e.showLegend(t)},showControls:function(e,t){e.showControls&&e.showControls(t)},showMaxMin:function(e,t){e.showMaxMin(t)},showValues:function(e,t){e.showValues(t)},customTooltips:function(e,t){},stacked:function(e,t){e.stacked(t)},grouped:function(e,t){e.stacked(!t)},margin:function(e,t){e.margin(t)}},getGraph:{multiBarChart:function(e){var t;e.chart!=null?t=e.chart:t=nv.models.multiBarChart(),e.setAxis(e.options.state.axisTitlePresent||"all",t);var n=e.getActionsForEvent("selection");n.length>0&&t.multibar.dispatch.on("elementClick",function(t){e.doActions(n,[t.point.record])});var r=e.getActionsForEvent("hover");return r.length>0&&t.multibar.dispatch.on("elementMouseover",function(t){e.doActions(r,[t.point.record])}),t},lineChart:function(e){var t;e.chart!=null?t=e.chart:t=nv.models.lineChart(),e.setAxis(e.options.state.axisTitlePresent||"all",t);var n=e.getActionsForEvent("selection");n.length>0&&t.lines.dispatch.on("elementClick",function(t){e.doActions(n,[t.point.record])});var r=e.getActionsForEvent("hover");return r.length>0&&t.lines.dispatch.on("elementMouseover",function(t){e.doActions(r,[t.point.record])}),t},lineDottedChart:function(e){var t;e.chart!=null?t=e.chart:t=nv.models.lineDottedChart(),e.setAxis(e.options.state.axisTitlePresent||"all",t);var n=e.getActionsForEvent("selection");n.length>0&&t.lines.dispatch.on("elementClick",function(t){e.doActions(n,[t.point.record])});var r=e.getActionsForEvent("hover");return r.length>0&&t.lines.dispatch.on("elementMouseover",function(t){e.doActions(r,[t.point.record])}),t},lineWithFocusChart:function(e){var t;e.chart!=null?t=e.chart:t=nv.models.lineWithFocusChart(),e.setAxis(e.options.state.axisTitlePresent||"all",t);var n=e.getActionsForEvent("selection");n.length>0&&t.lines.dispatch.on("elementClick",function(t){e.doActions(n,[t.point.record])});var r=e.getActionsForEvent("hover");return r.length>0&&t.lines.dispatch.on("elementMouseover",function(t){e.doActions(r,[t.point.record])}),t},indentedTree:function(e){var t;e.chart!=null?t=e.chart:t=nv.models.indentedTree()},stackedAreaChart:function(e){var t;e.chart!=null?t=e.chart:t=nv.models.stackedAreaChart(),e.setAxis(e.options.state.axisTitlePresent||"all",t);var n=e.getActionsForEvent("selection");n.length>0&&t.stacked.dispatch.on("elementClick",function(t){e.doActions(n,[t.point.record])});var r=e.getActionsForEvent("hover");return r.length>0&&t.stacked.dispatch.on("elementMouseover",function(t){e.doActions(r,[t.point.record])}),t},historicalBar:function(e){var t;return e.chart!=null?t=e.chart:t=nv.models.historicalBar(),t},multiBarHorizontalChart:function(e){var t;e.chart!=null?t=e.chart:t=nv.models.multiBarHorizontalChart(),e.setAxis(e.options.state.axisTitlePresent||"all",t);var n=e.getActionsForEvent("selection");n.length>0&&t.multibar.dispatch.on("elementClick",function(t){e.doActions(n,[t.point.record])});var r=e.getActionsForEvent("hover");return r.length>0&&t.multibar.dispatch.on("elementMouseover",function(t){e.doActions(r,[t.point.record])}),t},legend:function(e){var t;return e.chart!=null?t=e.chart:t=nv.models.legend(),t},line:function(e){var t;return e.chart!=null?t=e.chart:t=nv.models.line(),t},sparkline:function(e){var t;return e.chart!=null?t=e.chart:t=nv.models.sparkline(),t},sparklinePlus:function(e){var t;return e.chart!=null?t=e.chart:t=nv.models.sparklinePlus(),t},multiChart:function(e){var t;return e.chart!=null?t=e.chart:t=nv.models.multiChart(),t},bulletChart:function(e){var t;return e.chart!=null?t=e.chart:t=nv.models.bulletChart(),t},linePlusBarChart:function(e){var t;return e.chart!=null?t=e.chart:t=nv.models.linePlusBarChart(),e.setAxis(e.options.state.axisTitlePresent||"all",t),t},cumulativeLineChart:function(e){var t;return e.chart!=null?t=e.chart:t=nv.models.cumulativeLineChart(),e.setAxis(e.options.state.axisTitlePresent||"all",t),t},scatterChart:function(e){var t;e.chart!=null?t=e.chart:t=nv.models.scatterChart(),t.showDistX(!0).showDistY(!0),e.setAxis(e.options.state.axisTitlePresent||"all",t);var n=e.getActionsForEvent("selection");n.length>0&&t.scatter.dispatch.on("elementClick",function(t){e.doActions(n,[t.point.record])});var r=e.getActionsForEvent("hover");return r.length>0&&t.scatter.dispatch.on("elementMouseover",function(t){e.doActions(r,[t.point.record])}),t},discreteBarChart:function(e){var t=e.getActionsForEvent("selection"),n;e.chart!=null?n=e.chart:n=nv.models.discreteBarChart(),e.setAxis(e.options.state.axisTitlePresent||"all",n),t.length>0&&n.discretebar.dispatch.on("elementClick",function(n){e.doActions(t,[n.point.record])});return n;var r},lineWithBrushChart:function(e){var t;return e.chart!=null?t=e.chart:t=nv.models.lineWithBrushChart(options),e.setAxis(e.options.state.axisTitlePresent||"all",t),t},multiBarWithBrushChart:function(e){var t=e.getActionsForEvent("selection"),n={};e.state.attributes.options&&(e.state.attributes.options.trendlines&&(n.trendlines=e.state.attributes.options("trendlines")),e.state.attributes.options.minmax&&(n.minmax=e.state.attributes.options("minmax"))),t.length>0?n.callback=function(n){var r=n[0][0].record,i=n[0][n[0].length-1].record;e.doActions(t,[r,i])}:n.callback=function(){};var r;return e.chart!=null?r=e.chart:r=nv.models.multiBarWithBrushChart(n),r},pieChart:function(e){var t;e.chart!=null?t=e.chart:t=nv.models.pieChart(),t.values(function(e){var t=[];return _.each(e.values,function(e){t.push({x:e.x,y:e.y})}),t});var n=e.getActionsForEvent("selection");n.length>0&&t.pie.dispatch.on("elementClick",function(t){e.doActions(n,[t.point.record])});var r=e.getActionsForEvent("hover");return r.length>0&&t.pie.dispatch.on("elementMouseover",function(t){e.doActions(r,[t.point.record])}),t}},getGraphModel:function(e,t){switch(t){case"historicalBar":case"multiBarChart":case"multiBarWithBrushChart":case"multiBarHorizontalChart":return e.chart.multibar;case"lineChart":case"lineDottedChart":case"lineWithFocusChart":case"linePlusBarChart":case"cumulativeLineChart":case"lineWithBrushChart":return e.chart.lines;case"bulletChart":return e.chart.bullet;case"scatterChart":return e.chart.scatter;case"stackedAreaChart":return e.chart.stacked;case"pieChart":return e.chart.pie;case"discreteBarChart":return e.chart.discretebar}},doActions:function(e,t){_.each(e,function(e){e.action.doAction(t,e.mapping)})},getFieldLabel:function(e){var t=this,n=e.attributes.label;e.attributes.is_partitioned&&(n=e.attributes.partitionValue);if(typeof t.state.attributes.fieldLabels!="undefined"&&t.state.attributes.fieldLabels!=null){var r=_.find(t.state.attributes.fieldLabels,function(e){return e.id==n});typeof r!="undefined"&&r!=null&&(n=r.label)}return n}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.Rickshaw=Backbone.View.extend({template:'<div id="{{uid}}"> <div> ',initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.listenTo(this.model.records,"add",this.addRecords),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=t.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.options=t},render:function(){console.log("View.Rickshaw: render");var e=this,t="#"+this.uid;e.graph&&(jQuery(t).empty(),delete e.graph);var n=Mustache.render(this.template,this);this.el.html(n)},redraw:function(){var e=this;console.log("View.Rickshaw: redraw"),e.graph?e.updateGraph():e.renderGraph()},updateGraph:function(){var e=this;e.createSeries(),e.graph.update()},convertDateValueWithoutMillis:function(e){return Math.round(e.valueOf()/1e3)},renderGraph:function(){var e=this;this.graphOptions={element:document.querySelector("#"+this.uid),width:e.options.width,height:e.options.height},e.graphOptions=_.extend(e.graphOptions,e.options.state.options);var t="filtered";e.options.resultType!==null&&(t=e.options.resultType);var n=e.model.getRecords(t);e.series?e.series.length=0:e.series=[];var r=e.series;e.createSeries(n,r);if(e.series.length==0)return;e.graphOptions.series=e.series,e.graph=new Rickshaw.Graph(e.graphOptions),e.options.state.unstack&&(e.graph.renderer.unstack=!0),e.graph.render();var i={graph:e.graph};i=_.extend(i,e.options.state.hoverDetailOpt);var s=new Rickshaw.Graph.HoverDetail(i),o={graph:e.graph};o=_.extend(o,e.options.state.xAxisOptions);var u=new Rickshaw.Graph.Axis.Time(o);u.render();var a=new Rickshaw.Graph.Axis.Y({graph:e.graph});a.render();if(e.options.state.events){e.annotator=new Rickshaw.Graph.Annotate({graph:e.graph,element:document.getElementById(e.options.state.events.div||"timeline")});var f=e.options.state.events.timeField,l=e.options.state.events.valueField,c=e.options.state.events.endField;_.each(e.options.state.events.dataset.getRecords(e.options.state.events.resultType),function(t){c?e.annotator.add(e.convertDateValueWithoutMillis(t.attributes[f]),t.attributes[l],e.convertDateValueWithoutMillis(t.attributes[c])):e.annotator.add(e.convertDateValueWithoutMillis(t.attributes[f]),t.attributes[l])}),e.annotator.update()}if(e.options.state.legend)var h=new Rickshaw.Graph.Legend({graph:e.graph,element:document.querySelector("#"+e.options.state.legend)}),p=new Rickshaw.Graph.Behavior.Series.Toggle({graph:e.graph,legend:h}),d=new Rickshaw.Graph.Behavior.Series.Order({graph:e.graph,legend:h}),v=new Rickshaw.Graph.Behavior.Series.Highlight({graph:e.graph,legend:h})},addRecords:function(e){var t=this,n=[];this.createSeries([e],n),_.each(n,function(e,n){_.each(e.data,function(e){t.series[n].data.push(e)})}),t.graph.update()},createSeries:function(e,t){var n=this,r=this.options.state.series,i=r.fillEmptyValuesWith,s="#C0C0C0";n.options.state.unselectedColor&&(s=n.options.state.unselectedColor);var o=!1;n.model.queryState.isSelected()&&(o=!0);var u=n.model.fields.get(n.options.state.group),a=[],f;r.sizeField&&(f=n.model.fields.get(r.sizeField));if(r.type=="byFieldValue"){var l={},c=n.model.fields.get(r.seriesField),h=n.model.fields.get(r.valuesField);if(!h)throw"view.rickshaw: unable to find field ["+r.valuesField+"] in model";_.each(e,function(e,t){var n=e.getFieldValueUnrendered(c),r;if(l[n]!=null)r=l[n];else{r={name:n,data:[],field:h};var s=e.getFieldColor(c);s!=null&&(r.color=s)}var o=e.getFieldShapeName(c),p;u.attributes.type=="date"?p=Math.floor(e.getFieldValueUnrendered(u)/1e3):p=e.getFieldValueUnrendered(u);var d=e.getFieldValue(u),v=e.getFieldValueUnrendered(h),m=e.getFieldValue(h);if(v&&!isNaN(v)){var g={x:p,y:v,record:e,y_formatted:m,x_formatted:d};f&&(g.size=e.getFieldValueUnrendered(f)),o!=null&&(g.shape=o),r.data.push(g),i!=null&&a.push(p),l[n]=r}});for(var p in l)t.push(l[p])}else{if(r.type!="byFieldName"&&r.type!="byPartitionedField")throw"views.rickshaw.graph.js: unsupported or not defined type "+r.type;var d;r.type=="byFieldName"?d=r.valuesField:(d=[],_.each(r.aggregationFunctions,function(e){_.each(n.model.getPartitionedFieldsForAggregationFunction(e,r.aggregatedField),function(e){d.push(e.get("id"))})})),_.each(d,function(l){var c;r.type=="byFieldName"&&l.fieldName?c=n.model.fields.get(l.fieldName):c=n.model.fields.get(l);var h;l.fieldColor&&(h=l.fieldColor);var p=[];_.each(e,function(e,t){var n;u.attributes.type=="date"?n=Math.floor(e.getFieldValueUnrendered(u)/1e3):n=e.getFieldValueUnrendered(u);var r=e.getFieldValue(u);try{var l=e.getFieldValueUnrendered(c),h=e.getFieldValue(c);if(l!=null&&!isNaN(l)){var d,v=e.getFieldColor(c);o?e.isRecordSelected()?d=v:d=s:d=v;var m=e.getFieldShapeName(c),g={x:n,y:l,record:e,y_formatted:h,x_formatted:r};d!=null&&(g.color=d),m!=null&&(g.shape=m),f&&(g.size=e.getFieldValueUnrendered(f)),p.push(g),i!=null&&a.push(n)}}catch(y){}});if(p.length>0){var d;h?d=h:d=c.getColorForPartition();var v={data:p,name:n.getFieldLabel(c)};d&&(v.color=d),t.push(v)}})}i!=null&&(a=_.unique(a),_.each(t,function(e){var t=_.map(e.data,function(e){return e.x});_.each(_.difference(a,t),function(t){e.data.push({x:t,y:i})})}))},getFieldLabel:function(e){var t=this,n=e.attributes.label;e.attributes.is_partitioned&&(n=e.attributes.partitionValue);if(typeof t.options.state.fieldLabels!="undefined"&&t.options.state.fieldLabels!=null){var r=_.find(t.state.attributes.fieldLabels,function(e){return e.id==n});typeof r!="undefined"&&r!=null&&(n=r.label)}return n}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.SaveCSV=Backbone.View.extend({template:'<a id="{{uid}}" style="text-decoration: none;cursor: pointer;"><i class="icon-download" title="Download as csv file"></i></a>',id:"save",initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.records.bind("reset",this.render),this.model.queryState.bind("selection:done",this.render),this.uid=t.id||"save_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.options=t},initialize:function(t){this.el=e(this.el)},updateState:function(e){var t=this;t.options.visibleColumns=e.visibleColumns},render:function(){var e=this,t=function(){var t=[],n=e.model.records,r=[];_.each(e.options.visibleColumns,function(t){t.indexOf("_sum",t.length-"_sum".length)!==-1&&(t=t.substring(0,t.length-4));if(e.options.fieldLabels){var n=_.find(e.options.fieldLabels,function(e){return e.id==t});n?r.push(n.label):r.push(t)}else r.push(t)}),t.push(r),_.each(n.models,function(n){var r=[];_.each(e.options.visibleColumns,function(e){r.push(n.getFieldValueUnrendered(n.fields.get(e)))}),t.push(r)});var i="",s="";for(var o=0;o<t.length;o++){var s="";for(var u in t[o]){var a=t[o][u]+"";s+='"'+a.replace(/"/g,'""')+'",'}s=s.slice(0,-1),i+=s+"\r\n"}saveAs(new Blob([i],{type:"text/plain;charset="+document.characterSet}),"data.csv")},n=Mustache.render(this.template,e);this.el.off("click"),this.el.click(function(){return t()}),this.el.html(n)}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.SlickGridGraph=Backbone.View.extend({initialize:function(t){var n=this;this.el=e(this.el),this.discardSelectionEvents=!1,this.el.addClass("recline-slickgrid"),_.bindAll(this,"render"),_.bindAll(this,"onSelectionChanged"),_.bindAll(this,"handleRequestOfRowSelection"),this.resultType="filtered",n.options.resultType!==null&&(this.resultType=n.options.resultType),this.model.records.bind("add",this.render),this.model.records.bind("reset",this.render),this.model.records.bind("remove",this.render),this.model.queryState.bind("selection:done",this.handleRequestOfRowSelection);var r=_.extend({hiddenColumns:[],visibleColumns:[],columnsOrder:[],columnsSort:{},columnsWidth:[],fitColumns:!1},t.state);this.state=new recline.Model.ObjectState(r)},events:{},render:function(){function t(e){return isFinite(e)&&e}function n(e){return!isFinite(e)||e==0}function at(){if(e.model.getRecords(e.resultType).length>0){var t=e.el.parent();typeof t!="undefined"&&t!=null&&(t[0].style&&t[0].style.height&&t[0].style.height.indexOf("%")>0||t.hasClass("h100"))&&(e.el.height(e.el.parent()[0].offsetHeight),e.grid.invalidateAllRows(),e.grid.resizeCanvas(),e.grid.render())}}var e=this,r={enableCellNavigation:!0,enableColumnReorder:!0,enableExpandCollapse:!0,explicitInitialization:!0,syncColumnCellResize:!0,forceFitColumns:this.state.get("fitColumns"),useInnerChart:t(this.state.get("useInnerChart"))&&n(this.state.get("hideInnerChartScale")),innerChartMax:this.state.get("innerChartMax"),innerChartSerie2Name:this.state.get("innerChartSerie2"),useStripedStyle:this.state.get("useStripedStyle"),useCondensedStyle:this.state.get("useCondensedStyle"),useHoverStyle:this.state.get("useHoverStyle"),showLineNumbers:this.state.get("showLineNumbers"),showTotals:this.state.get("showTotals"),showPartitionedData:this.state.get("showPartitionedData"),selectedCellFocus:this.state.get("selectedCellFocus"),customHtmlFormatters:this.state.get("customHtmlFormatters"),fieldFormatters:this.state.get("fieldFormatters"),onSelection:this.state.get("onSelection")},i=[],s=function(t,n,r,i,s){var o=e.model.getFields(e.resultType).get(i.id);return o.renderer?o.renderer(r,o,s):r},o=e.model.getRecords(e.resultType);if(r.showLineNumbers==1&&o.length>0){var u={id:"lineNumberField",name:"",field:"lineNumberField",sortable:r.showPartitionedData?!1:!0,maxWidth:40,formatter:Slick.Formatters.FixedCellFormatter};i.push(u)}var a=[],f=this.state.get("columnsOrder");if(r.showPartitionedData){var l=function(e){if(e&&e.constructor&&e.constructor.toString){var t=e.constructor.toString().match(/function\s*(\w+)/);if(t&&t.length==2)return t[1]}return undefined};if(l(e.model)!="VirtualDataset")throw"Slickgrid exception: showPartitionedData option can only be used on a partitioned virtualmodel! Exiting";var c=r.showPartitionedData.measures[0].field,h=r.showPartitionedData.partition,p=e.model.getPartitionedFields(h,c),d=p[0].id;a=e.model.attributes.aggregation.dimensions.concat([r.showPartitionedData.partition]).concat(_.map(r.showPartitionedData.measures,function(e){return e.field+"_"+e.aggregation}));var v=e.model.attributes.aggregation.dimensions.concat([d]).concat(_.map(r.showPartitionedData.measures,function(e){return e.field+"_"+e.aggregation})),m=this.state.get("columnsOrder");if(typeof m=="undefined"||m==null||m.length==0)f=v;var g={id:d,name:r.showPartitionedData.partition,field:r.showPartitionedData.partition,sortable:!1,minWidth:80,formatter:s},y=_.find(e.state.get("columnsWidth"),function(e){return e.column==field.id});y&&(u.width=y.width),i.push(g)}_.each(e.model.getFields(e.resultType).toJSON(),function(t){var n=s;if(r.customHtmlFormatters&&!r.showPartitionedData){var o=_.find(r.customHtmlFormatters,function(e){return e.id==t.id});o&&(n=o.formula?Slick.Formatters.HtmlExtFormatter:Slick.Formatters.HtmlFormatter)}var u="";if(r.fieldFormatters){var f=_.find(r.fieldFormatters,function(e){return e.id==t.id});f&&(u=f.cssClass)}var l={id:t.id,name:t.label,field:t.id,cssClass:u,sortable:r.showPartitionedData?!1:!0,minWidth:80,formatter:n};e.model.queryState.attributes.sort&&_.each(e.model.queryState.attributes.sort,function(e){l.sortable&&t["id"]==e.field&&(l.sorted=e.order)});var c=_.find(e.state.get("columnsWidth"),function(e){return e.column==t.id});c&&(l.width=c.width),r.showPartitionedData?(_.contains(a,t.id)||t["id"]==d&&t["field"]==r.showPartitionedData.partition)&&i.push(l):i.push(l)});var b=e.state.get("innerChartSerie1"),w=e.state.get("innerChartSerie2");r.useInnerChart==1&&o.length>0&&i.push({name:e.state.get("innerChartHeader"),id:"innerChart",field:"innerChart",sortable:!1,alignLeft:!0,minWidth:150,formatter:b&&w?Slick.Formatters.TwinBarFormatter:Slick.Formatters.PercentCompleteBar}),e.state.get("fieldLabels")&&e.state.get("fieldLabels").length>0&&_.each(e.state.get("fieldLabels"),function(e){for(var t in i)i[t].id==e.id&&(i[t].name=e.label)});var E=[];e.state.get("visibleColumns").length>0?(E=i.filter(function(t){return _.indexOf(e.state.get("visibleColumns"),t.id)>=0||r.showLineNumbers==1&&t.id=="lineNumberField"}),e.state.get("useInnerChart")==1&&o.length>0&&E.push(i[i.length-1])):E=i.filter(function(t){return _.indexOf(e.state.get("hiddenColumns"),t.id)==-1}),f&&(E=E.sort(function(e,t){var n=_.indexOf(f,e.id),r=_.indexOf(f,t.id);return n>=0&&r>=0?n>r?1:-1:e.id=="innerChart"||t.id=="lineNumberField"?1:t.id=="innerChart"||e.id=="lineNumberField"?-1:n<r?1:-1}),i=i.sort(function(e,t){return _.indexOf(f,e.id)>_.indexOf(f,t.id)?1:-1}));var S=[];for(var x=i.length-1;x>=0;x--)_.indexOf(_.pluck
(E,"id"),i[x].id)==-1&&S.push(i.splice(x,1)[0]);i=i.concat(S);var T=0,N=function(e){var t=""+parseInt(e),n=t.length;if(n<=1)return 10;var r=parseInt(t.charAt(0)),i=parseInt(t.charAt(1));return i<5?(r+.5)*Math.pow(10,n-1):(r+1)*Math.pow(10,n-1)};e.state.get("useInnerChart")==1&&b&&o.length>0&&(_.each(o,function(t){var n={};_.each(e.model.getFields(e.resultType).models,function(e){n[e.id]=t.getFieldValueUnrendered(e);if(e.id==b||e.id==w){var r=Math.abs(parseFloat(n[e.id]));r>T&&(T=r)}})}),w&&(T=N(T)),r.innerChartMax=T);var C=[],k=[],L=[],A=0;if(r.showPartitionedData){var h=r.showPartitionedData.partition,O=e.model.attributes.aggregation.dimensions,M=o,D=[];for(var P in O){var H=O[P],B=_.map(M,function(e){return e.attributes[H]});D[P]=_.uniq(B)}var c=r.showPartitionedData.measures[0].field,p=e.model.getPartitionedFields(h,c),j=_.map(p,function(e){return e.attributes.partitionValue}),F=_.uniq(j),I={},q=!1;O.length==1&&(q=!0,D[1]=[""],O[1]="___fake____");for(var R in D[0]){I={};var U=O[0];for(var z in D[1]){I={};var W=O[1],X=_.find(M,function(e){return e.attributes[U]==D[0][R]&&(q||e.attributes[W]==D[1][z])});for(var V in F){I={},z==0&&V==0&&(I[U]=D[0][R]),V==0&&(I[W]=D[1][z]),I[h]=F[V];for(var $ in r.showPartitionedData.measures){var J=r.showPartitionedData.measures[$],K=J.field,Q=e.model.getPartitionedFields(h,K),G=_.find(Q,function(e){return e.attributes.partitionValue==F[V]});if(G)if(X){var Y=X.getFieldValueUnrendered(G);Y?I[K+"_"+J.aggregation]=X.getFieldValueUnrendered(G):I[K+"_"+J.aggregation]=0}else I[K+"_"+J.aggregation]=0}r.showLineNumbers==1&&(I.lineNumberField=A),I.rowNumber=A,I.__orig_record__=X,C.push(I)}if(r.showPartitionedData.showSubTotals){I={},I[h]="<b>Total(s)</b>";for(var $ in r.showPartitionedData.measures){var J=r.showPartitionedData.measures[$],K=J.field+"_"+J.aggregation,G=_.find(e.model.getFields(e.resultType).models,function(e){return e.attributes.id==K});if(G&&X){var Y=X.getFieldValueUnrendered(G);Y?I[K]="<b>"+X.getFieldValueUnrendered(G)+"</b>":I[K]="<b>0</b>"}else I[K]="<b>0</b>"}L.push(C.length),C.push(I)}}}}else _.each(o,function(t){t.is_selected&&k.push(A);var n={schema_colors:[]};_.each(e.model.getFields(e.resultType).models,function(e){n[e.id]=t.getFieldValueUnrendered(e),b&&e.id==b&&(n.schema_colors[0]=t.getFieldColor(e)||"blue"),w&&e.id==w&&(n.schema_colors[1]=t.getFieldColor(e)||"red")}),e.state.get("useInnerChart")==1&&b&&(w?n.innerChart=[n[b],n[w],T]:n.innerChart=[n[b],T]),r.customHtmlFormatters&&_.each(r.customHtmlFormatters,function(e){e.formula?n[e.id]=[t,e.formula]:n[e.id]=[t.attributes,e.template]}),C.push(n),A++,r.showLineNumbers==1&&(n.lineNumberField=A),n.rowNumber=A,n.__orig_record__=t});if(r.showTotals&&o.length>0){r.totals={};if(e.model.getField_byAggregationFunction){var Z=e.model.getRecords("totals");for(var et in r.showTotals){var tt=r.showTotals[et],nt=e.model.getField_byAggregationFunction("totals"+(tt.filtered?"_filtered":""),tt.field,tt.aggregation);typeof nt!="undefined"&&(r.totals[tt.field]=Z[0].getFieldValueUnrendered(nt))}}else for(var et in r.showTotals){var tt=r.showTotals[et],rt=0;for(var A in o)rt+=o[A].attributes[tt.field];var nt=e.model.fields.get(tt.field),it=o[0].attributes[tt.field];tt.aggregation=="sum"?o[0].attributes[tt.field]=rt:tt.aggregation=="avg"&&(o[0].attributes[tt.field]=rt/o.length),r.totals[tt.field]=o[0].getFieldValue(nt),tt.align&&(r.totals[tt.field]="<div style='text-align:"+tt.align+"'>"+r.totals[tt.field]+"</div>"),o[0].attributes[tt.field]=it}}this.options.actions!=null&&typeof this.options.actions!="undefined"&&_.each(this.options.actions,function(e){_.indexOf(e.event,"hover")>=0&&(r.trackMouseHover=!0)}),C.getItemMetadata=function(e){if(_.contains(L,e))return{selectable:!1}},this.grid=new Slick.Grid(this.el,C,E,r);var st=["s-table"];r.useHoverStyle&&st.push("s-table-hover"),r.useCondensedStyle&&st.push("s-table-condensed"),r.useStripedStyle&&st.push("s-table-striped"),this.grid.addClassesToGrid(st),this.grid.removeClassesFromGrid(["ui-widget"]),this.grid.setSelectionModel(new Slick.RowSelectionModel);var ot=[];_.each(e.model.queryState.attributes.sort,function(e){ot.push({columnId:e.field,sortAsc:e.order=="asc"})}),this.grid.setSortColumns(ot),this.grid.onSelectedRowsChanged.subscribe(function(t,n){e.discardSelectionEvents||e.onSelectionChanged(n.rows),e.discardSelectionEvents=!1}),this.grid.onSort.subscribe(function(t,n){var r=n.sortAsc?"asc":"desc";n.sortCol.sorted&&(n.sortCol.sorted=="asc"&&(r="desc"),n.sortCol.sorted=="desc"&&(r="asc"));var i=[{field:n.sortCol.field,order:r}];e.model.query({sort:i})}),this.grid.onColumnsReordered.subscribe(function(t,n){e.state.set({columnsOrder:_.pluck(e.grid.getColumns(),"id")})}),this.grid.onColumnsResized.subscribe(function(t,n){var r=n.grid.getColumns(),i=n.grid.getOptions().defaultColumnWidth,s=[];_.each(r,function(e){e.width!=i&&s.push({column:e.id,width:e.width})}),e.state.set({columnsWidth:s})}),this.grid.onRowHoverIn.subscribe(function(t,n){var r=[];r.push(e.model.records.models[n.row]);var i=e.options.actions;i.forEach(function(e){e.action.doAction(r,e.mapping)})});var ut=new Slick.Controls.ColumnPicker(i,this.grid,_.extend(r,{state:this.state}));return e.visible?(e.grid.init(),e.rendered=!0):e.rendered=!1,at(),this.handleRequestOfRowSelection(),this},handleRequestOfRowSelection:function(){this.discardSelectionEvents=!0;var e=[],t=this.model.getRecords(this.resultType),n=null;for(row in t)if(t[row].is_selected){e.push(row);if(!n||row<n)n=row}this.grid.getSelectionModel().setSelectedRows(e),n&&this.options.state&&this.options.state.selectedCellFocus&&this.grid.scrollRowToTop(n)},onSelectionChanged:function(e){var t=this,n=[];_.each(e,function(e){var r=t.grid.getDataItem(e);n.push(r.__orig_record__),r.__orig_record__.is_selected=!0});var r=this.options.actions;r!=null&&r.forEach(function(e){e.action.doAction(n,e.mapping)}),this.options.onSelection&&this.options.onSelection()},show:function(){this.rendered||(this.grid||this.render(),this.grid.init(),this.rendered=!0),this.visible=!0},hide:function(){this.visible=!1}})}(jQuery,recline.View),function(e){function t(t,n,r){function u(){n.onHeaderContextMenu.subscribe(a),r=e.extend({},o,r),i=e('<ul class="dropdown-menu slick-contextmenu" style="display:none;position:absolute;z-index:20;" />').appendTo(document.body),i.bind("mouseleave",function(t){e(this).fadeOut(r.fadeSpeed)}),i.bind("click",f)}function a(o,u){o.preventDefault(),i.empty(),s=[];var a,f;for(var l=0;l<t.length;l++){var c=t[l].id;c.indexOf("ratioToReport")==-1&&c.indexOf("ratioToMax")==-1&&c.indexOf("dimension")==-1&&c.indexOf("count")==-1&&(a=e("<li />").appendTo(i),f=e('<input type="checkbox" />').data("column-id",t[l].id).attr("id","slick-column-vis-"+t[l].id).attr("style","float:left"),s.push(f),n.getColumnIndex(t[l].id)!=null&&f.attr("checked","checked"),f.appendTo(a),e("<label />").text(t[l].name).attr("for","slick-column-vis-"+t[l].id).attr("style","float:left;margin:0").appendTo(a),e("<br/>").appendTo(a))}e("<li/>").addClass("divider").appendTo(i),a=e("<li />").data("option","autoresize").appendTo(i),f=e('<input type="checkbox" />').data("option","autoresize").attr("id","slick-option-autoresize").attr("style","float:left"),f.appendTo(a),e("<label />").text("Force fit columns").attr("for","slick-option-autoresize").attr("style","float:left;margin:0").appendTo(a),n.getOptions().forceFitColumns&&f.attr("checked","checked"),i.css("top",o.pageY-10).css("left",o.pageX-10).fadeIn(r.fadeSpeed)}function f(i){if(e(i.target).data("option")=="autoresize"){var o;if(e(i.target).is("li")){var u=e(i.target).find("input").first();o=!u.is(":checked"),u.attr("checked",o)}else o=i.target.checked;o?(n.setOptions({forceFitColumns:!0}),n.autosizeColumns()):n.setOptions({forceFitColumns:!1}),r.state.set({fitColumns:o});return}if(e(i.target).is("li")&&!e(i.target).hasClass("divider")||e(i.target).is("input")){if(e(i.target).is("li")){var u=e(i.target).find("input").first();u.attr("checked",!u.is(":checked"))}var a=[],f=[];e.each(s,function(n,r){e(this).is(":checked")?a.push(t[n]):f.push(t[n].id)});if(!a.length){e(i.target).attr("checked","checked");return}n.setColumns(a),r.state.set({hiddenColumns:f})}}var i,s,o={fadeSpeed:250};u()}e.extend(!0,window,{Slick:{Controls:{ColumnPicker:t}}})}(jQuery),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.xCharts=Backbone.View.extend({template:'<figure style="clear:both; width: {{width}}px; height: {{height}}px;" id="{{uid}}"></figure><div class="xCharts-title-x" style="width:{{width}}px;text-align:center;margin-left:50px">{{xAxisTitle}}</div>',initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=t.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.options=t,this.height=t.state.height,this.width=t.state.width,this.xAxisTitle=t.state.xAxisTitle,this.yAxisTitle=t.state.yAxisTitle,t.state.loader&&t.state.loader.bindChart(this),t.state.widths&&(this.widths=t.state.widths);if(t.state.opts==null||typeof t.state.opts=="undefined")t.state.opts={}},render:function(e){isNaN(e)||(this.width=e);var t=this;t.trigger("chart:startDrawing");var n="#"+this.uid,r=Mustache.render(this.template,this);this.el.html(r),t.trigger("chart:endDrawing")},redraw:function(){var e=this;e.trigger("chart:startDrawing"),e.renderGraph(),e.trigger("chart:endDrawing")},updateGraph:function(){var t=this;if(this.model.recordCount){t.updateSeries();if(t.series.main&&t.series.main.length&&t.series.main[0].data&&t.series.main[0].data.length){this.el.find("figure div.noData").remove(),this.el.find("div.xCharts-title-x").html(t.options.state.xAxisTitle);var n=t.options.state;t.updateState(n),t.graph._options=n.opts,t.graph.setData(t.series),t.updateOptions(),t.graph.setType(n.type),n.legend&&t.createLegend()}else{var r="#"+this.uid;t.graph&&(d3.select(window).on("resize.for."+r,null),e(r).off(),e(r).empty(),delete t.graph),this.el.find("figure").html(""),this.el.find("figure").append((new recline.View.NoDataMsg).create()),this.el.find("div.xCharts-title-x").html(""),t.graph=null}}},updateState:function(t){var n=this;n.options.state.yAxisTitle&&(t.opts.paddingLeft=90);if(t.useAnnotations){var r=function(t){var r=-(e("html").css("padding-left").replace("px","")+e("body").css("margin-left").replace("px",""))+10,i=-5,s=e(this).offset(),o='<div class="moda_tooltip annotation-description">'+t.text+"</div>",u=i+s.top;u<0&&(u=-u),nv.tooltip.show([s.left+r,i+s.top],o,s.left<n.el[0].offsetLeft+n.el.width()/2?"w":"e",null,n.el[0])},i=function(){nv.tooltip.cleanup()};t.opts.mouseoverAnnotation=r,t.opts.mouseoutAnnotation=i}},updateOptions:function(){var e=this;this.el.find("div.xCharts-title-x").html(e.options.state.xAxisTitle);if(e.options.state.yAxisTitle){var t=e.graph._height+e.graph._options.axisPaddingTop+e.graph._options.axisPaddingBottom;e.graph._g.selectAll("g.axisY g.titleY").data([e.options.state.yAxisTitle]).enter().append("g").attr("class","titleY").attr("transform","translate(-60,"+t/2+") rotate(-90)").append("text").attr("x",-3).attr("y",0).attr("dy",".32em").attr("text-anchor","middle").text(function(e){return e})}},changeDataset:function(e){_.bindAll(this,"render","redraw"),this.model.unbind(),this.model=e,this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw)},renderGraph:function(){var t=this,n=t.options.state;if(this.model.recordCount){t.updateSeries(),n.legend&&t.createLegend();if(t.series.main&&t.series.main.length&&t.series.main[0].data&&t.series.main[0].data.length)t.el.find("figure div.noData").remove(),t.el.find("figure svg g").remove(),t.updateState(n),n.interpolation&&(n.opts.interpolation=n.interpolation),n.type=="line-dotted"&&n.dotRadius&&(n.opts.dotRadius=n.dotRadius),t.graph=new xChart(n.type,t.series,"#"+t.uid,n.opts),n.timing!=null&&typeof n.timing!="undefined"&&(t.graph._options.timing=n.timing),t.updateOptions();else{var r="#"+this.uid;t.graph&&(d3.select(window).on("resize.for."+r,null),e(r).off(),e(r).empty(),delete t.graph),this.el.find("figure").html(""),this.el.find("figure").append((new recline.View.NoDataMsg).create()),this.el.find("div.xCharts-title-x").html("")}}},createLegend:function(){var t=this,n=e("<div/>"),r=0;e("<script>function changeSeriesVisibility(i){var isVisible = $('g .color'+i).attr('display'); if (isVisible === 'none') {isVisible = false;} else {isVisible = true;}if (isVisible){	$('g .color'+i).attr('display', 'none');	$('.legend_item_value.legendcolor'+i).addClass('noFillLegendBullet');} else {$('g .color'+i).attr('display', 'inline');$('.legend_item_value.legendcolor'+i).removeClass('noFillLegendBullet');}}</script>").appendTo("head"),_.each(t.series.main,function(t){if(t.color){e("<style type='text/css'> .color"+r+"{ color:rgb("+t.color.rgb+");} "+".legendcolor"+r+"{ color:rgb("+t.color.rgb+"); background-color:rgb("+t.color.rgb+"); } "+".xchart .color"+r+" .fill { fill:rgba("+t.color.rgb+",0.1);} "+".xchart .color"+r+" .line { stroke:rgb("+t.color.rgb+");} "+".xchart .color"+r+" rect, .xchart .color"+r+" circle { fill:rgb("+t.color.rgb+");} "+"</style>").appendTo("head");var s=e('<div class="legend_item" onClick="changeSeriesVisibility('+r+')"/>'),o=e("<span/>");o.html(t.label),s.append(o);var u=e('<div class="legend_item_value"/>');u.addClass("legendcolor"+r),s.append(u),n.append(s)}else console.log("d.color not defined");r++}),t.options.state.legend.html(n)},updateSeries:function(){var e=this,t=e.options.state,n=recline.Data.SeriesUtility.createSeries(t.series,t.unselectedColor,e.model,e.resultType,t.group,t.scaleTo100Perc,t.groupAllSmallSeries),r={main:[],xScale:t.xScale,yScale:t.yScale};_.each(n,function(e){var t={color:e.color,name:e.key,label:e.label,data:_.map(e.values,function(e){return{x:e.x,y:e.y,x_formatted:e.x_formatted,y_formatted:e.y_formatted,legendField:e.legendField,legendValue:e.legendValue}})};r.main.push(t)}),e.options.state.useAnnotations&&n.length&&recline.Data.SeriesUtility.createSerieAnnotations(e.options.state.useAnnotations.dataset,e.options.state.useAnnotations.dateField,e.options.state.useAnnotations.textField,r.main,e.options.state.useAnnotations.seriesField,e.options.state.useAnnotations.strictPositioning),e.series=r}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.CurrentFilter=Backbone.View.extend({template:'    	<script>     	$(function() {     		$(".chzn-select-deselect").chosen({allow_single_deselect:true});     	});     	</script>       <div">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}"> 			<select class="chzn-select-deselect data-control-id" multiple data-placeholder="{{label}}">             {{#values}}             <option value="{{dataset_index}}-{{filter_index}}" selected>{{val}}</option>             {{/values}}           </select>         </fieldset>       </div>',events:{"change .chzn-select-deselect":"onFilterValueChanged"},initialize:function(t){var n=this;this.el=e(this.el),_.bindAll(this,"render"),this._sourceDatasets=t.models,this.uid=t.id||Math.floor(Math.random()*1e5),_.each(this._sourceDatasets,function(e){e.bind("query:done",n.render),e.queryState.bind("selection:done",n.render)})},render:function(){var e=this,t={id:e.uid,label:"Active filters"},n=[];_.each(e._sourceDatasets,function(t,r){_.each(t.queryState.get("filters"),function(i,s){var o={dataset_index:r,filter_index:s};o.val=e.filterDescription[i.type](i,t),n.push(o)})}),t.values=n;var r=Mustache.render(e.template,t);this.el.html(r)},filterDescription:{term:function(e,t){return t.fields.get(e.field).attributes.label+": "+e.term},range:function(e,t){return t.fields.get(e.field).attributes.label+": "+e.start+"-"+e.stop},list:function(e,t){var n=t.fields.get(e.field).attributes.label+": ";return _.each(e.list,function(e,t){t>0&&(n+=","),n+=e}),n}},onFilterValueChanged:function(t){var n=this;t.preventDefault();var r=e(t.target).parent(),i=r.find(".data-control-id")[0][0].value.split("-"),s=i[0],o=i[1];n._sourceDatasets[s].queryState.removeFilter(o)}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.DatePicker=Backbone.View.extend({template:'<div style="width: 230px;" id="datepicker-calendar-{{uid}}"></div>',fullyInitialized:!1,maindateFromChanged:!1,maindateToChanged:!1,comparedateFromChanged:!1,comparedateToChanged:!1,initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","redraw","redrawCompare","calculateMonday","calculateFirstDayOfMonth","calculateLastDayOfMonth");if(!this.model)return;this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.options.compareModel&&(this.options.compareModel.bind("query:done",this.redrawCompare),this.options.compareModel.queryState.bind("selection:done",this.redrawCompare)),e(window).resize(this.resize),this.uid=t.id||(new Date).getTime()+Math.floor(Math.random()*1e4);var n=Mustache.render(this.template,this);this.el.html(n)},daterange:{yesterday:"day",lastweeks:"week",lastdays:"day",lastmonths:"month",lastquarters:"quarter",lastyears:"year",previousyear:"year",custom:"day"},onChange:function(e){var t=function(t,n){var r=[],i=e.getActionsForEvent("selection");if(i.length>0){var s=new Date(parseInt(t.dr1from_millis)),o=new Date(parseInt(t.dr1to_millis)),u=e.daterange[t.daterangePreset];r=[{field:"date_reference",value:[s.toString(),o.toString()]},{field:"rangetype_reference",value:[u]}];var a=u;t.comparisonPreset!="previousperiod"&&(a=e.daterange[t.comparisonPreset]);if(t.comparisonEnabled){var f=new Date(parseInt(t.dr2from_millis)),l=new Date(parseInt(t.dr2to_millis));f!=null&&l!=null&&(r.push({field:"date_compare",value:[f.toString(),l.toString()]}),r.push({field:"rangetype_compare",value:[a]}))}e.doActions(i,r)}};return t},doActions:function(e,t){_.each(e,function(e){e.action.doActionWithValues(t,e.mapping)})},render:function(){var t=this,n=this.uid;t.datepicker=e("#datepicker-calendar-"+n).DateRangesWidget({aggregations:[],values:{comparisonEnabled:!1,daterangePreset:"lastweeks",comparisonPreset:"previousperiod"},onChange:t.onChange(t)}),t.redraw(),t.redrawCompare();if(t.options.weeklyMode){var r=e(".datepicker.selectableRange").data("datepicker");r?r.weeklyMode=t.options.weeklyMode:e(".datepicker.selectableRange").data("datepicker","weeklyMode",t.options.weeklyMode)}else if(t.options.monthlyMode){var r=e(".datepicker.selectableRange").data("datepicker");r?r.monthlyMode=t.options.monthlyMode:e(".datepicker.selectableRange").data("datepicker","monthlyMode",t.options.monthlyMode)}},redraw:function(){if(!this.model||this.model=="undefined")return;var t=this,n=e(".date-ranges-picker").DatePickerGetDate();if(n){var r=n[0],i=t.model.queryState.getFilterByFieldName(t.options.fields.date);i&&i.type=="range"&&(r[0]=new Date(i.start),r[1]=new Date(i.stop));var i=t.model.queryState.getFilterByFieldName(t.options.fields.type);i&&i.type=="term";var s=t.datepicker.data("DateRangesWidget").options.values;!r[0]||!r[1]?(s.dr1from="N/A",s.dr1from_millis="",s.dr1to="N/A",s.dr1to_millis=""):(s.daterangePreset="custom",s.dr1from=t.retrieveDateStr(r[0]),s.dr1from_millis=(new Date(r[0])).getTime(),s.dr1to=t.retrieveDateStr(r[1]),s.dr1to_millis=(new Date(r[1])).getTime()),e(".date-ranges-picker").DatePickerSetDate(r,!0),s.dr1from&&s.dr1to&&e("span.main",t.datepicker).text(s.dr1from+" - "+s.dr1to),e(".dr1.from",t.datepicker).val(s.dr1from),e(".dr1.to",t.datepicker).val(s.dr1to),e(".dr1.from_millis",t.datepicker).val(s.dr1from_millis),e(".dr1.to_millis",t.datepicker).val(s.dr1to_millis),t.fullyInitialized||(e(".dr1.from").bind("keypress",function(e){t.maindateFromChanged=!0}),e(".dr1.to").bind("keypress",function(e){t.maindateToChanged=!0}),e(".dr1.from").bind("blur",function(n){if(t.maindateFromChanged){if(t.options.weeklyMode){var r=t.calculateMonday(e(this).val()),i=t.calculateSundayFromMonday(r),s=t.retrieveDateStr(r),o=t.retrieveDateStr(i);e(".dr1.from").val(s),e(".dr1.to").val(o),t.applyTextInputDateChange(r,s,t,!0,!0),t.applyTextInputDateChange(i,o,t,!0,!1)}else if(t.options.monthlyMode){var u=t.calculateFirstDayOfMonth(e(this).val()),a=t.calculateLastDayOfMonth(e(this).val()),f=t.retrieveDateStr(u),l=t.retrieveDateStr(a);e(".dr1.from").val(f),e(".dr1.to").val(l),t.applyTextInputDateChange(u,f,t,!0,!0),t.applyTextInputDateChange(a,l,t,!0,!1)}else{var c=t.retrieveDMYDate(e(this).val());t.applyTextInputDateChange(c,e(this).val(),t,!0,!0)}t.maindateFromChanged=!1}}),e(".dr1.to").bind("blur",function(n){if(t.maindateToChanged){if(t.options.weeklyMode){var r=t.calculateMonday(e(this).val()),i=t.calculateSundayFromMonday(r),s=t.retrieveDateStr(r),o=t.retrieveDateStr(i);e(".dr1.from").val(s),e(".dr1.to").val(o),t.applyTextInputDateChange(r,s,t,!0,!0),t.applyTextInputDateChange(i,o,t,!0,!1)}else if(t.options.monthlyMode){var u=t.calculateFirstDayOfMonth(e(this).val()),a=t.calculateLastDayOfMonth(e(this).val()),f=t.retrieveDateStr(u),l=t.retrieveDateStr(a);e(".dr1.from").val(f),e(".dr1.to").val(l),t.applyTextInputDateChange(u,f,t,!0,!0),t.applyTextInputDateChange(a,l,t,!0,!1)}else{var c=t.retrieveDMYDate(e(this).val()).getTime()+864e5-1;t.applyTextInputDateChange(new Date(c),e(this).val(),t,!0,!1)}t.maindateToChanged=!1}}))}},redrawCompare:function(){var t=this,n=e(".date-ranges-picker").DatePickerGetDate();if(n){var r=n[0],i=t.datepicker.data("DateRangesWidget").options.values;if(this.options.compareModel){if(t.fullyInitialized&&!i.comparisonEnabled)return;var s=t.options.compareModel.queryState.getFilterByFieldName(t.options.compareFields.date);s&&s.type=="range"&&(r[2]=new Date(s.start),r[3]=new Date(s.stop));var s=t.model.queryState.getFilterByFieldName(t.options.fields.type);s&&s.type=="term",r[2]&&r[3]?(i.comparisonEnabled=!0,i.comparisonPreset="custom",i.dr2from=t.retrieveDateStr(r[2]),i.dr2from_millis=(new Date(r[2])).getTime(),i.dr2to=t.retrieveDateStr(r[3]),i.dr2to_millis=(new Date(r[3])).getTime(),e(".comparison-preset").val("custom")):(i.comparisonEnabled=!1,i.dr2from="N/A",i.dr2from_millis="",i.dr2to="N/A",i.dr2to_millis="",e(".comparison-preset").val("previousperiod")),e(".date-ranges-picker").DatePickerSetDate(r,!0),i.comparisonEnabled&&i.dr2from&&i.dr2to?(e("span.comparison",t.datepicker).text(i.dr2from+" - "+i.dr2to),e("span.comparison",t.datepicker).show(),e("span.comparison-divider",t.datepicker).show()):(e("span.comparison-divider",t.datepicker).hide(),e("span.comparison",t.datepicker).hide()),e(".dr2.from",t.datepicker).val(i.dr2from),e(".dr2.to",t.datepicker).val(i.dr2to),e(".dr2.from_millis",t.datepicker).val(i.dr2from_millis),e(".dr2.to_millis",t.datepicker).val(i.dr2to_millis),t.fullyInitialized||(e(".dr2.from").bind("keypress",function(e){t.comparedateFromChanged=!0}),e(".dr2.to").bind("keypress",function(e){t.comparedateToChanged=!0}),e(".dr2.from").bind("blur",function(n){if(t.comparedateFromChanged){if(t.options.weeklyMode){var r=t.calculateMonday(e(this).val()),i=t.calculateSundayFromMonday(r),s=t.retrieveDateStr(r),o=t.retrieveDateStr(i);e(".dr2.from").val(s),e(".dr2.to").val(o),t.applyTextInputDateChange(r,s,t,!1,!0),t.applyTextInputDateChange(i,o,t,!1,!1)}else if(t.options.monthlyMode){var u=t.calculateFirstDayOfMonth(e(this).val()),a=t.calculateLastDayOfMonth(e(this).val()),f=t.retrieveDateStr(u),l=t.retrieveDateStr(a);e(".dr2.from").val(f),e(".dr2.to").val(l),t.applyTextInputDateChange(u,f,t,!1,!0),t.applyTextInputDateChange(a,l,t,!1,!1)}else{var c=t.retrieveDMYDate(e(this).val());t.applyTextInputDateChange(c,e(this).val(),t,!1,!0)}t.comparedateFromChanged=!1}}),e(".dr2.to").bind("blur",function(n){if(t.comparedateToChanged){if(t.options.weeklyMode){var r=t.calculateMonday(e(this).val()),i=t.calculateSundayFromMonday(r),s=t.retrieveDateStr(r),o=t.retrieveDateStr(i);e(".dr2.from").val(s),e(".dr2.to").val(o),t.applyTextInputDateChange(r,s,t,!1,!0),t.applyTextInputDateChange(i,o,t,!1,!1)}else if(t.options.monthlyMode){var u=t.calculateFirstDayOfMonth(e(this).val()),a=t.calculateLastDayOfMonth(e(this).val()),f=t.retrieveDateStr(u),l=t.retrieveDateStr(a);e(".dr2.from").val(f),e(".dr2.to").val(l),t.applyTextInputDateChange(u,f,t,!1,!0),t.applyTextInputDateChange(a,l,t,!1,!1)}else{var c=t.retrieveDMYDate(e(this).val()).getTime()+864e5-1;t.applyTextInputDateChange(new Date(c),e(this).val(),t,!1,!1)}t.comparedateToChanged=!1}}),t.fullyInitialized=!0)}else i.comparisonEnabled=!1,i.comparisonPreset="previousperiod",e(".comparison-preset").val("previousperiod"),e(".comparison-preset").prop("disabled",!0),e(".enable-comparison").removeAttr("checked"),e(".enable-comparison").change(),e(".comparison-daterange").css("display","none"),e(".enable-comparison").parent().css("display","none"),e("#datepicker-dropdown").css("min-height","140px")}},calculateMonday:function(e){var t=this.retrieveDMYDate(e),n=t.getDay(),r=(n==0?-6:1)-n;return new Date(t.getTime()+r*24*36e5)},calculateSundayFromMonday:function(e){return new Date(e.getTime()+6048e5-1)},calculateFirstDayOfMonth:function(e){var t=this.retrieveDMYDate(e);return t.setDate(1),t},calculateLastDayOfMonth:function(e){var t=this.retrieveDMYDate(e);t.setDate(1);var n=t.getMonth()+1;return n==12?(t.setMonth(0),t.setFullYear(t.getFullYear()+1)):t.setMonth(n),new Date(t.getTime()-1)},retrieveDMYDate:function(e){var t=e.split("/");if(t.length<3)return null;var n=new Date(t[2],parseInt(t[1])-1,t[0]);return t[2]>=1970&&n&&n.getMonth()+1==t[1]&&n.getDate()==Number(t[0])?n:null},retrieveDateStr:function(e){return d3.time.format("%d/%m/%Y")(e)},applyTextInputDateChange:function(t,n,r,i,s){var o=r.datepicker.data("DateRangesWidget").options,u=e(".datepicker.selectableRange").data("datepicker"),a=o.values;i?(s?(a.dr1from=n,a.dr1from_millis=t.getTime(),e(".dr1.from_millis").val(t.getTime()),u.date[0]=t.getTime()):(a.dr1to=n,a.dr1to_millis=t.getTime(),e(".dr1.to_millis").val(t.getTime()),u.date[1]=t.getTime()),u.mode=="tworanges"&&(u.lastSel=2)):(s?(a.dr2from=n,a.dr2from_millis=t.getTime(),e(".dr2.from_millis").val(t.getTime()),u.date[2]=t.getTime()):(a.dr2to=n,a.dr2to_millis=t.getTime(),e(".dr2.to_millis").val(t.getTime()),u.date[3]=t.getTime()),u.mode=="tworanges"&&(u.lastSel=0)),u.current=t,e(".date-ranges-picker").DatePickerSetMode(e(".date-ranges-picker").DatePickerGetMode())},getActionsForEvent:function(e){var t=[];return _.each(this.options.actions,function(n){_.contains(n.event,e)&&t.push(n)}),t}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.FacetDashboard=Backbone.View.extend({template:'<div id="facet-widget-{{uid}}"><div id="facet-selector-{{uid}}"></div><div id="facet-container-{{uid}}"><div class="row" id="facet-container-row-{{uid}}"></div></div></div>',initialize:function(t){var n=this;this.uid="facet_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.el=e(this.el),this.listenTo(this.model.facets,"reset",function(e){n.render()}),this.listenTo(this.model.facets,"add",function(e){n.addFacet(e)});var r=Mustache.render(this.template,this);this.el.html(r),this.render()},render:function(){var e=this;_.each(e.model.facets.toJSON(),function(t){e.addFacet(t.id,t.terms)})},addFacet:function(t,n){var r=this,i=r.options,s=new recline.Model.Dataset({records:n,fields:[{id:"count",type:"number"},{id:"term",type:"string"}]}),o=e("#facet-container-row-"+r.uid);e("#facet-"+r.uid+"-"+t).length==0&&o.append("<div class='"+i.facetClass+"' id='facet-"+r.uid+"-"+t+"'>"+t+"<div style='height:"+i.facetHeight+"px' id='facet-table-"+r.uid+"-"+t+"'></div></div>");var u=new recline.Action({filters:{filter_facet:{type:"list",field:t}},models:[{model:dataset,filters:["filter_facet"]}],type:["filter"]}),a=new recline.View.SlickGridGraph({model:s,el:e("#facet-table-"+r.uid+"-"+t),actions:[{action:u,mapping:[{srcField:"term",filter:"filter_facet"}],event:["selection"]}]});a.visible=!0,s.fetch()},redraw:function(){var e=this}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.GenericFilter=Backbone.View.extend({className:"recline-filter-editor well",template:'<div class="filters" {{#backgroundColor}}style="background-color:{{backgroundColor}}"{{/backgroundColor}}>       <div class="form-stacked js-edit"> 	  	<div class="label label-info" style="display:{{titlePresent}}" > 		  	<h4>{{{filterDialogTitle}}}</h4> 		  	{{{filterDialogDescription}}} 	  	</div>         {{#filters}}           {{{filterRender}}} 		  <hr style="display:{{hrVisible}}">         {{/filters}}       </div>     </div>',templateHoriz:'<style> .separated-item { padding-left:20px;padding-right:20px; } </style> <div class="filters" style="background-color:{{backgroundColor}}">       <table > 	  	<tbody> 	  		<tr>	  			<td class="separated-item" style="display:{{titlePresent}}">				  	<div class="label label-info"> 					  	<h4>{{{filterDialogTitle}}}</h4> 					  	{{{filterDialogDescription}}} 				  	</div> 				</td>			  	{{#filters}} 			  	<td class="separated-item">          			{{{filterRender}}}           		</td>  				{{/filters}}         	</tr>  		</tbody>  	   </table>     </div> ',filterTemplates:{term:'       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>      		<div style="float:left;padding-right:10px;padding-top:2px;display:{{useLeftLabel}}">{{label}}</div>           <input type="text" value="{{term}}" name="term" class="data-control-id" />           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>         </fieldset>       </div>     ',slider:' 	<script> 		$(document).ready(function(){ 			$( "#slider{{ctrlId}}" ).slider({ 				min: {{min}}, 				max: {{max}},             	{{#step}}step: {{step}}{{/step}}, 				value: {{term}}, 				slide: function( event, ui ) { 					$( "#amount{{ctrlId}}" ).html( "{{label}}: "+ ui.value ); 				} 			}); 			$( "#amount{{ctrlId}}" ).html( "{{label}}: "+ $( "#slider{{ctrlId}}" ).slider( "value" ) ); 		}); 	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}" style="min-width:100px">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}} 			<a class="js-remove-filter" href="#" title="Remove this filter">&times;</a> 		</legend>  		  <label id="amount{{ctrlId}}">{{label}}: </label> 		  <div id="slider{{ctrlId}}" class="data-control-id"></div> 		  <br>           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>         </fieldset>       </div>     ',slider_styled:' 	<style> 		 .layout-slider { padding-bottom:15px;width:150px } 	</style>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}} 			<a class="js-remove-filter" href="#" title="Remove this filter">&times;</a> 		</legend>  		<div style="float:left;padding-right:15px;display:{{useLeftLabel}}">{{label}} 			<a class="js-remove-filter" href="#" title="Remove this filter">&times;</a> 		</div> 	    <div style="float:left" class="layout-slider" > 	    	<input type="slider" id="slider{{ctrlId}}" value="{{term}}" class="slider-styled data-control-id" /> 	    </div>         </fieldset>       </div>     ',range:'       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>            <label class="control-label" for="">From</label>           <input type="text" value="{{start}}" name="start"  class="data-control-id-from" style="width:auto"/>           <label class="control-label" for="">To</label>           <input type="text" value="{{stop}}" name="stop" class="data-control-id-to"  style="width:auto"/> 		  <br>           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>         </fieldset>       </div>     ',range_slider:' 	<script> 		$(document).ready(function(){ 			$( "#slider-range{{ctrlId}}" ).slider({ 				range: true, 				min: {{min}}, 				max: {{max}}, 				values: [ {{from}}, {{to}} ], 				slide: function( event, ui ) { 					$( "#amount{{ctrlId}}" ).html(  "{{label}}: " + ui.values[ 0 ] + " - " + ui.values[ 1 ] ); 				} 			}); 			$( "#amount{{ctrlId}}" ).html(  "{{label}}: " + $( "#slider-range{{ctrlId}}" ).slider( "values", 0 ) + " - " + $( "#slider-range{{ctrlId}}" ).slider( "values", 1 ) ); 		}); 	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}" style="min-width:100px">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>  		  <label id="amount{{ctrlId}}">{{label}} range: </label> 		  <div id="slider-range{{ctrlId}}" class="data-control-id" ></div> 		  <br>           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>         </fieldset>       </div>     '
,range_slider_styled:' 	<style> 	 .layout-slider { padding-bottom:15px;width:150px } 	</style>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}} 		</legend>  		<div style="float:left;padding-right:15px;display:{{useLeftLabel}}">{{label}}</div> 	    <div style="float:left" class="layout-slider" > 	    	<input type="slider" id="slider{{ctrlId}}" value="{{from}};{{to}}" class="slider-styled data-control-id" /> 	    </div>         </fieldset>       </div>     ',month_week_calendar:' 	  <style> 		.list-filter-item { cursor:pointer; } 		.list-filter-item:hover { background: lightblue;cursor:pointer; } 	  </style>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}              <a class="js-remove-filter" href="#" title="Remove this filter">&times;</a> 			</legend> 			Year<br> 			<select class="drop-down2 fields data-control-id" >             {{#yearValues}}             <option value="{{val}}" {{selected}}>{{val}}</option>             {{/yearValues}}           </select> 			<br> 			Type<br> 			<select class="drop-down3 fields" > 				{{#periodValues}} 				<option value="{{val}}" {{selected}}>{{val}}</option> 				{{/periodValues}} 			</select> 			<br> 			<div class="month_week_scroller" style="max-height:500px;width:100%;border:1px solid grey;overflow:auto;"> 				<table class="table table-striped table-hover table-condensed" style="width:100%" data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}"> 				<tbody>				{{#values}} 				<tr class="{{selected}}"><td class="list-filter-item " myValue="{{val}}" startDate="{{startDate}}" stopDate="{{stopDate}}">{{label}}</td></tr> 				{{/values}} 				</tbody> 			  </table> 		  </div> 	    </fieldset>       </div> 	',range_calendar:' 	<script> 	$(function() { 		$( "#from{{ctrlId}}" ).datepicker({ 			defaultDate: "{{startDate}}", 			changeMonth: true, 			numberOfMonths: 1, 			dateFormat: "D M dd yy", 			onSelect: function( selectedDate ) { 				$( "#to{{ctrlId}}" ).datepicker( "option", "minDate", selectedDate ); 			} 		}); 		$( "#to{{ctrlId}}" ).datepicker({ 			defaultDate: "{{endDate}}", 			changeMonth: true, 			numberOfMonths: 1, 			dateFormat: "D M dd yy", 			onSelect: function( selectedDate ) { 				$( "#from{{ctrlId}}" ).datepicker( "option", "maxDate", selectedDate ); 			} 		}); 	}); 	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>  			<label for="from{{ctrlId}}">From</label> 			<input type="text" id="from{{ctrlId}}" name="from{{ctrlId}}" class="data-control-id-from" value="{{startDate}}" style="width:auto"/> 			<br> 			<label for="to{{ctrlId}}">to</label> 			<input type="text" id="to{{ctrlId}}" name="to{{ctrlId}}" class="data-control-id-to" value="{{endDate}}" style="width:auto"/>  		  <br>           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>        </fieldset>       </div> 	',dropdown:'       <script>      	function updateColor(elem) {     		if (elem.prop("selectedIndex") == 0) elem.addClass("dimmed"); else elem.removeClass("dimmed");   		}       </script>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}     		</legend>      		<div style="float:left;padding-right:10px;padding-top:2px;display:{{useLeftLabel}}">{{label}}</div>     		<select class="drop-down fields data-control-id dimmed" onchange="updateColor($(this))"> 			<option class="dimmedDropDownText">{{innerLabel}}</option>             {{#values}}             <option class="normalDropDownText" value="{{val}}" {{selected}}>{{valCount}}</option>             {{/values}}           </select>         </fieldset>       </div>     ',dropdown_styled:'     	<script>     	$(function() {     		$(".chzn-select-deselect").chosen({allow_single_deselect:true});     	});     	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>  			<div style="float:left;padding-right:10px;padding-top:3px;display:{{useLeftLabel}}">{{label}}</div>     		<select class="chzn-select-deselect data-control-id" data-placeholder="{{innerLabel}}">     		<option></option>             {{#values}}             <option value="{{val}}" {{selected}}>{{valCount}}</option>             {{/values}}           </select>         </fieldset>       </div>     ',dropdown_date_range:'       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}     		</legend>      		<div style="float:left;padding-right:10px;padding-top:3px;display:{{useLeftLabel}}">{{label}}</div> 			<select class="drop-down fields data-control-id" > 			<option></option>             {{#date_values}}             <option startDate="{{startDate}}" stopDate="{{stopDate}}" {{selected}}>{{val}}</option>             {{/date_values}}           </select>         </fieldset>       </div>     ',list:' 	  <style> 		.list-filter-item { cursor:pointer; } 		.list-filter-item:hover { background: lightblue;cursor:pointer; } 	  </style>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}              <a class="js-remove-filter" href="#" title="Remove this filter">&times;</a> 			</legend>     		<div style="float:left;padding-right:10px;display:{{useLeftLabel}}">{{label}}     			<a class="js-remove-filter" href="#" title="Remove this filter">&times;</a>     		</div> 			<div style="max-height:500px;width:100%;border:1px solid grey;overflow:auto;"> 				<table class="table table-striped table-hover table-condensed" style="width:100%" data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" > 				<tbody>				{{#values}} 				<tr class="{{selected}}"><td class="list-filter-item" >{{val}}</td><td style="text-align:right">{{count}}</td></tr> 				{{/values}} 				</tbody>			  </table> 		  </div> 	    </fieldset>       </div> 	',listbox:'       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>      		<div style="float:left;padding-right:10px;display:{{useLeftLabel}}">{{label}}</div> 			<select class="fields data-control-id"  multiple SIZE=10>             {{#values}}             <option value="{{val}}" {{selected}}>{{valCount}}</option>             {{/values}}           </select> 		  <br>           <input type="button" class="btn" id="setFilterValueButton" value="Set"></input>         </fieldset>       </div>     ',listbox_styled:'     	<script>     	$(function() {     		$(".chzn-select-deselect").chosen({allow_single_deselect:true});     	});     	</script>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}     		</legend>      		<div style="float:left;padding-right:10px;padding-top:4px;display:{{useLeftLabel}}">{{label}}</div> 			<select class="chzn-select-deselect data-control-id" multiple data-placeholder="{{innerLabel}}">             {{#values}}             <option value="{{val}}" {{selected}}>{{valCount}}</option>             {{/values}}           </select>         </fieldset>       </div>     ',radiobuttons:'         <div class="filter-{{type}} filter" id="{{ctrlId}}">             <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">                 <legend style="display:{{useLegend}}">{{label}}</legend>      			<div style="float:left;padding-right:10px;padding-top:4px;display:{{useLeftLabel}}">{{label}}</div>     			<div class="btn-group data-control-id" >             		{{^noAllButton}}             		<button class="btn btn-mini grouped-button btn-primary">All</button>             		{{/noAllButton}}     	            {{#values}}     	    		<button class="btn btn-mini grouped-button {{selected}}" val="{{value}}" {{tooltip}}>{{{val}}}</button>     	            {{/values}}               	</div>             </div>         </div>         ',hierarchic_radiobuttons:'         <div class="filter-{{type}} filter" id="{{ctrlId}}">             <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">                 <legend style="display:{{useLegend}}">{{label}}</legend>      			<div style="float:left;padding-right:10px;padding-top:4px;display:{{useLeftLabel}}">{{label}}</div>     			<div class="btn-group data-control-id" level="1" style="float:left">             		{{#useAllButton}}             		<button class="btn btn-mini grouped-button {{all1Selected}}" val="All">All</button>             		{{/useAllButton}}     	            {{#values}}     	    		<button class="btn btn-mini grouped-button {{selected}}" val="{{value}}" {{tooltip}}>{{{val}}}</button>     	            {{/values}}               	</div>         		{{#useLevel2}} 	    			<div class="btn-group level2" level="2" style="float:left;display:{{showLevel2}}">      		{{#useAllButton}}         	 			<button class="btn btn-mini grouped-button {{all2Selected}}" val="">All</button>      		{{/useAllButton}} 			            {{#valuesLev2}} 	            			<button class="btn btn-mini grouped-button {{selected}}" val="{{value}}" {{tooltip}}>{{{val}}}</button> 			            {{/valuesLev2}} 	            	</div>             		{{#useLevel3}} 		    			<div class="btn-group level3" level="3" style="float:left;display:{{showLevel3}}">       		{{#useAllButton}} 	            			<button class="btn btn-mini grouped-button {{all3Selected}}" val="">All</button>      		{{/useAllButton}} 				            {{#valuesLev3}} 			        			<button class="btn btn-mini grouped-button {{selected}}" val="{{value}}" {{tooltip}}>{{{val}}}</button> 				            {{/valuesLev3}} 			        	</div>             		{{/useLevel3}}         		{{/useLevel2}}             </div>         </div>         ',multibutton:'     <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">     		<legend style="display:{{useLegend}}">{{label}}     		</legend>      		<div style="float:left;padding-right:10px;padding-top:4px;display:{{useLeftLabel}}">{{label}}</div>     		<div class="btn-group data-control-id" > 	            {{#values}} 	    		<button class="btn btn-mini grouped-button {{selected}}" val="{{value}}" {{tooltip}}>{{{val}}}</button> 	            {{/values}}           </div>         </fieldset>     </div>     ',legend:' 	  <style>       .legend-item { 					border-top:2px solid black;border-left:2px solid black; 					border-bottom:2px solid darkgrey;border-right:2px solid darkgrey; 					width:16px;height:16px;padding:1px;margin:5px; 					opacity: 0.85;             		cursor: pointer; 					}  	 .legend-item.not-selected { background-color:transparent !important; } /* the idea is that the color "not-selected" overrides the original color (this way we may use a global style) */ 	  </style>       <div class="filter-{{type}} filter" id="{{ctrlId}}">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>  			<div style="float:left;padding-right:10px;display:{{useLeftLabel}}">{{label}}</div> 			<table style="width:100%;background-color:transparent">			{{#values}} 				<tr> 				<td style="width:25px"><div class="legend-item {{notSelected}}" myValue="{{val}}" style="background-color:{{color}}"></td> 				<td style="vertical-align:middle"><label class="legend-label" style="color:{{color}};text-shadow: black 1px 1px, black -1px -1px, black -1px 1px, black 1px -1px, black 0px 1px, black 0px -1px, black 1px 0px, black -1px 0px">{{val}}</label></td>				<td><label style="text-align:right">[{{count}}]</label></td>				</tr>			{{/values}}			</table> 	    </fieldset>       </div> 	',color_legend:' 	<div class="filter-{{type}} filter" id="{{ctrlId}}" style="width:{{totWidth2}}px;max-height:{{totHeight2}}px">         <fieldset data-filter-field="{{field}}" data-filter-id="{{id}}" data-filter-type="{{type}}" data-control-type="{{controlType}}">             <legend style="display:{{useLegend}}">{{label}}</legend>  				<div style="float:left;padding-right:10px;height:{{lineHeight}}px;display:{{useLeftLabel}}"> 					<label style="line-height:{{lineHeight}}px">{{label}}</label> 				</div>             	<div class="data-control-id" style="width:{{totWidth}}px;height:{{totHeight}}px;display:inline" > 					<svg height="{{totHeight}}" xmlns="http://www.w3.org/2000/svg">             		<g> 					{{#colorValues}} 				    	<rect width="{{width}}" height={{lineHeight}} fill="{{color}}" x="{{x}}" y={{y}}/>             			{{#showValueLabels}}             			<text width="{{width}}" fill="{{textColor}}" x="{{x}}" y="{{yplus30}}">{{val}}</text>             			{{/showValueLabels}}             		{{/colorValues}}            		</g>             		<g>             			{{^showValueLabels}}             			{{#totWidth}}             			<path d="M0,0 L{{totWidth}},0 L{{totWidth}},{{totHeight}} L0,{{totHeight}} L0,0" style="fill:none;"/>             			{{/totWidth}}             			{{#colorValues2}}             			<text width="{{width}}" fill="{{textColor}}" x="{{x}}" y="{{yplus30}}">{{val}}</text>             			{{/colorValues2}}             			{{/showValueLabels}}             		</g> 					</svg>						</div> 	    </fieldset> 	</div> 	'},FiltersTemplate:{range_calendar:{needFacetedField:!1},month_week_calendar:{needFacetedField:!0},list:{needFacetedField:!0},legend:{needFacetedField:!0},dropdown:{needFacetedField:!0},dropdown_styled:{needFacetedField:!0},dropdown_date_range:{needFacetedField:!1},listbox:{needFacetedField:!0},listbox_styled:{needFacetedField:!0},term:{needFacetedField:!1},range:{needFacetedField:!0},slider:{needFacetedField:!0},slider_styled:{needFacetedField:!0},range_slider:{needFacetedField:!0},range_slider_styled:{needFacetedField:!0},color_legend:{needFacetedField:!0},multibutton:{needFacetedField:!0},radiobuttons:{needFacetedField:!0},hierarchic_radiobuttons:{needFacetedField:!1}},events:{"click .js-remove-filter":"onRemoveFilter","click .js-add-filter":"onAddFilterShow","click #addFilterButton":"onAddFilter","click .list-filter-item":"onListItemClicked","click .legend-item":"onLegendItemClicked","click .legend-label":"onLegendItemClicked","click #setFilterValueButton":"onFilterValueChanged","change .drop-down":"onFilterValueChanged","change .chzn-select-deselect":"onFilterValueChanged","change .drop-down2":"onListItemClicked","change .drop-down3":"onPeriodChanged","click .grouped-button":"onButtonsetClicked"},activeFilters:new Array,_sourceDataset:null,_selectedClassName:"info",initialize:function(t){this.el=e(this.el),_.bindAll(this,"render"),_.bindAll(this,"update"),_.bindAll(this,"getFieldType"),_.bindAll(this,"onRemoveFilter"),_.bindAll(this,"onPeriodChanged"),_.bindAll(this,"findActiveFilterByField"),_.bindAll(this,"updateDropdown"),_.bindAll(this,"updateDropdownStyled"),_.bindAll(this,"updateSlider"),_.bindAll(this,"updateSliderStyled"),_.bindAll(this,"updateRadiobuttons"),_.bindAll(this,"updateRangeSlider"),_.bindAll(this,"updateRangeSliderStyled"),_.bindAll(this,"updateRangeCalendar"),_.bindAll(this,"updateMonthWeekCalendar"),_.bindAll(this,"updateDropdownDateRange"),_.bindAll(this,"updateList"),_.bindAll(this,"updateListbox"),_.bindAll(this,"updateListboxStyled"),_.bindAll(this,"updateLegend"),_.bindAll(this,"updateColorLegend"),_.bindAll(this,"updateMultibutton"),_.bindAll(this,"redrawGenericControl"),_.bindAll(this,"fixHierarchicRadiobuttonsSelections"),_.bindAll(this,"changeFilterField"),this._sourceDataset=t.sourceDataset,this.uid=t.id||Math.floor(Math.random()*1e5),this.numId=0,this.sourceFields=t.sourceFields,t.state&&(this.filterDialogTitle=t.state.title,this.filterDialogDescription=t.state.description,this.useHorizontalLayout=t.state.useHorizontalLayout,this.showBackground=t.state.showBackground,this.showBackground==0&&(e(this).removeClass("well"),e(this.el).removeClass("well")),this.backgroundColor=t.state.backgroundColor),this.activeFilters=new Array,this._actions=t.actions;if(this.sourceFields&&this.sourceFields.length)for(var n in this.sourceFields)this.addNewFilterControl(this.sourceFields[n]);this._sourceDataset&&(this._sourceDataset.bind("query:done",this.render),this._sourceDataset.queryState.bind("selection:done",this.update))},areValuesEqual:function(e,t){return typeof e=="undefined"||typeof t=="undefined"?!1:e==t?!0:e&&e.valueOf()==t?!0:t&&e==t.valueOf()?!0:e&&t&&e.valueOf()==t.valueOf()?!0:!1},update:function(){var t=this;_.each(this._sourceDataset.queryState.get("selections"),function(e){for(var n in t.activeFilters)t.activeFilters[n].field==e.field&&(t.activeFilters[n].list=e.list,t.activeFilters[n].term=e.term,t.activeFilters[n].start=e.start,t.activeFilters[n].stop=e.stop,t.fixHierarchicRadiobuttonsSelections(t.activeFilters[n]))});var n=this.el.find("div.filter");_.each(n,function(n){var r=e(n).find(".data-control-id");if(typeof r=="undefined"||r==null)var i=e(n).find(".data-control-id-from"),s=e(n).find(".data-control-id-to");var o=null;for(var u in t.activeFilters)if(t.activeFilters[u].ctrlId==n.id){o=t.activeFilters[u];break}if(o!=null){if(o.userChanged){o.userChanged=undefined;return}switch(o.controlType){case"dropdown":return t.updateDropdown(e(n),o,e(r));case"dropdown_styled":return t.updateDropdownStyled(e(n),o,e(r));case"slider":return t.updateSlider(e(n),o,e(r));case"slider_styled":return t.updateSliderStyled(e(n),o,e(r));case"radiobuttons":return t.updateRadiobuttons(e(n),o,e(r));case"hierarchic_radiobuttons":return t.updateHierarchicRadiobuttons(e(n),o,e(r));case"range_slider":return t.updateRangeSlider(e(n),o,e(r));case"range_slider_styled":return t.updateRangeSliderStyled(e(n),o,e(r));case"range_calendar":return t.updateRangeCalendar(e(n),o,e(i),e(s));case"month_week_calendar":return t.updateMonthWeekCalendar(e(n),o,e(r));case"dropdown_date_range":return t.updateDropdownDateRange(e(n),o,e(r));case"list":return t.updateList(e(n),o,e(r));case"listbox":return t.updateListbox(e(n),o,e(r));case"listbox_styled":return t.updateListboxStyled(e(n),o,e(r));case"legend":return t.updateLegend(e(n),o,e(r));case"color_legend":return t.updateColorLegend(e(n),o,e(r));case"multibutton":return t.updateMultibutton(e(n),o,e(r))}}})},computeUserChoices:function(e){var t=e.list;return(typeof t=="undefined"||t==null)&&e.term&&(t=[e.term]),t},redrawGenericControl:function(t,n){var r=this.createSingleFilter(n);t.parent().html(r);if(n.controlType=="month_week_calendar"&&n.period=="Weeks"){var i=e("#"+n.ctrlId).find(".month_week_scroller"),s=i.first("table tr");i.scrollTop((n.term-1)*parseInt(s.css("line-height")))}},updateDropdown:function(e,t,n){var r=this.computeUserChoices(t);r!=null&&r.length==1?(n[0].style.color="",n.val(r[0])):n.find("option:first").prop("selected","selected"),n.prop("selectedIndex")==0?n.addClass("dimmed"):n.removeClass("dimmed")},updateDropdownStyled:function(e,t,n){this.redrawGenericControl(e,t)},updateSlider:function(t,n,r){var i=this.computeUserChoices(n);i!=null&&i.length==1&&(r.slider("value",i[0]),e("#amount"+n.ctrlId).html(n.label+": "+i[0]),r.trigger("slide",r))},updateSliderStyled:function(e,t,n){var r=this.computeUserChoices(t);r!=null&&r.length==1&&n.jslider("value",r[0])},updateHierarchicRadiobuttons:function(e,t,n){this.redrawGenericControl(e,t)},updateRadiobuttons:function(t,n,r){var i=this.computeUserChoices(n),s=r.find("button.grouped-button");_.each(s,function(t){e(t).removeClass("btn-primary")});if(i!=null&&typeof valuelist!="undefined")if(i.length==1)for(var o=0;o<s.length;o++){var u=e(s[o]);for(var a=0;a<i.length;a++){var f=i[a];if(this.areValuesEqual(f,u.html())){u.addClass("btn-primary");break}}}else i.length==0&&!n.noAllButton&&e(s[0]).addClass("btn-primary");else n.noAllButton||e(s[0]).addClass("btn-primary")},updateRangeSlider:function(t,n,r){var i=this.computeUserChoices(n);i&&i.length==2&&(r.slider("values",0,i[0]),r.slider("values",1,i[1]),e("#amount"+n.ctrlId).html(n.label+": "+i[0]+" - "+i[1]),r.trigger("slide",r))},updateRangeSliderStyled:function(e,t,n){var r=this.computeUserChoices(t);r&&r.length==2&&n.jslider("value",r[0],r[1])},updateRangeCalendar:function(e,t,n,r){this.redrawGenericControl(e,t)},updateMonthWeekCalendar:function(e,t,n){this.redrawGenericControl(e,t)},updateDropdownDateRange:function(e,t,n){this.redrawGenericControl(e,t)},updateList:function(e,t,n){this.redrawGenericControl(e,t)},updateListbox:function(e,t,n){this.redrawGenericControl(e,t)},updateListboxStyled:function(e,t,n){this.redrawGenericControl(e,t)},updateLegend:function(e,t,n){this.redrawGenericControl(e,t)},updateColorLegend:function(e,t,n){this.redrawGenericControl(e,t)},updateMultibutton:function(t,n,r){var i=this.computeUserChoices(n),s=n.selectedClassName||"btn-info",o=r.find("button.grouped-button");_.each(o,function(t){e(t).removeClass(s)});if(i)for(var u=0;u<o.length;u++){var a=e(o[u]);for(var f=0;f<i.length;f++){var l=i[f];this.areValuesEqual(l,a.html())&&a.addClass(s)}}},filterRender:function(){return this.self.createSingleFilter(this)},createSingleFilter:function(e){var t=e.self,n=t.FiltersTemplate[e.controlType],r;if(!n)throw"GenericFilter: Invalid control type "+e.controlType;if(n.needFacetedField){if(!t._sourceDataset.getRecords().length)return;e.facet=t._sourceDataset.getFacetByFieldId(e.field);if(e.facet==null||typeof e.facet=="undefined")throw"GenericFilter: no facet present for field ["+e.field+"]. Define a facet before filter render";if(e.fieldType=="integer"||e.fieldType=="number")e.facet.attributes.terms=_.sortBy(e.facet.attributes.terms,function(e){return e.term});r=e.facet.attributes.terms}else t._sourceDataset;if(typeof e.label=="undefined"||e.label==null)e.label=e.field;e.useLegend="block",e.labelPosition!="top"&&(e.useLegend="none"),e.useLeftLabel="none",e.labelPosition=="left"&&(e.useLeftLabel="block"),e.labelPosition=="inside"&&(e.innerLabel=e.label),e.values=new Array,e.controlType.indexOf("calendar")>=0&&(e.start&&(e.startDate=t.dateConvert(e.start)),e.stop&&(e.endDate=t.dateConvert(e.stop))),e.controlType.indexOf("slider")>=0&&(r.length>0&&typeof r[0].term!="undefined"?(e.max=r[0].term,e.min=r[0].term):(e.max=100,e.min=0));if(e.controlType=="month_week_calendar"){e.weekValues=[];var i=e.year,s=new Date(i,0,1),o=s.getTime(),u=s.getDay(),a=!1;for(var f=0;f<=53&&!a;f++){var l=o+6048e5*(f-1)+(7-u)*864e5,c=l+6048e5;f==0&&(l=o),(new Date(c)).getFullYear()>i&&(c=(new Date(i+1,0,1)).getTime(),a=!0);var h={val:f+1,label:""+(f+1)+" ["+d3.time.format("%x")(new Date(l))+" -> "+d3.time.format("%x")(new Date(c-1e3))+"]",startDate:new Date(l),stopDate:new Date(c)};if(e.term==f+1||e.start&&e.start.getTime()==l&&e.stop&&e.stop.getTime()==c)h.selected=t._selectedClassName,e.term=f+1,e.period==""&&(e.period="Weeks");e.weekValues.push(h)}e.monthValues=[];for(m=1;m<=12;m++){var p=i,d=m;m==12&&(p=i+1,d=0);var v={val:d3.format("02d")(m),label:d3.time.format("%B")(new Date(m+"/01/2012"))+" "+i,startDate:new Date(i,m-1,1,0,0,0,0),stopDate:new Date(p,d,1,0,0,0,0)};if(e.term==m||e.start&&e.start.getTime()==v.startDate.getTime()&&e.stop&&e.stop.getTime()==v.stopDate.getTime())v.selected=t._selectedClassName,e.period==""&&(e.period="Months");e.monthValues.push(v)}e.periodValues=[{val:"Months",selected:e.period=="Months"?"selected":""},{val:"Weeks",selected:e.period=="Weeks"?"selected":""}],e.period=="Months"?e.values=e.monthValues:e.period=="Weeks"&&(e.values=e.weekValues),e.yearValues=[];var g=2010,p=parseInt(d3.time.format("%Y")(new Date));for(var y=g;y<=p;y++)e.yearValues.push({val:y,selected:e.year==y?"selected":""})}else if(e.controlType=="dropdown_date_range"){e.date_values=[];var b=[{label:"This week",start:"sunday",stop:"next sunday"},{label:"This month",start:"1",delta:{months:1}},{label:"This year",start:"january 1",delta:{years:1}},{label:"Past week",stop:"sunday",delta:{days:-7}},{label:"Past month",stop:"1",delta:{months:-1}},{label:"Past 2 months",stop:"1",delta:{months:-2}},{label:"Past 3 months",stop:"1",delta:{months:-3}},{label:"Past 6 months",stop:"1",delta:{months:-6}},{label:"Past year",stop:"january 1",delta:{years:-1}},{label:"Last 7 days",start:"-6",stop:"t +1 d"},{label:"Last 30 days",start:"-29",stop:"t +1 d"},{label:"Last 90 days",start:"-89",stop:"t +1 d"},{label:"Last 365 days",start:"-1 y",stop:"t +1 d"}],w=b;e.skipDefaultFilters&&(w=[]),e.userFilters&&(w=w.concat(e.userFilters));for(var E in w){var S=w[E],x=null,T=null;S.start&&S.stop?(x=Date.parse(S.start),T=Date.parse(S.stop)):S.start&&S.delta?(x=Date.parse(S.start),x&&(T=new Date(x),T.add(S.delta))):S.stop&&S.delta&&(T=Date.parse(S.stop),T&&(x=new Date(T),x.add(S.delta))),x&&T&&S.label&&e.date_values.push({val:S.label,startDate:x,stopDate:T})}for(var N in e.date_values)if(e.date_values[N].val==e.term||e.date_values[N].startDate==e.start&&e.date_values[N].stopDate==e.stop){e.date_values[N].selected="selected";break}}else if(e.controlType=="legend"){e.tmpValues=_.pluck(e.facet.attributes.terms,"term"),typeof e.origLegend=="undefined"&&(e.origLegend=e.tmpValues,e.legend=e.origLegend),e.tmpValues=e.origLegend;var C=e.legend;for(var E in e.tmpValues){var k=e.tmpValues[E],L="";if(e.fieldType!="date"&&C.indexOf(k)<0||e.fieldType=="date"&&C.indexOf(k)<0&&C.indexOf((new Date(k)).valueOf())<0)L="not-selected";e.values.push({val:k,notSelected:L,color:e.facet.attributes.terms[E].color,count:e.facet.attributes.terms[E].count})}}else if(e.controlType=="color_legend"){typeof e.showValueLabels=="undefined"&&(e.showValueLabels=!0),e.colorValues=[],e.tmpValues=_.filter(_.pluck(e.facet.attributes.terms,"term"),function(e){return typeof e!="undefined"&&e!=null});var A=document.getElementById("my_string_width_calculation_ruler");if(typeof A=="undefined"||A==null)A=document.createElement("span"),A.setAttribute("id","my_string_width_calculation_ruler"),A.style.visibility="hidden",A.style.width="auto",document.body.appendChild(A);if(e.showValueLabels){var O=t.$el.width()||250;e.lineHeight=40;if(e.fieldType=="float"||e.fieldType=="number"||e.fieldType=="integer")for(var M in e.tmpValues)e.tmpValues[M]=Math.floor(e.tmpValues[M]);e.tmpValues=_.uniq(e.tmpValues);var D=0;for(var E in e.tmpValues){var k=e.tmpValues[E];A.innerHTML=k;var f=A.offsetWidth;f>D&&(D=f)}D+=2;var P=Math.floor(O/D),H=Math.ceil(e.tmpValues.length/P),B=Math.ceil(e.tmpValues.length/H);e.totWidth=B*D,e.totWidth2=e.totWidth+(e.labelPosition=="left"?e.label.length*10:10),e.totHeight=H*e.lineHeight,e.totHeight2=e.totHeight+e.lineHeight;var j=0,F=0;for(var E in e.tmpValues){var k=e.tmpValues[E],I=e.facet.attributes.terms[E].color;F==B&&(j++,F=0),e.colorValues.push({width:D,color:I,textColor:t.complementColor(I),val:k,x:D*F,y:j*e.lineHeight,yplus30:j*e.lineHeight+25}),F++}}else{e.colorValues2=[],e.lineHeight=20,e.minValue=e.tmpValues[0],e.maxValue=e.tmpValues[e.tmpValues.length-1];var O=t.el.width()||250,B=e.tmpValues.length,D=Math.floor(O/B);e.totWidth=B*D,e.totWidth2=e.totWidth+(e.labelPosition=="left"?e.label.length*10:10),e.totHeight=e.lineHeight,e.totHeight2=e.totHeight+e.lineHeight;for(var E in e.tmpValues){var k=e.tmpValues[E],I=e.facet.attributes.terms[E].color;if(E==0||E==e.tmpValues.length-1){isNaN(k)||(k=k.toFixed(2)),A.innerHTML=k;var f=A.offsetWidth;e.colorValues2.push({width:f,color:I,val:k,x:E==0?2:e.totWidth-f-2,y:0,yplus30:15,textColor:t.complementColor(I)})}e.colorValues.push({width:D,color:I,val:"",x:D*E,y:0,yplus30:15})}}}else if(e.controlType=="hierarchic_radiobuttons"){var q=[],R=[],U=1,z=null;e.all1Selected="btn-primary",e.term?z=e.term:typeof e.list!="undefined"&&e.list&&e.list.length==1&&(z=e.list[0]);if(e.term||e.list&&e.list.length<t._sourceDataset.getRecords())e.all1Selected="";var W=[];_.each(t._sourceDataset.getRecords(),function(n){var r=t._sourceDataset.fields.get(e.field);if(!r)throw"widget.genericfilter: unable to find field ["+e.field+"] in dataset";var i=n.getFieldValue(r),s=n.getFieldValueUnrendered(r);if(!_.contains(W,s)){W.push(s);var o=n.getFieldShape(r,!1,!1);R.push(i);if(i.indexOf(e.separator)<0)q.push({value:i,valueUnrendered:s,record:n,shape:o});else{var u=i.split(e.separator),a=u[0];_.find(q,function(e){return e.value==a})||(q.push({value:a,valueUnrendered:a,record:null,shape:o}),u.length>U&&(U=u.length))}}}),U>1&&(e.useLevel2=!0,e.showLevel2="none",e.all2Selected="btn-primary"),U>2&&(e.useLevel3=!0,e.showLevel3="none",e.all3Selected="btn-primary"),_.each(q,function(n){var r="",i=n.value,s=n.valueUnrendered,o=n.record;z&&z!=""&&t.areValuesEqual(z.split(e.separator)[0],s)&&(r="btn-primary");if(e.useShapeOnly==1){var u=n.shape;u&&u.indexOf("undefined")<0?(K="rel=tooltip title="+i,i="<div class='shape'>"+u+"</div>"):i="<div class='shapeH'>"+i+"</div>"}e.values.push({value:s,val:i,record:o,selected:r,valCount:i,tooltip:K})});if(z&&z!=""){e.valuesLev2=[];var X=z.split(e.separator),V=_.filter(R,function(t){return t.indexOf(X[0]+e.separator)==0});V&&V.length&&(e.showLevel2="block",_.each(V,function(n){var r="",i=n.split(e.separator),s=i[1],o=s;if(!_.find(e.valuesLev2,function(e){return e.value==s})){var u=null;i.length==2&&(u=_.find(t._sourceDataset.getRecords(),function(r){var i=t._sourceDataset.fields.get(e.field),s=r.getFieldValue(i);return s==n})),t.areValuesEqual(X[0],i[0])&&t.areValuesEqual(X[1],i[1])&&(r="btn-primary",e.all2Selected="");if(e.useShapeOnly==1){var a=u.getFieldShape(field,!1,!1);a&&a.indexOf("undefined")<0?(K="rel=tooltip title="+s,s="<div class='shape'>"+a+"</div>"):s="<div class='shapeH'>"+s+"</div>"}e.valuesLev2.push({value:o,val:s,selected:r,valCount:s,tooltip:K,record:u});if(i.length>=2&&X.length>=2){var f=_.filter(R,function(t){return t.indexOf(X[0]+e.separator+X[1])==0});f&&f.length&&(e.showLevel3="block",e.valuesLev3=[],_.each(f,function(n){var r="",i=n.split(e.separator),s=i[2],o=s;if(!_.find(e.valuesLev3,function(e){return e.value==s})){var u=null;i.length==3&&(u=_.find(t._sourceDataset.getRecords(),function(r){var i=t._sourceDataset.fields.get(e.field),s=r.getFieldValue(i);return s==n})),t.areValuesEqual(z,n)&&(r="btn-primary",e.all2Selected="");if(e.useShapeOnly==1){var a=u.getFieldShape(field,!1,!1);a&&a.indexOf("undefined")<0?(K="rel=tooltip title="+s,s="<div class='shape'>"+a+"</div>"):s="<div class='shapeH'>"+s+"</div>"}e.valuesLev3.push({value:o,val:s,selected:r,valCount:s,tooltip:K,record:u})}}))}}}))}}else{var $=null;typeof e.step=="undefined"&&(e.step=null);if(r)for(var E in r){var J="",K="",k=r[E].term;if(r[E].term){var Q=_.find(t._sourceDataset.getRecords(),function(t){return t.attributes[e.field]==r[E].term});if(Q){var G=Q.fields.get(e.field);G&&(k=Q.getFieldValue(G))}}var Y=r[E].term,Z=k,et=r[E].count;if(e.controlType=="list")et>0&&(J=t._selectedClassName);else if(e.controlType=="radiobuttons"){var tt=e.selectedClassName||"btn-primary";if(t.areValuesEqual(e.term,Y)||typeof e.list!="undefined"&&e.list&&e.list.length==1&&t.areValuesEqual(e.list[0],Y))J=tt;e.useShapeOnly==1&&(r[E].shape&&r[E].shape.indexOf("undefined")<0?(K="rel=tooltip title="+k,k="<div class='shape'>"+r[E].shape+"</div>"):k="<div class='shapeH'>"+k+"</div>")}else if(e.controlType=="multibutton"){var tt=e.selectedClassName||"btn-info";if(t.areValuesEqual(e.term,Y))J=tt;else if(typeof e.list!="undefined"&&
e.list!=null)for(var N in e.list)t.areValuesEqual(e.list[N],Y)&&(J=tt);e.useShapeOnly==1&&(r[E].shape&&r[E].shape.indexOf("undefined")<0?(K="rel=tooltip title="+k,k="<div class='shape'>"+r[E].shape+"</div>"):k="<div class='shapeH'>"+k+"</div>")}else if(e.controlType=="dropdown"||e.controlType=="dropdown_styled"){if(t.areValuesEqual(e.term,Y)||typeof e.list!="undefined"&&e.list&&e.list.length==1&&t.areValuesEqual(e.list[0],Y))J="selected"}else if(e.controlType=="listbox"||e.controlType=="listbox_styled")if(t.areValuesEqual(e.term,Y))J="selected";else if(typeof e.list!="undefined"&&e.list!=null)for(var N in e.list)t.areValuesEqual(e.list[N],Y)&&(J="selected");e.showCount?e.values.push({value:Y,val:k,selected:J,valCount:k+"	["+et+"]",count:"["+et+"]",tooltip:K}):e.values.push({value:Y,val:k,selected:J,valCount:k,tooltip:K}),e.controlType.indexOf("slider")>=0&&(k>e.max&&(e.max=k),k<e.min&&(e.min=k),e.controlType.indexOf("styled")>0&&$!=null&&(e.step==null||typeof e.step=="undefined"?e.step=k-$:k-$!=e.step&&(e.step=1))),$=k}else{if(!t._sourceDataset)throw"widget.genericfilter: nor facet or dataset present to build filter";_.each(t._sourceDataset.getRecords(),function(n){var r="",i="",s=t._sourceDataset.fields.get(e.field);if(!s)throw"widget.genericfilter: unable to find field ["+e.field+"] in dataset";var o=n.getFieldValue(s),u=n.getFieldValueUnrendered(s),a=o;if(e.controlType=="radiobuttons"){var f=e.selectedClassName||"btn-primary";if(t.areValuesEqual(e.term,u)||typeof e.list!="undefined"&&e.list&&e.list.length==1&&t.areValuesEqual(e.list[0],u))r=f;if(e.useShapeOnly==1){var l=n.getFieldShape(s,!1,!1);l&&l.indexOf("undefined")<0?(i="rel=tooltip title="+o,o="<div class='shape'>"+l+"</div>"):o="<div class='shapeH'>"+o+"</div>"}}else if(e.controlType=="multibutton"){var f=e.selectedClassName||"btn-info";if(t.areValuesEqual(e.term,u))r=f;else if(typeof e.list!="undefined"&&e.list!=null)for(var c in e.list)t.areValuesEqual(e.list[c],u)&&(r=f);if(e.useShapeOnly==1){var l=n.getFieldShape(s,!1,!1);l&&l.indexOf("undefined")<0?(i="rel=tooltip title="+o,o="<div class='shape'>"+l+"</div>"):o="<div class='shapeH'>"+o+"</div>"}}else if(e.controlType=="dropdown"||e.controlType=="dropdown_styled"){if(t.areValuesEqual(e.term,u)||typeof e.list!="undefined"&&e.list&&e.list.length==1&&t.areValuesEqual(e.list[0],u))r="selected"}else if(e.controlType=="listbox"||e.controlType=="listbox_styled")if(t.areValuesEqual(e.term,u))r="selected";else if(typeof e.list!="undefined"&&e.list!=null)for(var c in e.list)t.areValuesEqual(e.list[c],u)&&(r="selected");e.values.push({value:u,val:o,record:n,selected:r,valCount:o,tooltip:i}),e.controlType.indexOf("slider")>=0&&(o>e.max&&(e.max=o),o<e.min&&(e.min=o),e.controlType.indexOf("styled")>0&&$!=null&&(e.step==null||typeof e.step=="undefined"?e.step=o-$:o-$!=e.step&&(e.step=1))),$=o})}if(e.controlType.indexOf("slider")>=0){typeof e.from=="undefined"&&(e.from=e.min),typeof e.to=="undefined"&&(e.to=e.max),typeof e.term=="undefined"&&(e.term=e.min);if(e.controlType.indexOf("styled")>0)if(e.min%2==0&&e.max%2==0){e.step1=(e.max-e.min)/4+e.min,e.mean=(e.max-e.min)/2,e.step2=(e.max-e.min)*3/4+e.min;if(e.step1!=Math.floor(e.step1)||e.step2!=Math.floor(e.step2))e.step1="|",e.step2="|"}else e.step1="|",e.mean="|",e.step2="|"}}return e.ctrlId=t.uid+"_"+t.numId,t.numId++,Mustache.render(t.filterTemplates[e.controlType],e)},fixHierarchicRadiobuttonsSelections:function(e){var t=this;if(e.controlType=="hierarchic_radiobuttons"&&e.type=="list"&&e.list&&e.list.length>1){var n=e.list[0].split(e.separator);if(n.length>1){var r=n.splice(0,n.length-1).join(e.separator),i=r.length,s=!0,o=t._sourceDataset.getRecords();for(var u in o){var a=o[u],f=t._sourceDataset.fields.get(e.field),l=a.getFieldValue(f);if(l.substring(0,i)===r&&!_.contains(e.list,l)){s=!1;break}}s&&(e.term=r)}}},render:function(){var t=this;console.log("Render "+this._sourceDataset.id+" ["+this._sourceDataset.getRecords().length+"]");var n={filters:this.activeFilters};_.each(n.filters,function(e){e.hrVisible="block",e.self=t}),t._sourceDataset&&(_.each(t._sourceDataset.queryState.get("selections"),function(e){for(var r in n.filters)n.filters[r].field==e.field&&(n.filters[r].list=e.list,n.filters[r].term=e.term,n.filters[r].start=e.start,n.filters[r].stop=e.stop,t.fixHierarchicRadiobuttonsSelections(n.filters[r]))}),n.fields=this._sourceDataset.fields.toJSON()),n.filters.length>0&&(n.filters[n.filters.length-1].hrVisible="none");var r="filtered";t.options.resultType!==null&&(r=t.options.resultType),n.filterDialogTitle=this.filterDialogTitle,n.filterDialogDescription=this.filterDialogDescription,this.filterDialogTitle||this.filterDialogDescription?n.titlePresent="block":n.titlePresent="none",n.dateConvert=t.dateConvert,n.filterRender=t.filterRender;var i=this.template;this.useHorizontalLayout&&(i=this.templateHoriz),t.showBackground==0?(t.className=t.className.replace("well",""),e(t).removeClass("well"),e(t.el).removeClass("well")):(n.backgroundColor=t.backgroundColor,t.showBackground==1&&(t.className.indexOf("well")<0&&(t.className+=" well"),e(t).addClass("well"),e(t.el).addClass("well")));var s=Mustache.render(i,n);this.el.html(s);for(var o in n.filters)if(n.filters[o].controlType.indexOf("slider_styled")>=0){var u=n.filters[o];e("#slider"+u.ctrlId).jslider({from:u.min,to:u.max,scale:[u.min,"|",u.step1,"|",u.mean,"|",u.step2,"|",u.max],limits:!1,step:u.step,skin:n.filters[o].controlType.indexOf("range")==0?"round_plastic":"plastic",onstatechange:t.onStyledSliderValueChanged}),e("#slider"+u.ctrlId).data("self",t)}_.each(n.filters,function(n){if(n.controlType=="hierarchic_radiobuttons"&&n.type=="list"&&n.list&&n.list.length>1){var r;n.ctrlId?r=t.el.find("#"+n.ctrlId):r=this.el.find("div.filter");var i=e(r).find(".data-control-id");t.updateHierarchicRadiobuttons(e(r),n,e(i))}})},complementColor:function(e){var t=e.rgb;return t[0]+t[1]+t[2]<382.5?"white":"black"},onButtonsetClicked:function(t){t.preventDefault();var n=this,r=e(t.currentTarget),i=r.parent().parent(),s=i.attr("data-filter-type"),o=i.attr("data-filter-field"),u=i.attr("data-control-type");if(u=="hierarchic_radiobuttons"){var a=this.findActiveFilterByField(o,u),f=a.selectedClassName||"btn-primary";r.parent().find("button."+f).each(function(){e(this).removeClass(f)}),r.addClass(f);var l=r.parent().attr("level"),c="";if(l>=2){var h=i.find("div.data-control-id button."+f);c=h.attr("val").valueOf()+a.separator}if(l==3){var p=i.find("div.level2 button."+f);c+=p.attr("val").valueOf()+a.separator}var d=[];r.attr("val")&&r.attr("val").length?d.push(c+r.attr("val").valueOf()):c.length&&d.push(c.substring(0,c.length-1)),a.userChanged=!0;if(d.length==1&&d[0]=="All"&&!a.noAllButton){a.term="",a.showLevel2="none",a.showLevel3="none";var v=this.options.actions;v.forEach(function(e){e.action.doAction(n._sourceDataset.getRecords(),e.mapping)})}else{var m=r.attr("val").valueOf(),g=null;l==1?g=_.find(a.values,function(e){return e.value==m}):l==2?g=_.find(a.valuesLev2,function(e){return e.value==m}):l==3&&(g=_.find(a.valuesLev3,function(e){return e.value==m}));if(g&&g.record){a.term=c+m;if(l==1){var y=i.find("div.level2");if(y.length>0){y[0].style.display="none";var b=i.find("div.level3");b.length&&(b[0].style.display="none")}}else if(l==2){var b=i.find("div.level3");b.length>0&&(b[0].style.display="none")}this.doAction("onButtonsetClicked",o,d,"add",a)}else{a.term=c+m,a.term.length&&a.term[a.term.length-1]==a.separator&&(a.term=a.term.substring(0,a.term.length-1));var w;a.ctrlId?w=n.el.find("#"+a.ctrlId):w=this.el.find("div.filter");var E=e(w).find(".data-control-id");this.updateHierarchicRadiobuttons(e(w),a,e(E)),d=[],_.each(this._sourceDataset.getRecords(),function(e){var t=n._sourceDataset.fields.get(a.field),r=e.getFieldValue(t),i=c+m+a.separator;m==""&&(i=c),r.indexOf(i)==0&&!_.contains(d,r)&&d.push(r)}),this.doAction("onButtonsetClicked",o,d,"add",a)}}}else{var i=r.parent().parent(),s=i.attr("data-filter-type"),o=i.attr("data-filter-field"),u=i.attr("data-control-type"),a=this.findActiveFilterByField(o,u),f=a.selectedClassName||"btn-info";if(u=="multibutton"){r.toggleClass(f);if(a.nullSelectionNotAllowed&&i.find("div.btn-group button."+f).length==0){r.toggleClass(f);return}}else if(u=="radiobuttons"){f=a.selectedClassName||"btn-primary";if(a.allowDeselection){var S=r.hasClass(f);i.find("div.btn-group button."+f).each(function(){e(this).removeClass(f)}),S||r.addClass(f)}else i.find("div.btn-group button."+f).each(function(){e(this).removeClass(f)}),r.addClass(f)}var d=[];i.find("div.btn-group button."+f).each(function(){var t=e(this).attr("val");t!=null&&typeof t!="undefined"&&d.push(t.valueOf())}),a.userChanged=!0;if(u=="multibutton")a.list=d;else if(u=="radiobuttons")if(d.length==1&&d[0]=="All"&&!a.noAllButton||d.length==0&&a.allowDeselection)d=[],a.term="";else{var x=e(this).attr("val");x!=null&&typeof x!="undefined"&&(a.term=x.valueOf())}this.doAction("onButtonsetClicked",o,d,"add",a)}},onLegendItemClicked:function(t){t.preventDefault();var n=e(t.currentTarget);n.is("label")&&(n=n.parent().prev().children(".legend-item"));var r=n.parent().parent().parent().parent().parent(),i=r.attr("data-filter-type"),s=r.attr("data-filter-field"),o=r.attr("data-control-type");n.toggleClass("not-selected");var u=[];r.find("div.legend-item").each(function(){e(this).hasClass("not-selected")||u.push(e(this).attr("myValue").valueOf())});if(u.length>0){var a=this.findActiveFilterByField(s,o);a.userChanged=!0,a.legend=u,this.doAction("onLegendItemClicked",s,u,"add",a)}else n.toggleClass("not-selected")},onListItemClicked:function(t){t.preventDefault();var n=e(t.currentTarget),r,i,s,o;if(n.is("td")){i=n,r=n.parent().parent().parent();var u=r.attr("data-filter-type");u=="range"&&(o=r.parent().parent().find(".drop-down2"))}else n.is("select")&&(o=n,r=o.parent().find(".table"));this.handleListItemClicked(i,r,o,t.ctrlKey)},handleListItemClicked:function(t,n,r,i){var s=n.attr("data-filter-field"),o=n.attr("data-control-type"),u=n.attr("data-filter-type");if(u=="range"&&typeof t=="undefined"){var a=parseInt(r.val());this.findActiveFilterByField(s,o).year=a,this.render()}if(typeof t!="undefined"){i||n.find("tr").each(function(){e(this).removeClass(this._selectedClassName)}),t.parent().addClass(this._selectedClassName);var f=[];u=="list"&&n.find("tr."+this._selectedClassName+" td").each(function(){f.push(e(this).text())});var l=this.findActiveFilterByField(s,o);l.userChanged=!0;if(u=="range"){var a=parseInt(r.val()),c=new Date(t.attr("startDate")),h=new Date(t.attr("stopDate"));l.term=t.attr("myValue"),this.doAction("onListItemClicked",s,[c,h],"add",l)}else u=="list"?this.doAction("onListItemClicked",s,f,"add",l):u=="term"&&this.doAction("onListItemClicked",s,[t.text()],"add",l)}},doAction:function(e,t,n,r,i){var s=this;if(i.fieldType=="integer"||i.fieldType=="number"||i.fieldType=="float")for(var o in n)n[o]=parseFloat(n[o]);var u=this.options.actions;if(i.facet)u.forEach(function(e){e.action.doActionWithFacets(i.facet.attributes.terms,n,e.mapping,t)});else{var a=[];if(i.values&&i.values.length){var f=i.values;i.valuesLev3?f=i.values.concat(i.valuesLev2,i.valuesLev3):i.valuesLev2&&(f=i.values.concat(i.valuesLev2)),_.each(f,function(e){if(e.record){var t=e.record.fields.get(i.field),r=e.record.getFieldValueUnrendered(t);for(var o in n)if(s.areValuesEqual(r,n[o])){a.push(e.record);break}}})}a.length?u.forEach(function(e){e.action.doAction(a,e.mapping)}):n.length&&u.forEach(function(e){e.action.doActionWithValueArray(n,e.mapping,t)})}},dateConvert:function(e){var t=new Date(e);return t.toDateString()},dateConvertBack:function(e){try{var t=e.split(/\D/);return t[2]+"-"+t[0]+"-"+t[1]+" 00:00:00"}catch(n){return e}},onStyledSliderValueChanged:function(e){var t=this.inputNode.data("self");if(t){var n=this.domNode.parent().parent(),r=n.attr("data-filter-field"),i=n.attr("data-filter-type"),s=n.attr("data-control-type"),o=t.findActiveFilterByField(r,s);o.userChanged=!0;if(s=="range_slider_styled"){var u=e.split(";"),a=u[0],f=u[1];o.from=a,o.to=f,t.doAction("onStyledRangeSliderValueChanged",r,[a,f],"add",o)}else o.term=e,o.list=[e],t.doAction("onStyledSliderValueChanged",r,[e],"add",o)}},onFilterValueChanged:function(t){t.preventDefault();var n=e(t.target).parent(),r=n.attr("data-filter-field"),i=n.attr("data-filter-type"),s=n.attr("data-control-type"),o=this.findActiveFilterByField(r,s);o.userChanged=!0;if(i=="term"){var u,a="add",f=n.find(".data-control-id");switch(s){case"term":u=f.val();break;case"slider":u=f.slider("value");break;case"slider_styled":u=f.attr("value"),u==""&&(u=null);break;case"dropdown":case"dropdown_styled":u=f.val(),u==""&&(u=null);break;case"listbox":u=f.val()}o.term=u,u?o.list=[u]:o.list=[null],this.doAction("onFilterValueChanged",r,o.list,a,o)}else if(i=="list"){var l=new Array,c=n.find(".data-control-id")[0];for(var h in c.options)c.options[h].selected&&l.push(c.options[h].value);o.list=l,this.doAction("onFilterValueChanged",r,l,"add",o)}else if(i=="range"){var p,d,v,m=n.find(".data-control-id-from"),g=n.find(".data-control-id-to"),y=n.find(".data-control-id");switch(s){case"range":p=m.val(),d=g.val();break;case"range_slider":p=y.slider("values",0),d=y.slider("values",1);break;case"range_slider_styled":v=y.attr("value").split(";"),p=v[0],d=v[1];break;case"range_calendar":p=new Date(m.val()),d=new Date(g.val());break;case"dropdown_date_range":p=y.find(":selected").attr("startDate"),d=y.find(":selected").attr("stopDate"),o.term=y.val()}o.from=p,o.to=d,this.doAction("onFilterValueChanged",r,[p,d],"add",o)}},onAddFilterShow:function(t){t.preventDefault();var n=e(t.target);n.hide(),this.el.find("div.js-add").show()},hidePanel:function(t){e(function(){t.hide("blind",{},1e3,function(){})})},getFilterTypeFromControlType:function(e){switch(e){case"dropdown":case"dropdown_styled":case"slider":case"slider_styled":case"radiobuttons":return"term";case"range_slider":case"range_slider_styled":case"range_calendar":case"month_week_calendar":case"dropdown_date_range":return"range";case"list":case"listbox":case"listbox_styled":case"legend":case"multibutton":case"hierarchic_radiobuttons":return"list"}return e},getFieldType:function(e){var t=this._sourceDataset.fields.find(function(t){return t.get("id")===e});return typeof t!="undefined"&&t!=null?t.get("type"):"string"},onAddFilter:function(t){t.preventDefault();var n=e(t.target).parent().parent();n.hide();var r=n.find("select.filterType").val(),i=this.getFilterTypeFromControlType(r),s=n.find("select.fields").val();this.addNewFilterControl({type:i,field:s,controlType:r})},addNewFilterControl:function(e){typeof e.type=="undefined"&&(e.type=this.getFilterTypeFromControlType(e.controlType)),typeof e.fieldType=="undefined"&&(e.fieldType=this.getFieldType(e.field));if(e.controlType=="radiobuttons"||e.controlType=="hierarchic_radiobuttons")e.noAllButton&&e.noAllButton==1?e.useAllButton=!1:e.useAllButton=!0;if(e.controlType=="radiobuttons"||e.controlType=="multibutton")e.useShapeOnly=e.useShapeOnly&&e.useShapeOnly==1;e.controlType=="month_week_calendar"&&(typeof e.period=="undefined"&&(e.period="Months"),typeof e.year=="undefined"&&(e.year=(new Date).getFullYear())),this.activeFilters.push(e)},onPeriodChanged:function(t){t.preventDefault();var n=e(t.target).parent().find(".table"),r=n.attr("data-filter-field"),i=n.attr("data-control-type"),s=n.attr("data-filter-type"),o=this.findActiveFilterByField(r,i);o.period=e(t.target).val(),o.term=null,this.render()},findActiveFilterByField:function(e,t){for(var n in this.activeFilters)if(this.activeFilters[n].field==e&&this.activeFilters[n].controlType==t)return this.activeFilters[n];return new Object},changeFilterField:function(e,t){this.activeFilters[e]&&(this.activeFilters[e].field=t)},onRemoveFilter:function(t){t.preventDefault();var n=e(t.target),r=n.parent().parent().attr("data-filter-field"),i=n.parent().parent().attr("data-control-type"),s=this.findActiveFilterByField(r,i);s.term=undefined,s.value=[],s.userChanged=undefined;if(s.controlType=="list"||s.controlType=="month_week_calendar")$table=n.parent().parent().find(".table"),typeof $table!="undefined"&&$table.find("tr").each(function(){e(this).removeClass(this._selectedClassName)});else if(s.controlType=="slider_styled"){var o=n.parent().parent().find(".slider-styled");o.jslider("value",o.jslider().settings.from)}this.doAction("onRemoveFilter",r,[],"remove",s)},composeStateData:function(){var t=this,n="?",r=[];return e.each(t._sourceDataset.queryState.toJSON(),function(e,t){typeof t=="object"&&(t=JSON.stringify(t)),r.push(e+"="+encodeURIComponent(t))}),r}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.MultiButtonDropdownFilter=Backbone.View.extend({template:'<div class="btn-toolbar">         				<div class="btn-group data-control-id">         				{{^noAllButton}}         					<button type="button" class="btn btn-mini grouped-button AllButton {{allButtonSelected}}" val="All">All</button>         				{{/noAllButton}}     					{{#buttonsData}}         					{{{buttonRender}}}         				{{/buttonsData}}         			</div>         		</div>',buttonTemplate:'<button type="button" class="btn btn-mini grouped-button {{selected}}" val="{{value}}">{{valueLabel}}</button>',buttonTemplate2:'<button type="button" class="btn btn-mini btn-tooltip grouped-button {{selected}}"  data-toggle="tooltip" title="{{descLabel}}" val="{{value}}">{{index}}</button>',dropdownTemplate:'<select id="dropdown{{uid}}_{{numId}}" multiple="multiple">         					{{#options}}         						<option value="{{fullValue}}" {{#selected}}selected="selected"{{/selected}}>{{value}}</option>         					{{/options}}         					</select>',events:{"click .grouped-button":"onButtonsetClicked","click button.select-all-button":"onDropdownSelectAll"},_sourceDataset:null,_selectedClassName:"btn-primary",hasValueChanges:!1,documentClickAssigned:!1,initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","update","onButtonsetClicked","getDropdownSelections","getRecordByValue","handleChangedSelections","onDropdownSelectAll"),this._sourceDataset=t.sourceDataset,this.uid=t.id||Math.floor(Math.random()*1e5),this.numId=0,this.sourceField=t.sourceField,this._actions=t.actions,this.noAllButton=t.sourceField.noAllButton||!1,this.exclusiveButtonValue=t.sourceField.exclusiveButtonValue||(this.noAllButton?undefined:"All"),this.separator=this.sourceField.separator,this.tooltipsOnly=t.tooltipsOnly,this.tooltipValueSeparator=t.tooltipValueSeparator,this.tooltipButtonLabelField=t.tooltipButtonLabelField,this.tooltipButtonDescriptionField=t.tooltipButtonDescriptionField,this._sourceDataset&&(this._sourceDataset.bind("query:done",this.render),this._sourceDataset.queryState.bind("selection:done",this.update)),this.multiSelects=[]},render:function(){var t=this;this.el.html(""),this.numId=0;var n={noAllButton:this.noAllButton};t._sourceDataset&&_.each(t._sourceDataset.queryState.get("selections"),function(e){if(t.sourceField.field=e.field)t.sourceField.list=e.list,t.sourceField.term=e.term}),t.buttonsData={};var r=t._sourceDataset.getRecords();n.allButtonSelected=r&&t.sourceField.list&&r.length==t.sourceField.list.length&&!t.noAllButton;var i=[];_.each(r,function(e,r){var s=t._sourceDataset.fields.get(t.sourceField.field);if(!s)throw"widget.multibutton_dropdown_filter: unable to find field ["+t.sourceField.field+"] in dataset";var o=e.getFieldValue(s),u=e.getFieldValueUnrendered(s),a;t.tooltipButtonLabelField&&(a=e.getFieldValue(t._sourceDataset.fields.get(t.tooltipButtonLabelField)));if(a==null||a=="")a=r;var f;t.tooltipButtonDescriptionField&&(f=e.getFieldValue(t._sourceDataset.fields.get(t.tooltipButtonDescriptionField)));if(!_.contains(i,o)){if(t.separator&&o.indexOf(t.separator)>0){var l=o.split(t.separator,2);t.buttonsData[l[0]]&&t.buttonsData[l[0]].options?t.buttonsData[l[0]].options.push({fullValue:o,value:l[1],record:e,selected:!n.allButtonSelected&&_.contains(t.sourceField.list,o),index:a,descLabel:f}):t.buttonsData[l[0]]={self:t,options:[{fullValue:o,value:l[1],record:e,selected:!n.allButtonSelected&&_.contains(t.sourceField.list,o),index:a,descLabel:f}]}}else t.buttonsData[u]={value:o,valueUnrendered:u,record:e,selected:!n.allButtonSelected&&_.contains(t.sourceField.list,u),self:t,index:a,descLabel:f};i.push(o)}}),t.allValues=i,n.buttonsData=_.map(t.buttonsData,function(e,t){return e});for(var s in n.buttonsData)n.buttonsData[s].options&&(n.buttonsData[s].options=_.sortBy(n.buttonsData[s].options,function(e){return e.value}));n.buttonsData=_.sortBy(n.buttonsData,function(e){return e.options?1:t.exclusiveButtonValue&&t.exclusiveButtonValue==e.valueUnrendered?-1:0}),n.buttonRender=t.buttonRender;var o=Mustache.render(this.template,n);this.el.html(o),t.tooltipsOnly&&t.el.find(".btn-tooltip").tooltip({html:!0,placement:"bottom"});var u=function(t){var n=e(t.context),r=n.find("option").length;if(t.length==0||t.length==r)return this.mainValue;var i="";for(var s=0;s<4&&s<t.length;s++)i+=e(t[s]).text()+", ";return s<t.length&&(i+="... "+(t.length-s)+" other options  "),this.mainValue+' <span style="opacity:0.5">'+i.substr(0,i.length-2)+"</span>"},a=function(n,r){t.hasValueChanges=!0;var i=n.parent(),s=i.data("multiselect").container,o=n.parent().find("[selected='selected']");o.length?e("button",s).addClass(t._selectedClassName):e("button",s).addClass(t._selectedClassName),t.documentClickAssigned||(e(document).on("click.dropdownbtn",function(n){e("button",s).parent().hasClass("open")||t.handleChangedSelections(!0)}),t.documentClickAssigned=!0)},f,l=null;for(var c in t.buttonsData)l==null&&(l=c),t.buttonsData[c].options&&(f=c);var h=0;t.multiSelects=[];for(var c in t.buttonsData)if(t.buttonsData[c].options){var p=e("#dropdown"+this.uid+"_"+h).multiselect({mainValue:c,buttonClass:"btn btn-mini"+(c==f?" btn-last":""),buttonClassFirst:"btn btn-mini"+(c==l?" btn-first":""),buttonText:u,onChange:a}),d=p.data("multiselect").container;_.find(t.buttonsData[c].options,function(e){return e.selected})&&e("button",d).addClass(t._selectedClassName),t.multiSelects.push(p),h++}},buttonRender:function(){var e=this,t=e.self,n={};return e.options?(n.numId=t.numId,n.uid=t.uid,n.options=e.options,t.numId++,Mustache.render(t.dropdownTemplate,n)):(n.index=e.index,n.value=e.valueUnrendered,e.selected&&(n.selected=" "+t._selectedClassName+" "),t.tooltipsOnly?((e.descLabel||e.value)&&t.tooltipValueSeparator?e.descLabel?n.descLabel=e.descLabel.split(t.tooltipValueSeparator).join("<br/>"):n.descLabel=e.value.split(t.tooltipValueSeparator).join("<br/>"):e.descLabel?n.descLabel=e.descLabel||"":n.descLabel=e.value||"",Mustache.render(t.buttonTemplate2,n)):(n.valueLabel=e.value,Mustache.render(t.buttonTemplate,n)))},update:function(){var t=this;if(t.sourceField.userChanged){t.sourceField.userChanged=!1;return}_.each(t._sourceDataset.queryState.get("selections"),function(e){if(t.sourceField.field=e.field)t.sourceField.list=e.list,t.sourceField.term=e.term});var n=this.computeUserChoices(t.sourceField),r=t._sourceDataset.getRecords();r&&t.sourceField.list&&r.length==t.sourceField.list.length&&!t.noAllButton?t.el.find("div.btn-toolbar button.AllButton").addClass(t._selectedClassName):(t.el.find("div.btn-toolbar button").not(".select-all-button").each(function(){e(this).hasClass("dropdown-toggle")||(_.contains(n,e(this).attr("val"))?(e(this).addClass(t._selectedClassName),n=_.without(n,e(this).attr("val"))):(e(this).removeClass(t._selectedClassName),n=_.without(n,e(this).attr("val"))))}),_.each(t.multiSelects,function(r){_.each(r.find("option"),function(i){_.contains(n,e(i).val())?(e(i).attr("selected","selected"),n=_.without(n,e(i).val())):e(i).removeAttr("selected");var s=r.data("multiselect").container;r.find("option:selected").length?e("button",s).addClass(t._selectedClassName):e("button",s).removeClass(t._selectedClassName)})}))},computeUserChoices:function(e){var t=e.list;return(typeof t=="undefined"||t==null)&&e.term&&(t=[e.term]),t},onButtonsetClicked:function(t){var n=this;t.preventDefault();var r=e(t.currentTarget);!r.hasClass(n._selectedClassName)&&n.exclusiveButtonValue&&(n.exclusiveButtonValue==r.attr("val")?(n.el.find("div.btn-toolbar button."+n._selectedClassName).not(".select-all-button").each(function(){e(this).hasClass("dropdown-toggle")||e(this).removeClass(n._selectedClassName)}),_.each(n.multiSelects,function(t){_.each(t.find("option[selected='selected']"),function(t){e(t).removeAttr("selected")});var r=t.data("multiselect").container;_.each(r.find("button."+n._selectedClassName),function(t){e(t).removeClass(n._selectedClassName)}),t.multiselect("refresh")})):r.parent().find("button.grouped-button[val='"+n.exclusiveButtonValue+"']").removeClass(n._selectedClassName)),r.toggleClass(n._selectedClassName),this.handleChangedSelections()},onDropdownSelectAll:function(t){var n=this;n.hasValueChanges=!0;var r=e(t.currentTarget),i=r.parent().prev("select"),s=i.data("multiselect").container,o=i.find("[selected='selected']"),u=i.find("option");o.length>0&&u.length>o.length||!r.hasClass(n._selectedClassName)?(_.each(u,function(t){e(t).attr("selected","selected")}),e("button",s).addClass(n._selectedClassName)):(_.each(u,function(t){e(t).removeAttr("selected")}),e("button",s).removeClass(n._selectedClassName)),i.multiselect("refresh"),n.handleChangedSelections(!0)},handleChangedSelections:function(t){var n=this;e(document).off("click.dropdownbtn"),n.documentClickAssigned=!1,e("div.btn-toolbar .btngroup-multiselect.open").removeClass("open"),t&&n.el.find("div.btn-toolbar button.grouped-button[val='"+n.exclusiveButtonValue+"']").removeClass(n._selectedClassName);var r=[];n.el.find("div.btn-toolbar button."+n._selectedClassName).not(".select-all-button").each(function(){e(this).hasClass("dropdown-toggle")||r.push(e(this).attr("val").valueOf())}),r.length==1&&r[0]=="All"?r=n.allValues:r=r.concat(n.getDropdownSelections());var i=[];_.each(r,function(e){i.push(n.getRecordByValue(e))}),n.hasValueChanges=!1,n.sourceField.userChanged=!0,n.sourceField.list=r;var s=n.options.actions;s.forEach(function(e){e.action.doAction(i,e.mapping)})},getDropdownSelections:function(){var t=this,n=[];return _.each(t.multiSelects,function(t){_.each(t.find("option[selected='selected']"),function(t){n.push(e(t).val())})}),n},getRecordByValue:function(e){var t=this;if(t.buttonsData[e])return t.buttonsData[e].record;if(t.separator){var n=e.split(t.separator,2);if(t.buttonsData[n[0]]){var r=_.find(t.buttonsData[n[0]].options,function(t){return t.fullValue==e});if(r)return r.record}}return null}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.VisualSearch=Backbone.View.extend({template:'<div id="search_box_container" id="{{uid}}"> </div><div id="search_query">&nbsp;</div>',initialize:function(t){var n=this;this.el=e(this.el),_.bindAll(this,"render","redraw"),this.uid=t.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4)},render:function(){var e=this,t=Mustache.render(this.template,this);return this.el.html(t),this},redraw:function(){var t=this;console.log(e().jquery),console.log(e.ui.version),window.visualSearch=VS.init({container:e("#search_box_container"),query:'country: "South Africa" account: 5-samuel "U.S. State": California',showFacets:!0,unquotable:["text","account","filter","access"],callbacks:{search:function(t,n){var r=e("#search_query");r.stop().animate({opacity:1},{duration:300,queue:!1}),r.html('<span class="raquo">&raquo;</span> You searched for: <b>'+n.serialize()+"</b>"),clearTimeout(window.queryHideDelay),window.queryHideDelay=setTimeout(function(){r.animate({opacity:0},{duration:1e3,queue:!1})},2e3)},valueMatches:function(e,t,n){switch(e){case"account":n([{value:"1-amanda",label:"Amanda"},{value:"2-aron",label:"Aron"},{value:"3-eric",label:"Eric"},{value:"4-jeremy",label:"Jeremy"},{value:"5-samuel",label:"Samuel"},{value:"6-scott",label:"Scott"}]);break;case"filter":n(["published","unpublished","draft"]);break;case"access":n(["public","private","protected"]);break;case"title":n(["Pentagon Papers","CoffeeScript Manual","Laboratory for Object Oriented Thinking","A Repository Grows in Brooklyn"]);break;case"city":n(["Cleveland","New York City","Brooklyn","Manhattan","Queens","The Bronx","Staten Island","San Francisco","Los Angeles","Seattle","London","Portland","Chicago","Boston"]);break;case"U.S. State":n(["Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","District of Columbia","Florida","Georgia","Guam","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Puerto Rico","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Virgin Islands","Washington","West Virginia","Wisconsin","Wyoming"]);break;case"country":n(["China","India","United States","Indonesia","Brazil","Pakistan","Bangladesh","Nigeria","Russia","Japan","Mexico","Philippines","Vietnam","Ethiopia","Egypt","Germany","Turkey","Iran","Thailand","D. R. of Congo","France","United Kingdom","Italy","Myanmar","South Africa","South Korea","Colombia","Ukraine","Spain","Tanzania","Sudan","Kenya","Argentina","Poland","Algeria","Canada","Uganda","Morocco","Iraq","Nepal","Peru","Afghanistan","Venezuela","Malaysia","Uzbekistan","Saudi Arabia","Ghana","Yemen","North Korea","Mozambique","Taiwan","Syria","Ivory Coast","Australia","Romania","Sri Lanka","Madagascar","Cameroon","Angola","Chile","Netherlands","Burkina Faso","Niger","Kazakhstan","Malawi","Cambodia","Guatemala","Ecuador","Mali","Zambia","Senegal","Zimbabwe","Chad","Cuba","Greece","Portugal","Belgium","Czech Republic","Tunisia","Guinea","Rwanda","Dominican Republic","Haiti","Bolivia","Hungary","Belarus","Somalia","Sweden","Benin","Azerbaijan","Burundi","Austria","Honduras","Switzerland","Bulgaria","Serbia","Israel","Tajikistan","Hong Kong","Papua New Guinea","Togo","Libya","Jordan","Paraguay","Laos","El Salvador","Sierra Leone","Nicaragua","Kyrgyzstan","Denmark","Slovakia","Finland","Eritrea","Turkmenistan"],{preserveOrder:!0})}},facetMatches:function(e){e(["account","filter","access","title",{label:"city",category:"location"},{label:"address",category:"location"},{label:"country",category:"location"},{label:"U.S. State",category:"location"}])}}})},doActions:function(e,t){_.each(e,function(e){e.action.doAction(t,e.mapping)})},getActionsForEvent:function(e){var t=this,n=[];return _.each(t.options.actions,function(t){_.contains(t.event,e)&&n.push(t)}),n}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.D3Bubble=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;"><div id="{{uid}}_graph" class="span11"></div><div class="span1" style="padding-left:30px;"><div id="{{uid}}_legend_color"  style="width:{{color_legend_width}}px;height:{{color_legend_height}}px"></div><div id="{{uid}}_legend_size" style="width:{{size_legend_width}}px;height:{{size_legend_height}}px"></div></div></div>',tooltipTemplate:"<div> 	    		<b>{{title}}</b><br> 	    		{{dim1Label}}: {{dim1Value}}<br> 	    		{{dim2Label}}: {{dim2Value}}<br> 	    		{{dim3Label}}: {{dim3Value}}<br> 	    		{{dim4Label}}: {{dim4Value}}<br> 			</div>",brushstart:function(){return[]},brushend:function(e){return function(){return e.trigger("zoom",{xRange:e.xRange,yRange:e.yRange}),[]}},brush:function(e){return function(){var t;return t=d3.event.target.extent(),e.xRange=[t[0][0],t[1][0]],e.yRange=[t[0][1],t[1][1]],[]}},xRange:null,yRange:null,initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),e(window).resize(this.resize),this.uid=t.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.margin={top:19.5,right:19.5,bottom:19.5,left:50},this.width=t.width-this.margin.right,this.bubbleWidth=this.width*.9,this.legendWidth=this.width*.1,this.height=t.height-this.margin.top-this.margin.bottom,this.options.state.colorLegend&&(this.options.state.colorLegend.margin=this.options.state.colorLegend.margin||[],this.color_legend_width=this.options.state.colorLegend.width+(this.options.state.colorLegend.margin.right||0)+(this.options.state.colorLegend.margin.left||this.options.state.colorLegend.margin.right||0),this.color_legend_height=this.options.state
.colorLegend.height+(this.options.state.colorLegend.margin.top||0)+(this.options.state.colorLegend.margin.bottom||this.options.state.colorLegend.margin.top||0)),this.options.state.sizeLegend&&(this.options.state.sizeLegend.margin=this.options.state.sizeLegend.margin||[],this.size_legend_width=this.options.state.sizeLegend.width+(this.options.state.sizeLegend.margin.right||0)+(this.options.state.sizeLegend.margin.left||this.options.state.sizeLegend.margin.right||0),this.size_legend_height=this.options.state.sizeLegend.height+(this.options.state.sizeLegend.margin.top||0)+(this.options.state.sizeLegend.margin.bottom||this.options.state.sizeLegend.margin.top||0)),this.options.state.customTooltipTemplate&&(this.tooltipTemplate=this.options.state.customTooltipTemplate);var n=Mustache.render(this.template,this);this.el.html(n)},render:function(){var e=this,t="#"+this.uid+"_graph",n="#"+this.uid+"_legend_color",r="#"+this.uid+"_legend_size";e.graph&&(jQuery(t).empty(),jQuery(n).empty(),jQuery(r).empty()),e.graph=d3.select(t)},redraw:function(){var e=this;if(!e.visible)return;var t=e.options.state,n;this.options.resultType&&(n=this.options.resultType);var r=[Infinity,-Infinity],i=[Infinity,-Infinity],s=[Infinity,-Infinity],o=[Infinity,-Infinity],u=this.options.model.fields.get(t.colorField.field);this.colorDataFormat="number";if(u.type=="string"||u.attributes.type=="string")o=_.unique(_.map(e.options.model.getRecords(n),function(e){return e.attributes[t.colorField.field]})),this.colorDataFormat="string";var a=_.map(this.options.model.getRecords(n),function(n){return t.domains=t.domains||{},r=t.domains.xDomain||[Math.min(r[0],n.attributes[t.xField.field]),Math.max(r[1],n.attributes[t.xField.field])],i=t.domains.yDomain||[Math.min(i[0],n.attributes[t.yField.field]),Math.max(i[1],n.attributes[t.yField.field])],s=t.domains.sizeDomain||[Math.min(s[0],n.attributes[t.sizeField.field]),Math.max(s[1],n.attributes[t.sizeField.field])],e.colorDataFormat!="string"&&(o=t.domains.colorDomain||[Math.min(o[0],n.attributes[t.colorField.field]),Math.max(o[1],n.attributes[t.colorField.field])]),{key:n.attributes[t.keyField.field],color:n.attributes[t.colorField.field],x:n.attributes[t.xField.field],size:n.attributes[t.sizeField.field],y:n.attributes[t.yField.field],color_formatted:n.getFieldValue(e.model.fields.get(t.colorField.field)),x_formatted:n.getFieldValue(e.model.fields.get(t.xField.field)),y_formatted:n.getFieldValue(e.model.fields.get(t.yField.field)),size_formatted:n.getFieldValue(e.model.fields.get(t.sizeField.field))}});s[0]==s[1]&&(s=[s[0]/2,s[0]*2]),e.colorDataFormat!="string"&&o[0]==o[1]&&(o=[o[0]/2,o[0]*2]),r[0]==r[1]&&(r=[r[0]/2,r[0]*2]),i[0]==i[1]&&(i=[i[0]/2,i[0]*2]),typeof t.xField.scale=="undefined"&&(t.xField.scale=d3.scale.linear()),typeof t.yField.scale=="undefined"&&(t.yField.scale=d3.scale.linear()),typeof t.sizeField.scale=="undefined"&&(t.sizeField.scale=d3.scale.linear()),typeof t.colorField.scale=="undefined"&&(this.colorDataFormat=="string"?t.colorField.scale=d3.scale.ordinal():t.colorField.scale=d3.scale.linear()),e.xScale=t.xField.scale.domain(r).range([0,e.bubbleWidth]),e.yScale=t.yField.scale.domain(i).range([e.height,0]),e.sizeScale=t.sizeField.scale.domain(s).range([2,20]),e.colorDataFormat=="string"?e.colorScale=d3.scale.category20().domain(o):e.colorScale=t.colorField.scale.domain(o),t.colorLegend&&(e.colorDataFormat=="string"?e.drawLegendColorString(o):e.drawLegendColor(o)),t.sizeLegend&&e.drawLegendSize(s[0],s[1]),e.xAxisTitle=t.xAxisTitle,e.yAxisTitle=t.yAxisTitle,e.colorTitle=t.colorField.label,e.sizeTitle=t.sizeField.label,e.graph=d3.select("#"+e.uid+"_graph"),this.drawD3(a)},drawLegendSize:function(t,n){var r=this,i=r.options.state.sizeLegend,s=r.size_legend_width,o=r.size_legend_height;i.margin=e.extend({top:0,right:0,bottom:0,left:0},i.margin);var u=20,a=i.numElements||3,f="#"+this.uid+"_legend_size",l=s/2-i.width/2||0,c=i.margin.top||0,h=d3.select(f).append("svg").attr("width",s).attr("height",o),p=d3.range(a),d=[],v=(i.height-u*2-a)/a,m=_.map(p,function(e){return e*(n-t)/(a-1)+t}),g=h.selectAll("circle").data(m);g.enter().append("circle").attr({width:i.width,height:v,cy:function(e,t){var i=r.sizeScale(e),s=r.sizeScale(n);return s*2-i+5},cx:i.margin.left+r.sizeScale(n),r:function(e,t){return r.sizeScale(e)},fill:"none",stroke:"black","stroke-width":"1","stroke-dasharray":"2,2"}),_.map([t,(n-t)/2,n],function(e){return e>1e3?d3.format("s")(Math.round(e)):d3.format(".2f")(e)}),h.selectAll(".label").data(m).enter().append("text").attr("class","y label").attr("text-anchor","middle").attr("y",function(e,t){var i=r.sizeScale(e),s=r.sizeScale(n);return s*2-i*2+10}).attr("x",l+r.sizeScale(n)*4).text(function(e){return e>1e3?d3.format("s")(Math.round(e)):d3.format(".2f")(e)})},drawLegendColorString:function(t){var n=this,r=n.options.state.colorLegend,i=n.color_legend_width,s=this.color_legend_height;r.margin=e.extend({top:0,right:0,bottom:0,left:0},r.margin);var o=20,u=20,a="#"+this.uid+"_legend_color",f=o/2||0,l=r.margin.top||0,c=d3.select(a).append("svg").attr("width",i).attr("height",s),h,p,d,v;h=t,p=function(e){return n.colorScale(e)},d=t.length,v=t;var m=[],g=c.selectAll("rect").data(h),y=(r.height-u*2-d)/d;g.enter().append("rect").attr({width:o,height:y,y:function(e,t){return l+5+t*(y+1)},x:f,fill:function(e,t){return p(e)}}),c.selectAll(".label").data(v).enter().append("text").attr("class","y label").attr("text-anchor",function(){return"left"}).attr("y",function(e,t){return l+9+y/2+t*(y+1)}).attr("x",function(){return f+o+3}).text(function(e){return e})},drawLegendColor:function(t){var n=this,r=t[0],i=t[1],s=n.options.state.colorLegend,o=n.color_legend_width,u=this.color_legend_height;s.margin=e.extend({top:0,right:0,bottom:0,left:0},s.margin);var a=20,f=20,l=s.numElements||15;n.colorDataFormat=="string"&&(l=t.length);var c="#"+this.uid+"_legend_color",h=o/2-a/2||0,p=s.margin.top||0,d=d3.select(c).append("svg").attr("width",o).attr("height",u),v=d3.range(l),m=[],g=d.selectAll("rect").data(v),y=(s.height-f*2-l)/l;g.enter().append("rect").attr({width:a,height:y,y:function(e,t){return p+5+t*(y+1)},x:h,fill:function(e,t){return n.colorScale(e*(i-r)/l+r)}});var b=_.map([r,i],function(e){return e>1e3?d3.format("s")(Math.round(e)):d3.format(".2f")(e)});d.selectAll(".label").data(b).enter().append("text").attr("class","y label").attr("text-anchor","middle").attr("y",function(e,t){return(s.height-f)/(b.length-1)*t+f/2}).attr("x",(o/2-s.width/2||0)+s.width/2).text(function(e){return e})},drawD3:function(e){function n(e){return e.x}function r(e){return e.y}function i(e){return e.size}function s(e){return e.color}function o(e){return e.key}function c(e){e.attr("cx",function(e){return t.xScale(n(e))}).attr("cy",function(e){return t.yScale(r(e))}).attr("r",function(e){return t.sizeScale(i(e))})}function h(e,t){return i(t)-i(e)}var t=this,u=d3.svg.axis().orient("bottom").scale(t.xScale).tickFormat(d3.format("s")),a=d3.svg.axis().scale(t.yScale).orient("left").tickFormat(d3.format("s")),f=t.graph.append("svg").attr("width",t.bubbleWidth+t.margin.left+t.margin.right).attr("height",t.height+t.margin.top+t.margin.bottom).append("g").attr("transform","translate("+t.margin.left+","+t.margin.top+")");f.append("g").attr("class","x axis").attr("transform","translate(0,"+t.height+")").call(u),f.append("g").attr("class","y axis").call(a),f.append("text").attr("class","x label").attr("text-anchor","end").attr("x",t.bubbleWidth).attr("y",t.height-6).text(t.xAxisTitle),f.append("text").attr("class","y label").attr("text-anchor","end").attr("y",6).attr("dy",".75em").attr("transform","rotate(-90)").text(t.yAxisTitle),f.append("g").attr("class","brush").call(d3.svg.brush().x(t.xScale).y(t.yScale).on("brushstart",t.brushstart).on("brush",t.brush(this)).on("brushend",t.brushend(this)));var l=f.append("g").attr("class","dots").selectAll(".dot").data(e).enter().append("circle").attr("class","dot").style("fill",function(e){return t.colorScale(s(e))}).call(c).sort(h).on("mouseover",t.handleMouseover(t)).on("mouseout",t.mouseout);t.alreadyDrawed=!0},handleMouseover:function(t){return function(n){var r=e(t.el).position(),i=this.getBoundingClientRect(),s=document.body.getBoundingClientRect(),o={left:i.left+i.width/2,top:i.top+i.height/2-s.top},u={title:n.key,dim1Label:t.xAxisTitle||"X",dim1Value:n.x_formatted,dim2Label:t.yAxisTitle||"Y",dim2Value:n.y_formatted,dim3Label:t.colorTitle||"Color",dim3Value:n.color_formatted,dim4Label:t.sizeTitle||"Size",dim4Value:n.size_formatted},a=Mustache.render(t.tooltipTemplate,u),f=e(t.el),l=o.top<f[0].offsetTop+f.height()/2?"n":"s";nv.tooltip.show([o.left,o.top],a,l,null,f[0])}},mouseout:function(){nv.tooltip.cleanup()}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.D3Bullet=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;">',firstResizeDone:!1,initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","redraw","resize"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),e(window).resize(this.resize),this.uid=t.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),t.width?this.width=t.width:this.width="100",t.height?this.height=t.height:this.height="100",this.options.animation||(this.options.animation={duration:2e3,delay:200});var n=Mustache.render(this.template,this);this.el.html(n)},resize:function(){this.firstResizeDone=!0;var t=e("#"+this.uid).height(),n=e("#"+this.uid).width(),r=this.el,i=r.height(),s=r.width();typeof this.options.width=="undefined"&&(e("#"+this.uid).width(s),this.width=s),typeof this.options.height=="undefined"&&(e("#"+this.uid).height(i),this.height=i),this.redraw()},render:function(){var e=this,t="#"+this.uid;e.graph&&jQuery(t).empty(),e.graph=d3.select(t),e.firstResizeDone||e.resize()},redraw:function(){var e=this,t;this.options.resultType&&(t=this.options.resultType);var n=_.map(this.options.model.getRecords(t),function(n){var r=[];_.each(e.options.fieldRanges,function(i){var s=t?e.model[t].fields.get(i):e.model.fields.get(i);r.push(n.getFieldValueUnrendered(s))});var i=[];_.each(e.options.fieldMeasures,function(r){var s=t?e.model[t].fields.get(r):e.model.fields.get(r);i.push(n.getFieldValueUnrendered(s))});var s=[];return _.each(e.options.fieldMarkers,function(r){var i=t?e.model[t].fields.get(r):e.model.fields.get(r);s.push(n.getFieldValueUnrendered(i))}),{ranges:r,measures:i,markers:s,customTicks:e.options.customTicks,tickFormat:e.options.tickFormat}}),r={top:5,right:40,bottom:40,left:40},i=e.width-r.left-r.right,s=e.height-r.top-r.bottom;i<0&&(i=0),s<0&&(s=0),e.plugin(),this.chart=d3.bullet().width(i).height(s),this.drawD3(n,i,s,r)},drawD3:function(e,t,n,r){var i=this;i.graph.selectAll(".bullet").remove(),i.graph.selectAll(".bullet").data(e).enter().append("svg").attr("class","bullet").attr("width",t+r.left+r.right).attr("height",n+r.top+r.bottom).append("g").attr("transform","translate("+r.left+","+r.top+")").call(i.chart),i.alreadyDrawed=!0},plugin:function(){function e(e){return e.tickFormat}function t(e){return e.customTicks}function n(e){return e.ranges}function r(e){return e.markers}function i(e){return e.measures}function s(e){return function(t){return"translate("+e(t)+",0)"}}function o(e){var t=e(0);return function(n){return Math.abs(e(n)-t)}}d3.bullet=function(){function g(e){e.each(function(e,t){var n=l.call(this,e,t).slice().sort(d3.descending),r=c.call(this,e,t).slice().sort(d3.descending),i=h.call(this,e,t).slice().sort(d3.descending),u=m.call(this,e,t),g=v.call(this,e,t),y=d3.select(this),b=d3.scale.linear().domain([0,Math.max(n[0],r[0],i[0])]).range(a?[p,0]:[0,p]),w=this.__chart__||d3.scale.linear().domain([0,Infinity]).range(b.range());this.__chart__=b;var E=o(w),S=o(b),x=y.selectAll("rect.range").data(n);x.enter().append("rect").attr("class",function(e,t){return"range s"+t}).attr("width",E).attr("height",d).attr("x",a?w:0).transition().duration(f).attr("width",S).attr("x",a?b:0),x.transition().duration(f).attr("x",a?b:0).attr("width",S).attr("height",d);var T=y.selectAll("rect.measure").data(i);T.enter().append("rect").attr("class",function(e,t){return"measure s"+t}).attr("width",E).attr("height",function(e,t){return d/(t*4+3)}).attr("x",a?w:0).attr("y",function(e,t){return(d/3-d/(t*4+3))/2+d/3}).transition().duration(f).attr("width",S).attr("x",a?b:0),T.transition().duration(f).attr("width",S).attr("height",function(e,t){return d/(t*4+3)}).attr("x",a?b:0).attr("y",function(e,t){return(d/3-d/(t*4+3))/2+d/3});var N=y.selectAll("line.marker").data(r);N.enter().append("line").attr("class","marker").attr("x1",w).attr("x2",w).attr("y1",d/6).attr("y2",d*5/6).transition().duration(f).attr("x1",b).attr("x2",b),N.transition().duration(f).attr("x1",b).attr("x2",b).attr("y1",d/6).attr("y2",d*5/6);var C=g||b.tickFormat(8),k=y.selectAll("g.tick").data(b.ticks(8),function(e){return this.textContent||C(e)}),L=k.enter().append("g").attr("class","tick").attr("transform",s(w)).style("opacity",1e-6),A=-1,O=function(){return u&&u[++A]?u[A]:""};L.append("line").attr("y1",d).attr("y2",d*7/6),L.append("text").attr("text-anchor","middle").attr("dy","1em").attr("y",d*7/6).text(u?O:C),L.transition().duration(f).attr("transform",s(b)).style("opacity",1);var M=k.transition().duration(f).attr("transform",s(b)).style("opacity",1);M.select("line").attr("y1",d).attr("y2",d*7/6),M.select("text").attr("y",d*7/6),k.exit().transition().duration(f).attr("transform",s(b)).style("opacity",1e-6).remove()}),d3.timer.flush()}var u="left",a=!1,f=0,l=n,c=r,h=i,p=380,d=30,v=e,m=t;return g.orient=function(e){return arguments.length?(u=e,a=u=="right"||u=="bottom",g):u},g.ranges=function(e){return arguments.length?(l=e,g):l},g.markers=function(e){return arguments.length?(c=e,g):c},g.measures=function(e){return arguments.length?(h=e,g):h},g.width=function(e){return arguments.length?(p=e,g):p},g.height=function(e){return arguments.length?(d=e,g):d},g.tickFormat=function(e){return arguments.length?(v=e,g):v},g.customTicks=function(e){return arguments.length?(m=e,g):m},g.duration=function(e){return arguments.length?(f=e,g):f},g}}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.D3CalendarView=Backbone.View.extend({template:"<style>         	.calendar-view {         	  shape-rendering: crispEdges;         	}         	.calendar-view svg .day {         	  fill: #fff;         	  stroke: #ccc;         	}         	.calendar-view svg  .month {         	  fill: none;         	  stroke: #000;         	  stroke-width: 2px;         	}     		.calendar-view svg.RdYlGn .q0-11{fill:rgb(165,0,38)}     		.calendar-view svg.RdYlGn .q1-11{fill:rgb(215,48,39)}     		.calendar-view svg.RdYlGn .q2-11{fill:rgb(244,109,67)}     		.calendar-view svg.RdYlGn .q3-11{fill:rgb(253,174,97)}     		.calendar-view svg.RdYlGn .q4-11{fill:rgb(254,224,139)}     		.calendar-view svg.RdYlGn .q5-11{fill:rgb(255,255,191)}     		.calendar-view svg.RdYlGn .q6-11{fill:rgb(217,239,139)}     		.calendar-view svg.RdYlGn .q7-11{fill:rgb(166,217,106)}     		.calendar-view svg.RdYlGn .q8-11{fill:rgb(102,189,99)}     		.calendar-view svg.RdYlGn .q9-11{fill:rgb(26,152,80)}     		.calendar-view svg.RdYlGn .q10-11{fill:rgb(0,104,55)}     	</style>",initialize:function(t){var n=this;_.bindAll(this,"render"),this.model=t.model,this.model.bind("query:done",this.render),this.el=t.el,e(this.el).addClass("calendar-view"),this.dateField=t.dateField,this.valueField=t.valueField,this.scaleDomain=t.valueDomain;var r=Mustache.render(this.template,this);e(this.el).html(r)},render:function(){function t(e){return e.getDate?e:Date.parse(e)||Date.parse(e.replace(/\.\d\d\d\+\d+$/,""))||Date.parse(e.split("T")[0])||new Date(e)}var e=this;if(this.model.getRecords().length){var n=e.options.cellSize*56||960,r=e.options.cellSize*8||136,i=e.options.cellSize||17,s=d3.time.format("%w"),o=d3.time.format("%U"),u=d3.format(".1%"),a=d3.time.format("%Y-%m-%d"),f=d3.scale.quantize().domain(e.scaleDomain).range(d3.range(11).map(function(e){return"q"+e+"-11"})),l=this.model.getRecords(),c,h;_.each(l,function(n){var r=t(n.attributes[e.dateField]).getFullYear();c?c>r&&(c=r):c=r,h?h<r&&(h=r):h=r});var p=d3.range(c,h);c==h&&(p=[c]);var d=d3.nest().key(function(n){return t(n.attributes[e.dateField]).toString("yyyy-MM-dd")}).rollup(function(t){return t[0].attributes[e.valueField]||0}).map(l);d3.select(this.el).selectAll("svg").data([]).exit().remove();var v=d3.select(this.el).selectAll("svg").data(p).enter().append("svg").attr("width",n).attr("height",r).attr("class","RdYlGn").append("g").attr("transform","translate("+(n-i*53)/2+","+(r-i*7-1)+")");v.append("text").attr("transform","translate(-6,"+i*3.5+")rotate(-90)").style("text-anchor","middle").text(function(e){return e});var m=v.selectAll(".day").data(function(e){return d3.time.days(new Date(e,0,1),new Date(e+1,0,1))}).enter().append("rect").attr("class","day").attr("width",i).attr("height",i).attr("x",function(e){return o(e)*i}).attr("y",function(e){return s(e)*i}).datum(a);m.append("title").text(function(e){return e});function g(e){var t=new Date(e.getFullYear(),e.getMonth()+1,0),n=+s(e),r=+o(e),u=+s(t),a=+o(t);return"M"+(r+1)*i+","+n*i+"H"+r*i+"V"+7*i+"H"+a*i+"V"+(u+1)*i+"H"+(a+1)*i+"V"+0+"H"+(r+1)*i+"Z"}v.selectAll(".month").data(function(e){return d3.time.months(new Date(e,0,1),new Date(e+1,0,1))}).enter().append("path").attr("class","month").attr("d",g),m.filter(function(e){return e in d}).attr("class",function(e){return"day "+f(d[e])}).select("title").text(function(e){return e+": "+d[e]}),d3.select(e.frameElement).style("height",r+"px")}}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.D3Chord=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;"></div>',initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=t.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.width=t.width,this.height=t.height;var n=Mustache.render(this.template,this);this.el.html(n)},render:function(){var e=this;e.trigger("chart:startDrawing");var t="#"+this.uid;e.graph&&jQuery(t).empty(),e.graph=d3.select(t),e.trigger("chart:endDrawing")},redraw:function(){if(!this.visible)return;var e=this;e.trigger("chart:startDrawing");var t=e.options.state,n;this.options.resultType&&(n=this.options.resultType);var r={},i=[],s=0,o=[],u=this.options.model.fields.get(t.valueField);if(!u)throw"d3.chord.js: unable to fiend field ["+t.valueField+"] in model";_.each(this.options.model.getRecords(n),function(e){var n=r[e.attributes[t.startField]];n==null&&(r[e.attributes[t.startField]]=s,n=s,i[s]=e.attributes[t.startField],s++);var a=r[e.attributes[t.endField]];a==null&&(a=s,r[e.attributes[t.endField]]=s,i[s]=e.attributes[t.endField],s++),o[n]||(o[n]=[]),o[n][a]=e.getFieldValueUnrendered(u)});for(var a=0;a<s;a++)for(var f=0;f<s;f++)o[a]||(o[a]=[]),o[a][f]||(o[a][f]=0);e.graph=d3.select("#"+e.uid),this.drawD3(i,o),e.trigger("chart:endDrawing")},drawD3:function(e,t){function w(e,t){b.classed("fade",function(e){return e.source.index!=t&&e.target.index!=t})}var n=this,r=0;for(var i=0;i<t.length;i++)for(var s=0;s<t[i].length;s++)r+=t[i][s];var o=n.options.state,u=d3.scale.category20(),a=Math.min(n.width,n.height)/2-10,f=a-24,l=o.numberFormat||d3.format(",.2f"),c=function(e){return l(e)+" ["+d3.format(".1%")(e/r)+"]"},h=d3.svg.arc().innerRadius(f).outerRadius(a),p=d3.layout.chord().padding(.04).sortSubgroups(d3.descending).sortChords(d3.ascending),d=d3.svg.chord().radius(f),v=n.graph.append("svg").attr("width",n.width).attr("height",n.height).append("g").attr("id","circle").attr("transform","translate("+n.width/2+","+n.height/2+")");v.append("circle").attr("r",a),p.matrix(t);var m=v.selectAll(".group").data(p.groups).enter().append("g").attr("class","group").on("mouseover",w);m.append("title").text(function(t,n){return e[n]+": "+c(t.value,r)+" of origins"});var g=m.append("path").attr("id",function(e,t){return"group"+t}).attr("d",h).style("fill",function(e,t){return u(t)}),y=m.append("text").attr("x",6).attr("dy",15);y.append("textPath").attr("xlink:href",function(e,t){return"#group"+t}).text(function(t,n){return e[n]}),y.filter(function(e,t){return g[0][t].getTotalLength()/2-16<this.getComputedTextLength()}).remove();var b=v.selectAll(".chord").data(p.chords).enter().append("path").attr("class","chord").style("fill",function(e){return u(e.source.index)}).attr("d",d);b.append("title").text(function(t){return e[t.source.index]+" → "+e[t.target.index]+": "+c(t.source.value)+"\n"+e[t.target.index]+" → "+e[t.source.index]+": "+c(t.target.value)}),n.alreadyDrawed=!0}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.D3ChoroplethMap=Backbone.View.extend({rendered:!1,template:'{{#showZoomCtrl}}<input type="range" id="mapZoomCtrl" step="500" min="0" max="30000" value="{{scale}}"     				{{#mapWidth}} width={{mapWidth}}{{/mapWidth}}     				{{#mapHeight}} height={{mapHeight}}{{/mapHeight}}     			  >Zoom</input>{{/showZoomCtrl}}     			  <svg x="0" y="0" xmlns="http://www.w3.org/2000/svg" version="1.1" style="{{svgStyle}}">     			  		<g class="regions"></g>     					<g class="regionLabels" pointer-events="none"></g>     					<g class="places" pointer-events="none"></g>     				</svg>',events:{"change #mapZoomCtrl":"onZoomChanged"},initialize:function(t){var n=this;_.bindAll(this,"render","redraw","getRecordByValue","getActionsForEvent","onZoomChanged","getLabelFor"),this.model.bind("change",n.render),this.model.fields.bind("reset",n.render),this.model.fields.bind("add",n.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=""+(new Date).getTime()+Math.floor(Math.random()*1e4),this.el=t.el,this.unselectedColor="#C0C0C0",this.options.state.unselectedColor&&(this.unselectedColor=this.options.state.unselectedColor),this.mapWidth=this.options.state.width,this.mapHeight=this.options.state.height;var r="";this.options.state.svgStyle&&(r=this.options.state.svgStyle);if(this.mapWidth==null||typeof this.mapWidth=="undefined")this.mapWidth=e(this.el).width();if(this.mapHeight==null||typeof this.mapHeight=="undefined")this.mapHeight=e(this.el).height();this.scale=this.options.state.scale,this.fieldLabels=this.options.state.fieldLabels;var i={scale:this.scale,mapWidth:this.mapWidth,mapHeight:this.mapHeight,svgStyle:r},s=Mustache.render(this.template,i);e(this.el).html(s),this.svg=d3v3.select(this.el+" svg")},getLabelFor:function(e){return this.fieldLabels&&this.fieldLabels[e]?this.fieldLabels[e]:e},render:function(){var t=this,n=this.options.state.mapJson,r=this.options.state.layer,i=this.options.state.showRegionNames,s=this.options.state.showCities,o=this.options.state.randomColors,u=t.options.state.rotation;if(u==null||u=="undefined")u=[0,0];var a=function(){e(t.el+" svg path.region").each(function(){e(this).attr("class",e(this).attr("class").replace(" selected",""))}),e(this).attr("class",e(this).attr("class")+" selected"),d3v3.event.preventDefault()},f=function(){},l=_.filter(this.options.state.mapping,function(e){return e.destLayer==r});if(l.length>1)throw"view.D3.ChoroplethMap.js: more than one field associated with layer, impossible to link with actions";if(l.length==1){var c=t.getActionsForEvent("selection"),h=t.getActionsForEvent("hover"),p=_.filter(c,function(e){return e.mapping.srcField==l.srcShapeField}),d=_.filter(h,function(e){return e.mapping.srcField==l.srcShapeField});p.length&&(a=function(){var e=this.attributes.regionName.nodeValue,n=t.options.state.mapping;n.forEach(function(n){var r=t.getRecordByValue(n.srcShapeField,e);p.forEach(function(e){e.action.doAction([r],e.mapping)})})});var v=function(){};t.options.state.customTooltipTemplate&&(v=function(n){var r=e(t.el).position(),i=this.getBoundingClientRect(),s=document.body.getBoundingClientRect(),o={left:i.left+i.width/2,top:i.top+i.height/2-s.top},u=t.getLabelFor(t.options.state.mapping[0].srcValueField)+":",a=t.getLabelFor(t.options.state.mapping[0].srcShapeField)+":",f=this.attributes.regionName.nodeValue,l=t.getRecordByValue(t.options.state.mapping[0].srcShapeField,f),c="N/A";if(l){var h=t.model.fields.get(t.options.state.mapping[0].srcValueField);h&&(c=l.getFieldValue(h))}if(typeof c!="string"||c.indexOf("N/A")==-1){var p={x:f,y:c,xLabel:a,yLabel:u},d=Mustache.render(t.options.state.customTooltipTemplate,p),v=e(t.el),m=o.top<v[0].offsetTop+v.height()/2?"n":"s";nv.tooltip.show([o.left,o.top],d,m,null,v[0])}});var m=function(){nv.tooltip.cleanup()};d.length?f=function(){var e=this.attributes.regionName.nodeValue,n=t.options.state.mapping;n.forEach(function(n){var r=t.getRecordByValue(n.srcShapeField,e);d.forEach(function(e){e.action.doAction([r],e.mapping)})})}:f=v}return d3v3.json(n,function(e,n){t.mapObj=n;if(n==null||typeof n=="undefined")return;t.regionNames=_.pluck(t.mapObj.objects[r].geometries,"id");var l=topojson.object(n,n.objects[r]),c=d3v3.geo.mercator().center(t.options.state.center).rotate(u).scale(t.scale).translate([t.mapWidth/2,t.mapHeight/2]),h=d3v3.geo.path().projection(c),p=function(){return t.unselectedColor};o&&(p=function(){var e=Math.floor(Math.random()*4+6),t=Math.floor(Math.random()*2)*8;return"#"+e+t+e+t+e+t}),t.svg.select("g.regions").selectAll(".region").data(l.geometries).enter().append("path").on("click",a).on("mouseover",f).on("mouseout",m).attr("class",function(e){return"region "+toAscii(e.id)}).attr("regionName",function(e){return e.id}).attr("fill",p).attr("d",h);if(i){var d=t.options.state.minRegionArea||6,v={geometries:_.filter(n.objects[r].geometries,function(e){return e.properties.Shape_Area>d}),type:"GeometryCollection"};t.svg.select("g.regionLabels").selectAll(".region-label").data(topojson.object(n,v).geometries).enter().append("text").attr("class",function(e){return"region-label "+toAscii(e.id)}).attr("transform",function(e){return"translate("+h.centroid(e)+")"}).attr("regionName",function(e){return e.id}).attr("dy",".35em").text(function(e){return e.id})}n.objects.cities&&s&&(t.svg.select("g.places").append("path").datum(topojson.object(n,n.objects.cities)).attr("d",h).attr("class","place"),t.svg.select("g.places").selectAll(".place-label").data(topojson.object(n,n.objects.cities).geometries).enter().append("text").attr("class","place-label").attr("transform",function(e){return"translate("+c(e.coordinates)+")"}).attr("dy",".35em").attr("dx",".8em").text(function(e){return e.properties.name})),(o==null||typeof o=="undefined")&&t.redraw(),t.rendered=!0}),this},redraw:function(){var e=this;if(!e.rendered||!e.mapObj)return;var t=this.options.state.layer,n=this.options.state.mapping;_.each(n,function(t){var n=e._getDataFor(e.regionNames,t.srcShapeField,t.srcValueField);e.svg.selectAll("path.region").attr("fill",function(){var t=this.attributes.regionName.nodeValue,r=n[t];return r!=null?r.color:e.unselectedColor})})},onZoomChanged:function(t){var n=e(t.currentTarget);this.scale=n.val},_getDataFor:function(e,t,n){var r=this,i="filtered";r.options.useFilteredData!==null&&r.options.useFilteredData===!1&&(i="original");var s=r.model.getRecords(i),o=r.model.fields.get(t),u=r.model.fields.get(n),a=!1;r.model.queryState.isSelected()&&(a=!0);var f={};return o&&u&&_.each(s,function(t){if(_.contains(e,t.getFieldValueUnrendered(o))){var n=r.unselectedColor;if(a)t.isRecordSelected()&&(n=t.getFieldColor(u));else{var i=t.getFieldColor(u);i!=null&&(n=i)}f[t.getFieldValueUnrendered(o)]={record:t,field:u,color:n,value:t.getFieldValueUnrendered(u)}}}),f},getRecordByValue:function(e,t){var n=this,r="filtered";n.options.useFilteredData!==null&&n.options.useFilteredData===!1&&(r="original");var i=n.model.getRecords(r),s=n.model.fields.get(e);return _.find(i,function(e){return e.getFieldValueUnrendered(s)==t})},getActionsForEvent:function(e){var t=this,n=[];return _.each(t.options.actions,function(t){_.contains(t.event,e)&&n.push(t)}),n}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.D3Cloud=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;"></div>',defaultfontRange:[20,100],initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=t.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.margin={top:19.5,right:19.5,bottom:19.5,left:100.5};if(!t.width)throw"Missing cloud width!";this.width=t.width-this.margin.right;if(!t.height)throw"Missing cloud height!";this.height=t.height-this.margin.top-this.margin.bottom;var n=Mustache.render(this.template,this);this.el.html(n)},render:function(){var e=this;e.trigger("chart:startDrawing");var t="#"+this.uid;e.graph&&jQuery(t).empty(),e.graph=d3.select(t),e.trigger("chart:endDrawing")},redraw:function(){if(!this.visible)return;var e=this;e.trigger("chart:startDrawing");var t=e.options.state,n;this.options.resultType&&(n=this.options.resultType);var r=[Infinity,-Infinity],i=_.map(this.options.model.getRecords(n),function(e){var n={key:e.attributes[t.wordField],value:e.attributes[t.dimensionField]?e.attributes[t.dimensionField]:1e-8};return t.colorField&&e.attributes[t.colorField]&&(n.color=e.attributes[t.colorField]),n});i=_.sortBy(i,function(e){return e.value});if(i.length==0)return;r=[i[0].value,i[i.length-1].value],r[0]==r[1]&&(r=[r[0]/2,r[0]*2]),e.graph=d3.select("#"+e.uid),e.domain=r,this.drawD3(i),e.trigger("chart:endDrawing")},drawD3:function(e){var t=this,n=t.options.state,r=d3.scale.log().domain(t.domain).range(n.fontRange||t.defaultFontRange),i="Impact";n.font&&(i=n.font),n.scale&&(r=n.scale),typeof n.angle_start=="undefined"&&typeof n.angle_end=="undefined"&&(n.angle_start=-90,n.angle_end=90),typeof n.orientations=="undefined"&&(n.orientations=10),d3.layout.cloud().size([t.width,t.height]).words(e.map(function(e){return{text:e.key,size:e.value,color:e.color}})).rotate(function(){var e=Math.floor(Math.random()*n.orientations),t=Math.floor(e*(n.angle_end-n.angle_start)/n.orientations+n.angle_start);return t}).font(i).fontSize(function(e){return r(+e.size)}).on("end",t.drawCloud(this)).start(),t.alreadyDrawed=!0},drawCloud:function(t){return function(n){var r=t,i=function(e){},s=function(e){},o=function(e){},u,a,f;r.options.state.customTooltipTemplate?(u=function(t){var n=-(e("html").css("padding-left").replace("px","")+e("body").css("margin-left").replace("px",""))+10,i=t.size/2,s=e(this).offset(),o=Mustache.render(r.options.state.customTooltipTemplate,t),u=i+s.top;u<0&&(u=-u),nv.tooltip.show([s.left+n,i+s.top],o,"w",null,r.el[0])},a=function(){nv.tooltip.cleanup()}):r.options.state.mouseover&&r.options.state.mouseout&&(u=r.options.state.mouseover,a=r.options.state.mouseout),r.options.state.click&&(f=r.options.state.click);var l=d3.scale.log().range(["#DEEBF7","#3182BD"]);r.graph.append("svg").attr("width",r.width).attr("height",r.height).append("g").attr("transform","translate("+r.width/2+","+r.height/2+")").selectAll("text").data(n).enter().append("text").style("font-size",function(e){return e.size+"px"}).style("font-family","Impact").style("fill",function(e,t){return e.color?e.color:l(e.size)}).style("cursor","pointer").attr("text-anchor","middle").attr("transform",function(e){return"translate("+[e.x,e.y]+")rotate("+e.rotate+")"}).text(function(e){return e.text}).on("mouseover",u||i).on("mouseout",a||s).on("click",f||o)}}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){t.D3CooccurrenceMatrix=Backbone.View.extend({rendered:!1,template:'<svg x="0" y="0" width="{{width}}" height="{{height}}" xmlns="http://www.w3.org/2000/svg" version="1.1" style="margin-left:{{marginLeft}}px">     			<g transform="translate({{marginLeft}}, {{marginTop}})">     		</svg>',defaultTooltipTemplate:"<div> 				<b>Correlation:</b><table> 					<tr><td>Cluster 1: </td><td>{{name1}}</td></tr> 					<tr><td>Cluster 2: </td><td>{{name2}}</td></tr> 					<tr><td>Correlation: </td><td>{{value}}</td></tr> 				</table> 			  </div>"
,events:{},rendered:!1,initialize:function(e){var t=this;_.bindAll(this,"render","redraw","computeData"),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),this.uid=""+(new Date).getTime()+Math.floor(Math.random()*1e4),this.$el=e.el,this.axisField=e.axisField,this.valueField=e.valueField,this.filterField=e.filterField,this.filterValue=e.filterValue,this.series1Field=e.series1Field,this.series2Field=e.series2Field;var n={top:120,right:0,bottom:10,left:120};this.width=this.options.state.width||200,this.height=this.options.state.height||200,this.options.state.customTooltipTemplate?this.tooltipTemplate=this.options.state.customTooltipTemplate:this.tooltipTemplate=this.defaultTooltipTemplate;var r={width:this.width+n.left+n.right,height:this.height+n.top+n.bottom,marginLeft:n.left,marginTop:n.top},i=Mustache.render(this.template,r);this.$el.html(i),this.svg=d3.select("#"+this.$el[0].id+" svg g")},computeData:function(){function p(e,n){if(typeof c[e]=="undefined"||c[e]==null)c[e]=[n],h.push(n);for(var r=0;r<a;r++)t[n][r].z>0&&!_.contains(h,r)&&(c[e].push(r),h.push(r));for(var i=0;i<c[e].length;i++){var s=c[e][i];for(var o=0;o<a;o++)t[o][s].z>0&&!_.contains(h,s)&&(c[e].push(s),h.push(s))}}function d(e){for(var t=0;t<c.length;t++)if(_.contains(c[t],e))return t;return c.length}var e=this,t=[],n=[];e.filterField&&e.filterValue?n=_.filter(this.model.getRecords(),function(t){return t.attributes[e.filterField]==e.filterValue}):n=this.model.getRecords();if(n.length==0)return null;var i=_.uniq(_.map(n,function(t){return t.attributes[e.series1Field]})),s=_.uniq(_.map(n,function(t){return t.attributes[e.series2Field]})),o=_.uniq(i.concat(s)),u=[],a=o.length;_.each(o,function(e,n){var r={};r.index=n,r.val=0,r.name=e,t[n]=d3.range(a).map(function(e){return{x:e,y:n,z:0}}),u.push(r)});var f,l;_.each(n,function(n){var r=n.attributes[e.series1Field],i=n.attributes[e.series2Field],s=_.find(u,function(e){return e.name==r}).index,o=_.find(u,function(e){return e.name==i}).index,a=n.attributes[e.valueField];s!=o&&(f?f=a<f?a:f:f=a,l?l=a>l?a:l:l=a),t[s][o].z=a,u[s].val+=a,u[o].val+=a});var c=[],h=[];p(0,0);for(r=1;r<a;r++)c.length<9&&h.length<a&&(_.contains(h,r)?p(d(r),r):p(c.length,r));_.each(u,function(e){var t=d(e.index);e.group=t});var v=d3.scale.ordinal().rangeBands([0,this.width]),m=d3.scale.linear().domain([f,l]).clamp(!0),g=d3.scale.category10().domain(d3.range(10)),y={name:d3.range(a).sort(function(e,t){return d3.ascending(u[e].name,u[t].name)}),val:d3.range(a).sort(function(e,t){return u[t].val-u[e].val}),group:d3.range(a).sort(function(e,t){return u[t].group-u[e].group})};return e.options.orderMode?e.options.orderMode.toLowerCase().indexOf("cluster")>=0?v.domain(y.group):e.options.orderMode.toLowerCase().indexOf("name")>=0?v.domain(y.name):e.options.orderMode.toLowerCase().indexOf("value")>=0&&v.domain(y.val):v.domain(y.group),{matrix:t,nodes:u,x:v,z:m,c:g}},render:function(){function u(e){var t=d3.select(this).selectAll(".cell").data(e.filter(function(e){return e.z})).enter().append("rect").attr("class","cell").attr("x",function(e){return i(e.x)}).attr("width",i.rangeBand()).attr("height",i.rangeBand()).style("fill-opacity",function(e){return s(e.z)}).style("fill",function(e){return r[e.x].group==r[e.y].group?o(r[e.x].group):null}).on("mouseover",f).on("mouseout",l)}function f(t){var n=e.$el.position(),i=this.getBoundingClientRect(),s=document.body.getBoundingClientRect(),o={left:i.left+i.width/2,top:i.top+i.height/2-s.top},u={name1:r[t.x].name,name2:r[t.y].name,value:t.z},a=Mustache.render(e.tooltipTemplate,u),f=e.$el,l=o.top<f[0].offsetTop+f.height()/2?"n":"s";nv.tooltip.show([o.left,o.top],a,l,null,f[0]),d3.selectAll(".row text").classed("active",function(e,n){return n==t.y}),d3.selectAll(".column text").classed("active",function(e,n){return n==t.x})}function l(){nv.tooltip.cleanup(),d3.selectAll("text").classed("active",!1)}var e=this,t=this.computeData();if(!t)return null;var n=t.matrix,r=t.nodes,i=t.x,s=t.z,o=t.c;this.svg.append("rect").attr("class","background").attr("width",e.width).attr("height",e.height);var u=this.svg.selectAll(".row").data(n).enter().append("g").attr("class","row").attr("transform",function(e,t){return"translate(0,"+i(t)+")"}).each(u);u.append("line").attr("class","line").attr("x2",this.width),u.append("text").attr("x",-6).attr("y",i.rangeBand()/2).attr("dy",".32em").attr("text-anchor","end").text(function(e,t){return r[t].name});var a=this.svg.selectAll(".column").data(n).enter().append("g").attr("class","column").attr("transform",function(e,t){return"translate("+i(t)+")rotate(-90)"});a.append("line").attr("class","line").attr("x1",-this.width),a.append("text").attr("x",6).attr("y",i.rangeBand()/2).attr("dy",".32em").attr("text-anchor","start").text(function(e,t){return r[t].name}),this.rendered=!0},redraw:function(){var e=this;if(!this.rendered)return this.render.apply(this);var t=this.computeData();if(!t)return null;var n=t.matrix,r=t.nodes,i=t.x,s=t.z,o=t.c,u=e.svg.transition().duration(200);u.selectAll(".row").delay(function(e,t){return i(t)}).attr("transform",function(e,t){return"translate(0,"+i(t)+")"}).selectAll(".cell").delay(function(e){return i(e.x)}).attr("x",function(e){return i(e.x)}),u.selectAll(".column").delay(function(e,t){return i(t)}).attr("transform",function(e,t){return"translate("+i(t)+")rotate(-90)"})}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.D3GravityBubble=Backbone.View.extend({template:' 	        <div id="{{uid}}"  style="width: {{width}}px; height: {{height}}px;"> 	        	<div id="{{uid}}_graph" class="span11" ></div> 	        	<div class="span1"> 	        		<div id="{{uid}}_legend_color"  style="width:{{color_legend_width}}px;height:{{color_legend_height}}px;{{#colorMargin}}margin:{{colorMargin}}{{/colorMargin}}"></div> 	        		<div id="{{uid}}_legend_size" style="width:{{size_legend_width}}px;height:{{size_legend_height}}px;{{#sizeMargin}}margin:{{sizeMargin}}{{/sizeMargin}}"></div> 	        	</div> 	        </div>',tooltipTemplate:"<div> 				Key = {{title}}<br> 	    		Color = {{colorValue}}<br> 	    		Size = {{sizeValue}}<br> 			</div>",initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),e(window).resize(this.resize),this.uid=t.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.margin={top:0,right:0,bottom:0,left:0},this.width=t.width-this.margin.right,this.bubbleWidth=this.width*.9,this.legendWidth=this.width*.1,this.height=t.height-this.margin.top-this.margin.bottom,this.options.state.colorLegend&&(this.options.state.colorLegend.margin=this.options.state.colorLegend.margin||[],this.color_legend_width=this.options.state.colorLegend.width+(this.options.state.colorLegend.margin.right||0)+(this.options.state.colorLegend.margin.left||this.options.state.colorLegend.margin.right||0),this.color_legend_height=this.options.state.colorLegend.height+(this.options.state.colorLegend.margin.top||0)+(this.options.state.colorLegend.margin.bottom||this.options.state.colorLegend.margin.top||0),this.colorMargin=(this.options.state.colorLegend.margin.top||0)+"px "+(this.options.state.colorLegend.margin.right||0)+"px "+(this.options.state.colorLegend.margin.bottom||0)+"px "+(this.options.state.colorLegend.margin.left||0)+"px"),this.options.state.sizeLegend&&(this.options.state.sizeLegend.margin=this.options.state.sizeLegend.margin||[],this.size_legend_width=this.options.state.sizeLegend.width+(this.options.state.sizeLegend.margin.right||0)+(this.options.state.sizeLegend.margin.left||this.options.state.sizeLegend.margin.right||0),this.size_legend_height=this.options.state.sizeLegend.height+(this.options.state.sizeLegend.margin.top||0)+(this.options.state.sizeLegend.margin.bottom||this.options.state.sizeLegend.margin.top||0),this.sizeMargin=(this.options.state.sizeLegend.margin.top||0)+"px "+(this.options.state.sizeLegend.margin.right||0)+"px "+(this.options.state.sizeLegend.margin.bottom||0)+"px "+(this.options.state.sizeLegend.margin.left||0)+"px"),this.options.state.customTooltipTemplate&&(this.tooltipTemplate=this.options.state.customTooltipTemplate);var n=Mustache.render(this.template,this);this.el.html(n)},render:function(){var e=this,t="#"+this.uid+"_graph",n="#"+this.uid+"_legend_color",r="#"+this.uid+"_legend_size";e.graph&&(jQuery(t).empty(),jQuery(n).empty(),jQuery(r).empty()),e.graph=d3.select(t)},redraw:function(){var e=this,t=e.options.state;if(!e.visible)return;var n;this.options.resultType&&(n=this.options.resultType),e.colorDataFormat="number";var r=_.map(this.options.model.getRecords(n),function(n){return t.domains=t.domains||{},n.fields.get(t.colorField.field).attributes.type=="string"&&(e.colorDataFormat="string"),{key:n.attributes[t.keyField.field],color:n.attributes[t.colorField.field],size:n.attributes[t.sizeField.field],color_formatted:n.getFieldValue(e.model.fields.get(t.colorField.field)),size_formatted:n.getFieldValue(e.model.fields.get(t.sizeField.field))}}),i=[d3.min(e.options.model.getRecords(n),function(e){return e.attributes[t.sizeField.field]}),d3.max(e.options.model.getRecords(n),function(e){return e.attributes[t.sizeField.field]})];e.sizeScale=d3.scale.linear().domain(i).range([2,60]).clamp(!0),e.colorDataFormat=="string"?e.colorDomain=_.unique(_.map(e.options.model.getRecords(),function(e){return e.attributes[t.colorField.field]})):e.colorDomain=[d3.min(e.options.model.getRecords(n),function(e){return e.attributes[t.colorField.field]}),d3.max(e.options.model.getRecords(n),function(e){return e.attributes[t.colorField.field]})],e.colorScale=d3.scale.category20().domain(e.colorDomain);var s=_.unique(_.map(e.options.model.getRecords(),function(e){return e.attributes[t.colorField.field]}));e.yAxis=d3.scale.ordinal().domain(s).range([0,e.height]),t.colorLegend&&e.drawLegendColor(),t.sizeLegend&&e.drawLegendSize(i[0],i[1]),e.colorTitle=t.colorField.label,e.sizeTitle=t.sizeField.label,e.graph=d3.select("#"+e.uid+"_graph"),this.drawD3(r)},drawLegendSize:function(t,n){var r=this,i=r.options.state.sizeLegend,s=r.size_legend_width,o=r.size_legend_height;i.margin=e.extend({top:0,right:0,bottom:0,left:0},i.margin);var u=20,a=i.numElements,f="#"+this.uid+"_legend_size",l=s/2-i.width/2||0,c=i.margin.top||0,h=d3.select(f).append("svg").attr("width",s).attr("height",o),p=d3.range(a),d=[],v=(i.height-u*2-a)/a,m=_.map(p,function(e){return e*(n-t)/(a-1)+t}),g=h.selectAll("circle").data(m);g.enter().append("circle").attr({width:i.width,height:v,cy:function(e,t){var i=r.sizeScale(e),s=r.sizeScale(n);return s*2-i+5},cx:i.margin.left+r.sizeScale(n),r:function(e,t){return r.sizeScale(e)},fill:"none",stroke:"black","stroke-width":"1","stroke-dasharray":"2,2"}),_.map([t,(n-t)/2,n],function(e){return e>1e3?d3.format("s")(Math.round(e)):d3.format(".2f")(e)}),h.selectAll(".label").data(m).enter().append("text").attr("class","y label").attr("text-anchor","middle").attr("y",function(e,t){var i=r.sizeScale(e),s=r.sizeScale(n),o=s*2-i*2;return o==0&&(o=20),o}).attr("x",l+r.sizeScale(n)+(r.options.state.sizeLegend.margin.left||0)/2).text(function(e){return e>1e3?d3.format("s")(Math.round(e)):d3.format(".2f")(e)})},drawLegendColor:function(){var t=this,n=t.options.state.colorLegend,r=t.color_legend_width,i=this.color_legend_height;n.margin=e.extend({top:0,right:0,bottom:0,left:0},n.margin);var s=20,o=20,u="#"+this.uid+"_legend_color",a=r/2-s/2||0,f=n.margin.top||0,l=d3.select(u).append("svg").attr("width",r).attr("height",i),c,h,p,d;t.colorDataFormat=="string"?(c=t.colorDomain,h=function(e){return t.colorScale(e)},p=t.colorDomain.length,d=t.colorDomain):(p=n.numElements,c=d3.range(p),h=function(e){return t.colorScale(e*(t.colorDomain[1]-t.colorDomain[0])/p+t.colorDomain[0])},d=_.map([t.colorDomain[0],t.colorDomain[1]],function(e){return e>1e3?d3.format("s")(Math.round(e)):d3.format(".2f")(e)}));var v=[],m=l.selectAll("rect").data(c),g=(n.height-o*2-p)/p;m.enter().append("rect").attr({width:s,height:g,y:function(e,t){return f+5+t*(g+1)},x:a,fill:function(e,t){return h(e)}}),l.selectAll(".label").data(d).enter().append("text").attr("class","y label").attr("text-anchor",function(){return t.colorDataFormat=="string"?"left":"middle"}).attr("y",function(e,r){return t.colorDataFormat=="string"?f+9+g/2+r*(g+1):(n.height-o)/(d.length-1)*r+o/2}).attr("x",function(){return t.colorDataFormat=="string"?a+s+2:(r/2-n.width/2||0)+n.width/2}).text(function(e){return e})},drawD3:function(e){function n(e){return e.size}function r(e){return e.color}function i(e){return e.key}function b(){function a(e){m.gravity(p).charge(function(e){return h(n(e))}).friction(v).linkStrength(function(e,t){console.log(c+" - "+t)}).on("tick",function(t){e(t.alpha),o.attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}).start()}function f(e){m.nodes().forEach(function(t){t.x=t.x+(u.x-t.x)*(d+.02)*e,t.y=t.y+(u.y-t.y)*(d+.02)*e})}m.nodes(e),y=g.append("g").attr("id","circles").selectAll("a").data(m.nodes()),m.nodes().forEach(function(e,n){e.x=Math.random()*s,e.y=t.yAxis(r(e))});var o=y.enter().append("a").append("circle").attr("r",0).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}).attr("fill",function(e){return t.colorScale(r(e))}).attr("stroke-width",1).attr("stroke",function(e){return d3.rgb(t.colorScale(r(e))).darker()}).attr("id",function(e){return"post_#"+i(e)}).attr("title",function(e){return i(e)}).on("mouseover",t.handleMouseover(t)).on("mouseout",t.mouseout);y.selectAll("circle").transition().delay(function(e,t){return t*10}).duration(1).attr("r",function(e){return e?t.sizeScale(n(e)):0}),a(f)}var t=this,s=t.width,o=t.height,u={x:(s-(t.margin.left+t.margin.right))/2,y:(o-(t.margin.top+t.margin.bottom))/2},a,f,l,h,p=-0.01,d=.2,v=.8,m=d3.layout.force().linkStrength(function(e,t){console.log(" c,i ["+e+","+t+"]")}).size([s-(t.margin.left+t.margin.right),o-(t.margin.top+t.margin.bottom)]),g=t.graph.append("svg"),y,h=function(e){return-t.sizeScale(e)*t.sizeScale(e)/2.5};b(),t.alreadyDrawed=!0},handleMouseover:function(t){return function(n){var r=e(t.el).position(),i=this.getBoundingClientRect(),s=document.body.getBoundingClientRect(),o={left:i.left+i.width/2,top:i.top+i.height/2-s.top},u={title:n.key,colorLabel:t.colorTitle,colorValue:n.color_formatted,sizeabel:t.sizeTitle,sizeValue:n.size_formatted},a=Mustache.render(t.tooltipTemplate,u),f=e(t.el),l=o.top<f[0].offsetTop+f.height()/2?"n":"s";nv.tooltip.show([o.left,o.top],a,l,null,f[0])}},mouseout:function(){nv.tooltip.cleanup()}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.D3Sparkline=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;"> <div> ',initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),e(window).resize(this.resize),this.uid=t.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.width=t.width,this.height=t.height,this.options.animation||(this.options.animation={duration:2e3,delay:200});var n=Mustache.render(this.template,this);this.el.html(n)},resize:function(){},render:function(){var e=this,t="#"+this.uid;e.graph&&jQuery(t).empty(),e.graph=d3.select(t).append("svg:svg").attr("width","100%").attr("height","100%").style("stroke",function(){return e.options.color||"steelblue"}).style("stroke-width",1).style("fill","none")},redraw:function(){console.log("redraw");var e=this.model.fields.get(this.options.field),t=this.options.resultType||"",n=_.map(this.options.model.getRecords(t),function(t){return t.getFieldValueUnrendered(e)});this.drawD3(n,"#"+this.uid)},drawD3:function(e,t){var n=this,r=d3.scale.linear().domain([0,e.length]).range([0,this.width]),i=d3.scale.linear().domain([_.min(e),_.max(e)]).range([0,this.height]),s=d3.svg.line().x(function(e,t){return r(t)}).y(function(e){return i(e)});n.alreadyDrawed?n.graph.select("path").transition().duration(n.options.animation.duration).delay(n.options.animation.delay).attr("d",s(e)):n.graph.append("svg:path").attr("d",s(e)),n.alreadyDrawed=!0}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";var n=function(e,t){var n=null;return t.fields.forEach(function(t,r){r==0?n=e.getFieldValue(t):n+=e.getFieldValue(t)}),n},r=n,i=function(e,t){return function(n){if(e.length&&n){var r=d3.event.ctrlKey,i=!d3.select(d3.event.target.parentNode).classed("info");i?r?t.push(n):t=[n]:r?t=_.difference(t,[n]):t=[],e.forEach(function(e){e.action.doAction(t,e.mapping)})}}},s=function(e,t){return function(n){e.length&&n&&(t=[],t.push(n),e.forEach(function(e){e.action.doAction(t,e.mapping)}))}},o=function(){document.body.style.overflow="hidden";var e=document.body.clientWidth;return document.body.style.overflow="scroll",e-=document.body.clientWidth,e||(e=document.body.offsetWidth-document.body.clientWidth),document.body.style.overflow="",e},u=function(e,t){return function(n){var i=n.fields[0].id,s=d3.select(this).classed("g-ascending");d3.selectAll(".g-descending").classed("g-descending",!1),d3.selectAll(".g-ascending").classed("g-ascending",!1);if(!s){d3.select(this).classed("g-ascending",!0);var o=function(e,t){return isNaN(r(e,n))-isNaN(r(t,n))||r(e,n)-r(t,n)||e.index-t.index},u=function(e,t){return t.name.localeCompare(e.name)}}else{d3.select(this).classed("g-descending",!0);var o=function(e,t){return isNaN(r(t,n))-isNaN(r(e,n))||r(t,n)-r(e,n)||t.index-e.index},u=function(e,t){return e.name.localeCompare(t.name)}}d3.selectAll("#"+t+" .g-tbody .g-tr").sort(i==="name"?u:o).each(function(e,t){e.index=t}).transition().delay(function(e,t){return(t-1)*10}).duration(750).attr("transform",function(t,n){return"translate(0,"+n*e+")"})}},a=function(e){var t=d3.select("#"+e.graphId+" .g-tbody-container"),n=e.el.find(".g-thead"),r=d3.select("#"+e.graphId+" .g-tbody"),i=d3.select("#"+e.graphId+" .g-tfoot"),s=0,o=0;return d3.sum(e.columns,function(t,r){var i=n.find(".g-th:nth-child("+(r+1)+")");t.padding_left=parseInt(i.css("padding-left").replace("px","")),t.padding_right=parseInt(i.css("padding-right").replace("px","")),t.computed_width=i.outerWidth(!0),t.fields.forEach(function(e,n){e.width=t.width,e.computed_width=t.computed_width});var o=s;s+=t.computed_width,t.translation=o;if(t.scale){var u=t.scale(e.model.records.models,t.computed_width,t.range||1);t.d3scale=u.scale,t.axisScale=u.axisScale,t.fields.forEach(function(e,n){e.scale=t.d3scale,e.axisScale=t.axisScale[e.id]})}return t.computed_width})};t.D3table=Backbone.View.extend({className:"recline-table-editor",template:'   				<div id="{{graphId}}" class="g-table g-table-hover g-table-striped g-table-bordered">   					<h2 class="g-title">{{title}}</h2>   					<p class="lead">{{instructions}}</p>   					<small>{{summary}}</small>   				  				<div>   				  			',templateHeader:'         			<div class="g-thead">   						<div class="g-tr">   							{{#columns}}   							<div class="g-th {{#sortable}}g-sortable{{/sortable}}" style="width: {{hwidth}}"><div>{{label}}</div></div>   							{{/columns}}   						</div>   					</div>   					  					',templateBody:'   					<div class="g-tbody-container" style="width:{{scrollWidth}}px; height:{{height}}px;">   						<div style="width:{{width}}px;">   							<svg class="g-tbody"> 							</svg> 						</div> 					</div> 					  					',templateFooter:'  					<div class="g-tfoot-container"> 						<svg class="g-tfoot"> 						</svg> 					</div> 										',events:{"click .g-thead":"onEvent"},initialize:function(t){_.defaults(t.conf,{row_height:20,height:200}),t.actions=t.actions||[],this.el=e(this.el),_.bindAll(this,"render","redraw","refresh","resize"),this.rowHeight=t.conf.row_height;var n=[],r=[];t.actions.forEach(function(e){e.event.forEach(function(t){t==="selection"?n.push(e):t==="hover"&&r.push(e)})}),this.clickActions=n,this.hoverActions=r,this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),e(window).resize(this.resize),this.columns=_.map(t.columns,function(e){return _.defaults(e,{label:"",type:"text",sortable:!1,fields:{}})}),this.columns.forEach(function(e,t){e.width=e.width||160,e.hwidth=e.width},this),this.height=t.conf.height,this.title=t.title,this.summary=t.summary,this.instructions=t.instructions,this.graphId=t.id||"d3table_"+Math.floor(Math.random()*1e3);var i=Mustache.render(this.template,this);this.el.html(i),this.el.find("#"+this.graphId).append(Mustache.render(this.templateHeader,this)),this.width=t.conf.width},resize:function(){console.log("resize");var e=d3.select("#"+this.graphId+" .g-tbody-container"),t=d3.select("#"+this.graphId+" .g-tbody"),n=d3.select("#"+this.graphId+" .g-tfoot");this.width=a(this),this.scrollWidth=o()+this.width,this.el.find(".g-tbody-container").css("width",this.scrollWidth),this.el.find(".g-tbody-container > div").css("width",this.width);var r=e.select(".g-tbody").selectAll(".g-tr");r.each(function(e){var t=d3.select(this).selectAll(".g-td").attr("transform",function(e,t){return"translate("+(e.translation+e.padding_left)+")"}),n=t.filter(function(e){return e.scale&&e.type==="barchart"});n.selectAll(".g-bar").attr("width",function(t,n){return t.scale(e.getFieldValue(t))}).attr("transform",function(t,n){var r=Math.ceil(n===0?t.computed_width/2-t.scale(e.getFieldValue(t)):n*t.computed_width/2);return n==0?"translate("+r+")":"translate("+r+")"})}),e.select(".g-tbody").selectAll(".g-column-border").attr("class","g-column-border").attr("transform",function(e){return"translate("+e.translation+",0)"}).attr("y2","100%"),e.select(".g-tbody").selectAll(".g-compare").data(this.columns.filter(function(e){return e.scale})).attr("transform",function(e){return"translate("+(e.translation+e.padding_left+e.computed_width/2)+",0)"}).attr("y2","100%");var i=d3.select("#"+this.graphId+" .g-tfoot"),s=i.selectAll(".g-td").attr("width",function(e,t){return e.computed_width}).attr("transform",function(e,t){return"translate("+(e.translation+e.padding_left)+")"}),u=s.filter(function(e){return e.scale&&e.type==="barchart"});u.selectAll(".g-axis").remove();var f,l;u.selectAll(".g-axis").data(function(e){return f=e.fields.length,l=e.range,e.fields}).enter().append("g").attr("class",function(e,t){return"g-axis"}).attr("transform",function(e,t){var n=0,r=e.computed_width/f;return t==0?n=r-r*l:n=t*r,"translate("+n+")"}).each(function(e,t){var n=d3.svg.axis().scale(e.axisScale).ticks(Math.abs(e.axisScale.range()[1]-e.axisScale.range()[0])/80).orient("bottom");d3.select(this).call(n)})},refresh:function(){console.log("d3Table.refresh")},reset:function(){console.log("d3Table.reset")},render:function(){console.log("d3Table.render"),this.width=a(this),this.scrollWidth=o()+this.width,this.el.find("#"+this.graphId).append(Mustache.render(this.templateBody,this)).append(Mustache.render(this.templateFooter,this)),this.columns.forEach(function(e,t){e.fields=recline.Data.Aggregations.intersectionObjects("id",e.fields,this.model.fields.models),e.index=t},this)},redraw:function(){console.log("d3Table.redraw");var e=this.rowHeight,t=this.columns,n=this.model.records.models,f=[];n.forEach(function(e,t){e.index=t,e.isRecordSelected()&&f.push(e)}),this.width=a(this),this.scrollWidth=o()+this.width;var l=d3.select("#"+this.graphId+" .g-tbody-container");l.select("div").style("height",e*n.length+"px"),l.classed("g-tbody-container-overflow",e*n.length>this.height),l.selectAll(".g-tbody .g-tr").remove();var c=l.select(".g-tbody").selectAll(".g-tr").data(n).enter().append("g").attr("class","g-tr").attr("transform",function(t,n){return"translate(0,"+n*e+")"}).classed("info",function(e,t){return e.isRecordSelected()});c.append("rect").attr("class","g-background").attr("width","100%").attr("height",e).on("click",i(this.clickActions,f)).on("mouseover",s(this.hoverActions,f)),c.each(function(n){var i=d3.select(this).selectAll(".g-td").data(t).enter().append("g").attr("class","g-td").classed("g-quantitative",function(e){return e.scale}).classed("g-categorical",function(e){return e.categorical}).attr("transform",function(e,t){return"translate("+(e.translation+e.padding_left)+")"});d3.select(this).append("line").attr("class","g-row-border").attr("y1",e).attr("y2",e).attr("x2","100%");var s=i.filter(function(e){return e.scale&&e.type==="barchart"});s.selectAll(".g-bar").data(function(e){return e.fields}).enter().append("rect").attr("class","g-bar").attr("width",function(e,t){return e.scale(n.getFieldValue(e))}).attr("height",e-1).attr("transform",function(e,t){var r=Math.ceil(t===0?e.computed_width/2-e.scale(n.getFieldValue(e)):t*e.computed_width/2);return t==0?"translate("+r+")":"translate("+r+")"}).style("fill",function(e,t){return e.color}),i.filter(function(e){return!e.scale}).append("text").attr("class","g-value").attr("x",function(e){return e.scale?3:0}).attr("y",function(e){return e.categorical?9:10}).attr("dy",".35em").classed("g-na",function(e){return r(n,e)===undefined}).text(function(e){return r(n,e)}).attr("clip-path",function(e){return(e.clipped=this.getComputedTextLength()>e.computed_width-20)?"url(#g-clip-cell)":null}),i.filter(function(e){return e.clipped}).append("rect").style("fill","url(#g-clip-gradient)").attr("x",function(e){return e.hwidth}).attr("width",20).attr("height",e)});var h=d3.select("#"+this.graphId+" .g-tfoot");h.selectAll(".axisRow").remove();var p=h.append("g").attr("class","axisRow"),d=p.selectAll(".g-td").data(t).enter().append("g").attr("class","g-td").attr("width",function(e,t){return e.computed_width}).attr("transform",function(e,t){return"translate("+(e.translation+e.padding_left)+")"}),v=d.filter(function(e){return e.scale&&e.type==="barchart"}),m,g;v.selectAll(".g-axis").data(function(e){return m=e.fields.length,g=e.range,e.fields}).enter().append("g").attr("class",function(e,t){return"g-axis"}).attr("transform",function(e,t){var n=0,r=e.computed_width/m;return t==0?n=r-r*g:n=t*r,"translate("+n+")"}).each(function(e,t){var n=d3.svg.axis().scale(e.axisScale).ticks(Math.abs(e.axisScale.range()[1]-e.axisScale.range()[0])/80).orient("bottom");d3.select(this).call(n)}),d3.selectAll("#"+this.graphId+" .g-thead .g-th.g-sortable").data(t).on("click",u(e,this.graphId)),l.select(".g-tbody").selectAll(".g-column-border").remove(),l.select(".g-tbody").selectAll(".g-column-border").data(t).enter().append("line").attr("class","g-column-border").attr("transform",function(e){return"translate("+e.translation+",0)"}).attr("y2","100%"),l.select(".g-tbody").selectAll(".g-compare").remove(),l.select(".g-tbody").selectAll(".g-compare").data(t.filter(function(e){return e.scale})).enter().append("line").attr("class","g-compare").attr("transform",function(e){return"translate("+(e.translation+e.padding_left+e.computed_width/2)+",0)"}).attr("y2","100%")},onEvent:function(e){}})}(jQuery,recline.View),this.recline=this.recline||{},this.recline.View=this.recline.View||{},function(e,t){"use strict";t.D3Treemap=Backbone.View.extend({template:'<div id="{{uid}}" style="width: {{width}}px; height: {{height}}px;"> <div> ',initialize:function(t){this.el=e(this.el),_.bindAll(this,"render","redraw"),this.model.bind("change",this.render),this.model.fields.bind("reset",this.render),this.model.fields.bind("add",this.render),this.model.bind("query:done",this.redraw),this.model.queryState.bind("selection:done",this.redraw),e(window).resize(this.resize),this.uid=t.id||"d3_"+(new Date).getTime()+Math.floor(Math.random()*1e4),this.width=t.width,this.height=t.height,this.options.animation||(this.options.animation={duration:2e3,delay:200});var n=Mustache.render(this.template,this);this.el.html(n)},resize:function(){},render:function(){var e=this,t="#"+this.uid;e.graph&&jQuery(t).empty(),e.treemap=d3.layout.treemap().size([this.width,this.height]).sticky(!1).value(function(e){return console.log(e),e.size}),e.color=d3.scale.category20c(),e.div=d3.select(t).append("div").style("position","relative").style("width",this.width+"px").style("height",this.height+"px")},redraw:function(){console.log("redraw");var e=this.model.fields.get(this.options.fieldValue),t=this.model.fields.get(this.options.fieldName),n=_.map(this.options.model.getRecords(this.options.resultType.type),function(n){return{name:n.getFieldValue(t),size:n.getFieldValueUnrendered(e)}});this.drawD3(n,"#"+this.uid)},drawD3:function(e,t){function r(){this.style("left",function(e){return e.x+"px"}).style("top",function(e){return e.y+"px"}).style("width",function(e){return Math.max(0,e.dx-1)+"px"}).style("height",function(e){return Math.max(0,e.dy-1)+"px"})}var n=this,i=n.treemap(e);_.each(e,function(e){n.div.data([e]).selectAll("div").data(n.treemap.nodes).enter().append("div").attr("class","cell").style("background",function(e){n.color(e.name)}).call(r).text(function(e){return console.log(e),e.name})}),n.alreadyDrawed=!0}})}(jQuery,recline.View);