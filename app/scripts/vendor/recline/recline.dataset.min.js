// # Recline Backbone Models
this.recline=this.recline||{},this.recline.Model=this.recline.Model||{},function(e){"use strict";var t=typeof jQuery!="undefined"&&jQuery.Deferred||_.Deferred;e.Dataset=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){var t=this;_.bindAll(this,"query"),this.backend=null,this.get("backend")?this.backend=this._backendFromString(this.get("backend")):this.get("records")&&(this.backend=recline.Backend.Memory),this.fields=new e.FieldList,this.records=new e.RecordList,this._changes={deletes:[],updates:[],creates:[]},this.facets=new e.FacetList,this.recordCount=null,this.queryState=new e.Query,this.queryState.bind("change facet:add",function(){t.query()});var t=this;t.records.bind("add",function(e){t._changes.creates.push(e.toJSON()),t.recordCount=t.records.models.length}),this._store=this.backend,this.backend==recline.Backend.Memory&&this.fetch()},fetch:function(){function r(t){var r=e.get("fields")||t.fields,i=e._normalizeRecordsAndFields(t.records,r);t.useMemoryStore&&(e._store=new recline.Backend.Memory.Store(i.records,i.fields)),e.set(t.metadata),e.fields.reset(i.fields),e.attributes.renderer&&_.each(e.fields.models,function(t){t.renderer=e.attributes.renderer}),e.query().done(function(){n.resolve(e)}).fail(function(e){n.reject(e)})}var e=this,n=new t;return this.backend!==recline.Backend.Memory?this.backend.fetch(this.toJSON()).done(r).fail(function(e){n.reject(e)}):r({records:this.get("records"),fields:this.get("fields"),useMemoryStore:!0}),n.promise()},_normalizeRecordsAndFields:function(e,t){!t&&e&&e.length>0&&(e[0]instanceof Array?(t=e[0],e=e.slice(1)):t=_.map(_.keys(e[0]),function(e){return{id:e}}));if(t&&t.length>0&&(t[0]===null||typeof t[0]!="object")){var n={};t=_.map(t,function(e,t){e===null?e="":e=e.toString();var r=e.replace(/^\s+|\s+$/g,"");r===""&&(r="_noname_",e=r);while(r in n)n[e]+=1,r=e+n[e];return e in n||(n[e]=0),{id:r}})}return e&&e.length>0&&e[0]instanceof Array&&(e=_.map(e,function(e){var n={};return _.each(t,function(t,r){n[t.id]=e[r]}),n})),{fields:t,records:e}},save:function(){var e=this;return this._store.save(this._changes,this.toJSON())},query:function(e){var n=this,r=new t;this.trigger("query:start"),e&&this.queryState.set(e,{silent:!0});var i=this.queryState.toJSON();return this._store.query(i,this.toJSON()).done(function(e){n._handleQueryResult(e),n.trigger("query:done"),r.resolve(n.records)}).fail(function(e){n.trigger("query:fail",e),r.reject(e)}),r.promise()},_handleQueryResult:function(t){var n=this;n.recordCount=t.total;var r=_.map(t.hits,function(t){var r=new e.Record(t);return r.fields=n.fields,r.bind("change",function(e){n._changes.updates.push(e.toJSON())}),r.bind("destroy",function(e){n._changes.deletes.push(e.toJSON())}),r});n.records.reset(r);if(t.facets){var i=_.map(t.facets,function(t,n){return t.id=n,new e.Facet(t)});n.facets.reset(i)}},toTemplateJSON:function(){var e=this.toJSON();return e.recordCount=this.recordCount,e.fields=this.fields.toJSON(),e},getFieldsSummary:function(){var n=this,r=new e.Query;r.set({size:0}),this.fields.each(function(e){r.addFacet(e.id)});var i=new t;return this._store.query(r.toJSON(),this.toJSON()).done(function(t){t.facets&&_.each(t.facets,function(t,r){t.id=r;var i=new e.Facet(t);n.fields.get(r).facets.reset(i)}),i.resolve(t)}),i.promise()},recordSummary:function(e){return e.summary()},_backendFromString:function(e){var t=null;return recline&&recline.Backend&&_.each(_.keys(recline.Backend),function(n){n.toLowerCase()===e.toLowerCase()&&(t=recline.Backend[n])}),t}}),e.Record=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){_.bindAll(this,"getFieldValue")},getFieldValue:function(e){var t=this.getFieldValueUnrendered(e);return e&&!_.isUndefined(e.renderer)&&(t=e.renderer(t,e,this.toJSON())),t},getFieldValueUnrendered:function(e){if(!e)return"";var t=this.get(e.id);return e.deriver&&(t=e.deriver(t,e,this)),t},summary:function(e){var t=this,n='<div class="recline-record-summary">';return this.fields.each(function(e){e.id!="id"&&(n+='<div class="'+e.id+'"><strong>'+e.get("label")+"</strong>: "+t.getFieldValue(e)+"</div>")}),n+="</div>",n},fetch:function(){},save:function(){},destroy:function(){this.trigger("destroy",this)}}),e.RecordList=Backbone.Collection.extend({constructor:function(){Backbone.Collection.prototype.constructor.apply(this,arguments)},model:e.Record}),e.Field=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},defaults:{label:null,type:"string",format:null,is_derived:!1},initialize:function(t,n){if("0"in t)throw new Error("Looks like you did not pass a proper hash with id to Field constructor");this.attributes.label===null&&this.set({label:this.id}),this.attributes.type.toLowerCase()in this._typeMap&&(this.attributes.type=this._typeMap[this.attributes.type.toLowerCase()]),n&&(this.renderer=n.renderer,this.deriver=n.deriver),this.renderer||(this.renderer=this.defaultRenderers[this.get("type")]),this.facets=new e.FacetList},_typeMap:{text:"string","double":"number","float":"number",numeric:"number","int":"integer",datetime:"date-time",bool:"boolean",timestamp:"date-time",json:"object"},defaultRenderers:{object:function(e,t,n){return JSON.stringify(e)},geo_point:function(e,t,n){return JSON.stringify(e)},number:function(e,t,n){var r=t.get("format");return r==="percentage"?e+"%":e},string:function(e,t,n){var r=t.get("format");if(r==="markdown"){if(typeof Showdown!="undefined"){var i=new Showdown.converter;return out=i.makeHtml(e),out}return e}return r=="plain"?e:(e&&typeof e=="string"&&(e=e.replace(/(https?:\/\/[^ ]+)/g,'<a href="$1">$1</a>')),e)}}}),e.FieldList=Backbone.Collection.extend({constructor:function(){Backbone.Collection.prototype.constructor.apply(this,arguments)},model:e.Field}),e.Query=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},defaults:function(){return{size:100,from:0,q:"",facets:{},filters:[]}},_filterTemplates:{term:{type:"term",field:"",term:""},range:{type:"range",start:"",stop:""},geo_distance:{type:"geo_distance",distance:10,unit:"km",point:{lon:0,lat:0}}},addFilter:function(e){var t=JSON.parse(JSON.stringify(e));_.keys(e).length<=3&&(t=_.defaults(t,this._filterTemplates[e.type]));var n=this.get("filters");n.push(t),this.trigger("change:filters:new-blank")},updateFilter:function(e,t){},removeFilter:function(e){var t=this.get("filters");t.splice(e,1),this.set({filters:t}),this.trigger("change")},addFacet:function(e){var t=this.get("facets");if(_.contains(_.keys(t),e))return;t[e]={terms:{field:e}},this.set({facets:t},{silent:!0}),this.trigger("facet:add",this)},addHistogramFacet:function(e){var t=this.get("facets");t[e]={date_histogram:{field:e,interval:"day"}},this.set({facets:t},{silent:!0}),this.trigger("facet:add",this)}}),e.Facet=Backbone.Model.extend({constructor:function(){Backbone.Model.prototype.constructor.apply(this,arguments)},defaults:function(){return{_type:"terms",total:0,other:0,missing:0,terms:[]}}}),e.FacetList=Backbone.Collection.extend({constructor:function(){Backbone.Collection.prototype.constructor.apply(this,arguments)},model:e.Facet}),e.ObjectState=Backbone.Model.extend({}),Backbone.sync=function(e,t,n){return t.backend.sync(e,t,n)}}(this.recline.Model),this.recline=this.recline||{},this.recline.Backend=this.recline.Backend||{},this.recline.Backend.Memory=this.recline.Backend.Memory||{},function(e){"use strict";e.__type__="memory";var t=typeof jQuery!="undefined"&&jQuery.Deferred||_.Deferred;e.Store=function(e,n){var r=this;this.records=e,this.data=this.records,n?this.fields=n:e&&(this.fields=_.map(e[0],function(e,t){return{id:t,type:"string"}})),this.update=function(e){_.each(r.records,function(t,n){e.id===t.id&&(r.records[n]=e)})},this.remove=function(e){var t=_.reject(r.records,function(t){return e.id===t.id});this.records=t},this.save=function(e,n){var r=this,i=new t;return _.each(e.updates,function(e){r.update(e)}),_.each(e.deletes,function(e){r.remove(e)}),i.resolve(),i.promise()},this.query=function(e){var n=new t,r=e.size||this.records.length,i=e.from||0,s=this.records;s=recline.Data.Filters.applyFiltersOnData(e.filters,s,this.fields),s=this._applyFreeTextQuery(s,e),_.each(e.sort,function(e){var t=e.field;s=_.sortBy(s,function(e){var n=e[t];return n}),e.order=="desc"&&s.reverse()});var o=recline.Data.Faceting.computeFacets(s,e),u={total:s.length,hits:s.slice(i,i+r),facets:o};return n.resolve(u),n.promise()},this._applyFilters=function(e,t){function u(e){var t=o[e.field].type||"string";return s[t]}function a(e,t){var n=u(t),r=n(e[t.field]),i=n(t.term);return r===i}function f(e,t){var n=t.start===null||t.start==="",r=t.stop===null||t.stop==="",i=u(t),s=i(e[t.field]),o=i(t.start),a=i(t.stop);return(!n||!r)&&s===""?!1:(n||s>=o)&&(r||s<=a)}function l(){}var n=t.filters,i={term:a,range:f,geo_distance:l},s={integer:function(e){return parseFloat(e,10)},"float":function(e){return parseFloat(e,10)},number:function(e){return parseFloat(e,10)},string:function(e){return e.toString()},date:function(e){return moment(e).valueOf()},datetime:function(e){return(new Date(e)).valueOf()}},o={};return _.each(r.fields,function(e){o[e.id]=e}),_.filter(e,function(e){var t=_.map(n,function(t){return i[t.type](e,t)});return _.all(t,_.identity)})},this._applyFreeTextQuery=function(e,t){if(t.q){var n=t.q.split(" "),i=_.map(n,function(e){return new RegExp(e.toLowerCase())});e=_.filter(e,function(e){var t=!0;return _.each(i,function(n){var i=!1;_.each(r.fields,function(t){var r=e[t.id];r!==null&&r!==undefined?r=r.toString():r="",i=i||n.test(r.toLowerCase())}),t=t&&i}),t})}return e},this.computeFacets=function(e,t){var n={};return t.facets?(_.each(t.facets,function(e,t){n[t]=(new recline.Model.Facet({id:t})).toJSON(),n[t].termsall={}}),_.each(e,function(e){_.each(t.facets,function(t,r){var i=t.terms.field,s=e[i],o=n[r];s?o.termsall[s]=o.termsall[s]?o.termsall[s]+1:1:o.missing=o.missing+1})}),_.each(t.facets,function(e,t){var r=n[t],i=_.map(r.termsall,function(e,t){return{term:t,count:e}});r.terms=_.sortBy(i,function(e){return-e.count}),r.terms=r.terms.slice(0,10)}),n):n}}}(this.recline.Backend.Memory);